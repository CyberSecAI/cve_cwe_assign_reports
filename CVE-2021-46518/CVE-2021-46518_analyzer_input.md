# Vulnerability Information: CVE-2021-46518

## Vulnerability Description
Cesanta MJS v2.20.0 was discovered to contain a **heap buffer overflow** via mjs_disown at src/mjs_core.c.

### Vulnerability Description Key Phrases
- **weakness:** **heap buffer overflow**
- **product:** Cesanta MJS
- **version:** v2.20.0
- **component:** mjs_disown at src/mjs_core.c

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause of Vulnerability:**
The root cause is a heap-buffer-overflow in the `mjs_disown` function located in `src/mjs_core.c` at line 288. This function is likely involved in memory management for the mjs (embedded JavaScript) engine. The overflow occurs during a read operation.

**Weaknesses/Vulnerabilities Present:**
- Heap-buffer-overflow: The code attempts to read beyond the allocated buffer on the heap, leading to memory corruption.
- Wild pointer: The address identified by the AddressSanitizer (`0x604000000138`) is described as a "wild pointer," indicating a potential issue with pointer handling or memory deallocation.

**Impact of Exploitation:**
- Code execution: While not explicitly mentioned, a heap-buffer-overflow can potentially lead to arbitrary code execution if an attacker can carefully control the overflow and overwrite critical memory regions.
- Application crash: The immediate effect, as demonstrated in the provided output, is an application crash, as reported by AddressSanitizer.
- Potential Denial of Service: Repeated exploitation can cause the application to crash, resulting in a denial-of-service condition.

**Attack Vectors:**
- Malicious JavaScript code: The vulnerability is triggered by a specifically crafted JavaScript code snippet, indicated by `poc.js`. This script utilizes `JSON.stringify` and seemingly mathematical operations to trigger the overflow during JSON parsing within the mjs engine.

**Required Attacker Capabilities/Position:**
- Ability to provide malicious JavaScript code: The attacker needs to be able to supply malicious JavaScript code that is processed by the mjs engine. This could be through various attack vectors depending on how the application uses mjs.

**Additional Information:**
- The vulnerability is reproducible on Ubuntu 18.04.5 LTS using the provided build steps and `poc.js` test case.
- The vulnerability was discovered by the OWL337 team.
- The provided `poc.js` code uses a series of `JSON.stringify` calls and subtractions that, when interpreted by the `mjs` engine, leads to the heap-buffer-overflow.
- The AddressSanitizer output provides detailed information, such as the faulting address, stack trace, and shadow bytes, which confirms the heap-buffer-overflow at the specific location.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-193 | Off-by-one Error | Base | Allowed | 0.6782 | dense, sparse, graph | dense: 0.549, sparse: 0.130, graph: 0.920 |
| 2 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6441 | dense, sparse, graph | dense: 0.579, sparse: 0.113, graph: 0.809 |
| 3 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.5214 | dense, sparse, graph | dense: 0.603, sparse: 0.103, graph: 0.570 |
| 4 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.4847 | dense, sparse, graph | dense: 0.548, sparse: 0.088, graph: 0.449 |
| 5 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.4805 | dense, sparse, graph | dense: 0.554, sparse: 0.087, graph: 0.429 |
| 6 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3650 | dense, sparse | dense: 0.607, sparse: 0.160 |
| 7 | CWE-170 | Improper Null Termination | Base | Allowed | 0.3390 | sparse, graph | sparse: 0.099, graph: 0.789 |
| 8 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.3309 | dense, sparse | dense: 0.537, sparse: 0.108 |
| 9 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3298 | dense, sparse | dense: 0.578, sparse: 0.119 |
| 10 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.3208 | dense, sparse | dense: 0.540, sparse: 0.089 |

