# Vulnerability Information: CVE-2022-0367

## Vulnerability Description
A **heap-based buffer overflow** flaw was found in libmodbus in function modbus_reply() in src/modbus.c.

### Vulnerability Description Key Phrases
- **weakness:** **heap-based buffer overflow**
- **product:** libmodbus
- **component:** modbus_reply() in src/modbus.c

## CVE Reference Links Content Summary
```
{
  "vulnerability_details": {
    "root_cause": "A copy-paste error in the sanity check within the `modbus_reply` function when handling `MODBUS_FC_WRITE_AND_READ_REGISTERS` requests. The code was only validating the read address offset, but not the write address offset, which could lead to out-of-bounds access.",
    "weaknesses": [
      "Heap-based buffer overflow",
      "Insufficient input validation"
    ],
    "impact": "A heap-based buffer overflow can lead to a denial-of-service (crash) or memory corruption. This could allow an attacker to potentially execute arbitrary code.",
    "attack_vectors": "The vulnerability is triggered by sending a crafted Modbus request with the function code `MODBUS_FC_WRITE_AND_READ_REGISTERS` to the server. Specifically, the crafted request will have an invalid address offset for writing, that is outside of the allowed mapping range, which is not properly validated.",
     "required_capabilities": "An attacker needs to be able to send network packets to a vulnerable Modbus server to trigger this vulnerability. This could be a network connection with direct access to the server, or another access vector such as a compromised device on the same network."
  },
  "additional_details": {
    "affected_function": "`modbus_reply` function",
    "affected_protocol": "Modbus TCP",
    "vulnerable_function_code": "MODBUS_FC_WRITE_AND_READ_REGISTERS",
    "poc_details": [
       "A base64 encoded payload `A90AAAAN/xcBYgABAIQAAQLXEQ==` was provided as a proof of concept to trigger the crash",
        "Another base64 encoded payload `/+AAHwBa/xcBYAAgAV4AAQIQNAAADf8PABAAAw==` also triggers the vulnerability"
        ],
    "fix_details": "The fix involves ensuring that both the read and write address offsets are checked against the mapping range, correcting the copy-paste error.",
     "related_issue": "This vulnerability was reported earlier in issue #499 before being reported again as issue #614"
  }
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6795 | dense, sparse, graph | dense: 0.559, sparse: 0.135, graph: 0.903 |
| 2 | CWE-193 | Off-by-one Error | Base | Allowed | 0.6750 | dense, sparse, graph | dense: 0.544, sparse: 0.129, graph: 0.921 |
| 3 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.5624 | dense, sparse, graph | dense: 0.545, sparse: 0.130, graph: 0.603 |
| 4 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.5512 | dense, sparse, graph | dense: 0.585, sparse: 0.125, graph: 0.651 |
| 5 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.5271 | dense, sparse, graph | dense: 0.536, sparse: 0.102, graph: 0.561 |
| 6 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3558 | dense, sparse | dense: 0.591, sparse: 0.157 |
| 7 | CWE-170 | Improper Null Termination | Base | Allowed | 0.3395 | sparse, graph | sparse: 0.100, graph: 0.789 |
| 8 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3314 | dense, sparse | dense: 0.581, sparse: 0.120 |
| 9 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.3229 | dense, sparse | dense: 0.514, sparse: 0.115 |
| 10 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.3172 | dense, sparse | dense: 0.513, sparse: 0.106 |

