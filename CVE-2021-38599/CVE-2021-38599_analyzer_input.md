# Vulnerability Information: CVE-2021-38599

## Vulnerability Description
WAL-G before 1.1, when a non-libsodium build (e.g., one of the official binary releases published as GitHub Releases) is used, silently ignores the libsodium encryption key and uploads cleartext backups. This is arguably a Principle of Least Surprise violation because the user likely wanted to encrypt all file activity.

### Vulnerability Description Key Phrases
- **impact:** uploads cleartext backups
- **product:** WAL-G
- **version:** before 1.1

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2021-38599:

**Root Cause of Vulnerability:**
The root cause of the vulnerability lies in the fact that the `wal-g` application, when built without libsodium support, silently ignored user-specified libsodium encryption keys and uploaded backups in plaintext. This happened because the application did not check if it was compiled with libsodium support before attempting to use libsodium encryption.

**Weaknesses/Vulnerabilities Present:**
- **Silent Failure:** The application failed silently when it was requested to encrypt data with libsodium but was not compiled with the required support. Instead of throwing an error, it continued to operate, uploading data in plaintext.
- **Principle of Least Surprise violation:** The user expected the backup files to be encrypted due to setting encryption keys, but the application silently ignored them resulting in plaintext backups, violating the principle of least surprise.
- **Lack of Input Validation:** The application did not properly validate if it had the necessary libsodium support before attempting to use libsodium encryption.

**Impact of Exploitation:**
- **Confidentiality Breach:** The primary impact was the potential for a confidentiality breach. Backups that were intended to be encrypted were instead uploaded as plaintext, making them vulnerable to unauthorized access and exposure.
- **Data Exposure:**  Users who relied on the libsodium encryption were unknowingly exposing their backup data by storing them unencrypted in storage.

**Attack Vectors:**
- **Configuration Settings:**  An attacker with access to the backup storage could read the unencrypted backups.
- **Man-in-the-Middle:** If an attacker had a man-in-the-middle position to intercept the backup transfer, they would be able to read the content.

**Required Attacker Capabilities/Position:**
- An attacker needs to have access to the storage location where the backups were stored, or the attacker needs to be in a man-in-the-middle position to intercept the backup transfer.
- No specific user interaction is required.
- No special privileges required

**Additional Details:**
- The vulnerability was present in `wal-g` versions prior to 1.1.
- The fix was implemented in version 1.1. The fix includes a check to ensure that if a libsodium key is specified, and the application is not compiled with libsodium support, the application will exit with an error message.
- The fix also enables libsodium in the GitHub release builds.
- The fix was introduced with the merge of pull request #1062.
- This issue was assigned CVE-2021-38599 and GHSA-vrmr-f2qh-3hhf.
- The issue was classified as having a High severity with a CVSS score of 7.5.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-312 | Cleartext Storage of Sensitive Information | Base | Allowed | 0.4784 | dense, sparse, graph | dense: 0.451, sparse: 0.060, graph: 0.611 |
| 2 | CWE-319 | Cleartext Transmission of Sensitive Information | Base | Allowed | 0.2386 | sparse, graph | sparse: 0.059, graph: 0.573 |
| 3 | CWE-327 | Use of a Broken or Risky Cryptographic Algorithm | Class | Allowed-with-Review | 0.1433 | dense, sparse | dense: 0.422, sparse: 0.057 |
| 4 | CWE-754 | Improper Check for Unusual or Exceptional Conditions | Class | Allowed-with-Review | 0.1424 | sparse, graph | sparse: 0.129, graph: 0.472 |
| 5 | CWE-522 | Insufficiently Protected Credentials | Class | Allowed-with-Review | 0.1233 | sparse, graph | sparse: 0.062, graph: 0.487 |
| 6 | CWE-311 | Missing Encryption of Sensitive Data | Class | Discouraged | 0.1132 | dense, sparse | dense: 0.440, sparse: 0.057 |
| 7 | CWE-276 | Incorrect Default Permissions | Base | Allowed | 0.0335 | sparse | sparse: 0.059 |
| 8 | CWE-214 | Invocation of Process Using Visible Sensitive Information | Base | Allowed | 0.0332 | sparse | sparse: 0.058 |
| 9 | CWE-321 | Use of Hard-coded Cryptographic Key | Variant | Allowed | 0.0329 | sparse | sparse: 0.062 |
| 10 | CWE-347 | Improper Verification of Cryptographic Signature | Base | Allowed | 0.0327 | sparse | sparse: 0.057 |

