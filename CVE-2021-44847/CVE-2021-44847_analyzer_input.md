# Vulnerability Information: CVE-2021-44847

## Vulnerability Description
A **stack-based buffer overflow** in handle_request function in DHT.c in toxcore 0.1.9 through 0.1.11 and 0.2.0 through 0.2.12 (caused by an **improper length calculation** during the handling of received network packets) allows remote attackers to crash the process or potentially execute arbitrary code via a network packet.

### Vulnerability Description Key Phrases
- **rootcause:** **improper length calculation**
- **weakness:** **stack-based buffer overflow**
- **impact:** crash the process and potentially execute arbitrary code
- **vector:** network packet
- **attacker:** remote attackers
- **product:** toxcore
- **version:** 0.1.9 through 0.1.11 and 0.2.0 through 0.2.12
- **component:** handle_request function in DHT.c

## CVE Reference Links Content Summary
```
{
  "vulnerability": {
    "root_cause": "The vulnerability is due to incorrect calculation of buffer size in the `CRYPTO_SIZE` macro. Due to missing parentheses, operator precedence rules caused only '1' to be subtracted instead of the intended `CRYPTO_SIZE`. This resulted in a smaller-than-required buffer being allocated on the stack.",
    "weaknesses": [
      "Stack-based buffer overflow",
        "Incorrect macro usage due to missing braces, leading to wrong operator precedence"
    ],
    "impact": "A stack-based buffer overflow could lead to arbitrary code execution, denial of service or other undefined behavior.",
    "attack_vectors": "The vulnerability is present in the DHT packet handler, specifically in the `cryptopacket_handle` function which calls `decrypt_data`, potentially triggered by a specially crafted network packet.",
    "required_capabilities": "An attacker needs to be able to send network packets to a vulnerable `c-toxcore` instance and cause the `cryptopacket_handle` function to be executed with a malicious payload."
  },
  "fixes": [
    "The fix involves adding parentheses around `CRYPTO_SIZE` within the macro to enforce the correct order of operations, preventing the incorrect subtraction, which ensures the buffer is sized appropriately to avoid overflow."
  ]
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.8144 | dense, sparse, graph | dense: 0.554, sparse: 0.434, graph: 0.807 |
| 2 | CWE-120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | 0.8061 | dense, sparse, graph | dense: 0.519, sparse: 0.452, graph: 0.912 |
| 3 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.7573 | dense, sparse, graph | dense: 0.544, sparse: 0.475, graph: 0.597 |
| 4 | CWE-193 | Off-by-one Error | Base | Allowed | 0.7354 | dense, sparse, graph | dense: 0.541, sparse: 0.435, graph: 0.603 |
| 5 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.7171 | dense, sparse, graph | dense: 0.554, sparse: 0.441, graph: 0.692 |
| 6 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.5479 | dense, sparse | dense: 0.605, sparse: 0.509 |
| 7 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.5053 | dense, sparse | dense: 0.521, sparse: 0.428 |
| 8 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.5049 | dense, sparse | dense: 0.535, sparse: 0.414 |
| 9 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.5048 | dense, sparse | dense: 0.580, sparse: 0.448 |
| 10 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.4995 | dense, sparse | dense: 0.551, sparse: 0.392 |

