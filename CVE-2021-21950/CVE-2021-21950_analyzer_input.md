# Vulnerability Information: CVE-2021-21950

## Vulnerability Description
An **out-of-bounds write** vulnerability exists in the CMD_DEVICE_GET_SERVER_LIST_REQUEST functionality of the home_security binary of Anker Eufy Homebase 2 2.1.6.9h in function recv_server_device_response_msg_process. A specially-crafted network packet can lead to code execution.

### Vulnerability Description Key Phrases
- **rootcause:** **out-of-bounds write**
- **impact:** code execution
- **vector:** specially-crafted network packet
- **product:** Anker Eufy Homebase 2
- **version:** 2.1.6.9h
- **component:** CMD_DEVICE_GET_SERVER_LIST_REQUEST functionality of the home_security binary

## CVE Reference Links Content Summary
- **Root cause of vulnerability**: The vulnerability stems from a lack of proper validation on the `nums` field within the JSON response of a `CMD_DEVICE_GET_SERVER_LIST_REQUEST`, leading to an attacker-controlled loop counter that can cause out-of-bounds writes.
- **Weaknesses/vulnerabilities present**:
  - **Out-of-bounds write:** The primary vulnerability is an out-of-bounds write due to the lack of validation on the `nums` field, which controls the number of iterations in a loop that writes to memory.
  - **Improper input validation:** The application fails to properly validate the `nums` field from the received JSON data.
  - **Use of attacker-controlled data in memory access:** The value of the loop counter `ctr`, which is derived from the attacker-controlled `nums` field, is used to calculate memory addresses for writing data, leading to the out-of-bounds write.
  - **Vulnerability in two functions:** The same flawed logic exists in `recv_server_device_response_msg_process` and `read_udp_push_config_file`, allowing the exploit from both network traffic and local configuration file.
- **Impact of exploitation**:
  - **Code execution:** The out-of-bounds write can be leveraged to overwrite arbitrary memory locations, leading to arbitrary code execution on the affected device.
- **Attack vectors**:
  - **Network packets:** By sending a crafted `CMD_DEVICE_GET_SERVER_LIST_REQUEST` UDP packet with a malicious JSON payload to the vulnerable service, an attacker can trigger the vulnerability through the `recv_server_device_response_msg_process` function.
  - **Local config file manipulation:** By writing a crafted `/mnt/zx_udp_push_config.ini` file, an attacker can exploit the `read_udp_push_config_file` function during the device's startup.
- **Required attacker capabilities/position**:
  - **Network access:** For the network-based attack, the attacker needs to be able to send UDP packets to the device.
  - **Local access (for the config file attack):** For the config file-based attack, the attacker needs to have some way of modifying the `/mnt/zx_udp_push_config.ini` file. This could involve exploiting another vulnerability to gain access to the device's filesystem.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.4923 | sparse, graph | sparse: 0.236, graph: 1.000 |
| 2 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.4816 | sparse, graph | sparse: 0.217, graph: 1.000 |
| 3 | CWE-129 | Improper Validation of Array Index | Variant | Allowed | 0.4427 | sparse, graph | sparse: 0.213, graph: 1.000 |
| 4 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.4105 | sparse, graph | sparse: 0.209, graph: 0.813 |
| 5 | CWE-824 | Access of Uninitialized Pointer | Base | Allowed | 0.3952 | sparse, graph | sparse: 0.198, graph: 0.789 |
| 6 | CWE-331 | Insufficient Entropy | Base | Allowed | 0.3913 | sparse, graph | sparse: 0.211, graph: 0.757 |
| 7 | CWE-823 | Use of Out-of-range Pointer Offset | Base | Allowed | 0.3850 | sparse, graph | sparse: 0.180, graph: 0.789 |
| 8 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.3739 | dense, sparse | dense: 0.531, sparse: 0.189 |
| 9 | CWE-908 | Use of Uninitialized Resource | Base | Allowed | 0.3711 | dense, sparse | dense: 0.532, sparse: 0.183 |
| 10 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3523 | dense, sparse | dense: 0.553, sparse: 0.183 |

