# Vulnerability Information: CVE-2021-41987

## Vulnerability Description
In the SCEP Server of RouterOS in certain Mikrotik products, an attacker can trigger a **heap-based buffer overflow** that leads to remote code execution. The attacker must know the scep_server_name value. This affects RouterOS 6.46.8, 6.47.9, and 6.47.10.

### Vulnerability Description Key Phrases
- **weakness:** **heap-based buffer overflow**
- **impact:** remote code execution
- **attacker:** attacker
- **product:** Mikrotik RouterOS
- **version:** 6.46.8, 6.47.9, and 6.47.10
- **component:** SCEP Server

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2021-41987:

**Root cause of vulnerability:**
* The vulnerability lies in the `base64Decode` function within `ScepRequest::parseRequest` in `/nova/lib/www/scep.p`.
* A miscalculation occurs during the Base64 decoding process when calculating the output buffer size. The formula `output_buffer_length = 3 * (input_buffer_length >> 2)` can result in an undersized buffer allocation. Specifically, when the input length is not a multiple of 4, the integer division (`>> 2` or `// 4`) will cause the buffer to be too small to hold the decoded data.

**Weaknesses/vulnerabilities present:**
* **Heap-based Buffer Overflow:**  The miscalculation in buffer allocation leads to a heap-based buffer overflow when the decoded data exceeds the allocated buffer's size. This allows an attacker to overwrite heap metadata, specifically chunk sizes.

**Impact of exploitation:**
* **Remote Code Execution (RCE):** By carefully crafting the Base64 encoded payload, an attacker can trigger the heap overflow, overwrite a vtable pointer, and gain control of execution flow. This enables them to execute arbitrary shellcode on the vulnerable Mikrotik router.
* **Privilege Escalation:** The provided exploit leads to the attacker being able to log into the web service as an administrator without a password.
* **Device compromise**: The shellcode used in the exploit reboots the target device after deleting the `/nova/store/user.data` file.

**Attack vectors:**
* **HTTP GET Request:** The attack is triggered by sending a specially crafted HTTP GET request to the `/scep` endpoint.
* **Specifically, the payload structure is**
   `GET /scep/{scep_server_name}?operation=PKIOperation&message={} HTTP/1.1\r\n`, with the `message` parameter containing the malicious base64 encoded data.

**Required attacker capabilities/position:**
* **Network Access:** The attacker needs network access to the vulnerable Mikrotik router, specifically its WAN interface, because the attack can be performed without authentication.
* **Knowledge of `scep_server_name`:** The attacker must know the path name `scep_server_name` to successfully exploit the vulnerability. This implies some prior information gathering or potentially social engineering.
* **Payload crafting:** The attacker needs to be able to craft the malicious Base64 encoded payload that triggers the overflow and contains the shellcode.

**Additional Notes:**
* The exploit has low stability (5-6% success rate), potentially due to ASLR and other factors. However, the watchdog process restarts the vulnerable service (`www`) after a crash, which prevents denial of service and allows for multiple attempts.
* The provided technical analysis is more detailed than the typical CVE description. It includes decompiled code snippets, exploit flow overview, and steps to trigger the exploit.
* The document mentions specific affected versions: `6.46.8`, `6.47.9`, and `6.47.10`, which could be helpful when assessing the scope of the vulnerability.
* The exploit uses heap spraying to improve success rate by creating a predictable heap layout.
* The exploit uses a ROP chain to control the execution flow to the attacker's shellcode after the heap overflow.

This analysis provides a comprehensive understanding of CVE-2021-41987 based on the provided content.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.7475 | dense, sparse, graph | dense: 0.540, sparse: 0.209, graph: 1.000 |
| 2 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.7130 | dense, sparse, graph | dense: 0.532, sparse: 0.220, graph: 0.898 |
| 3 | CWE-476 | NULL Pointer Dereference | Base | Allowed | 0.5035 | sparse, graph | sparse: 0.255, graph: 1.000 |
| 4 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.4898 | sparse, graph | sparse: 0.231, graph: 1.000 |
| 5 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.4733 | sparse, graph | sparse: 0.276, graph: 0.882 |
| 6 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.4619 | sparse, graph | sparse: 0.249, graph: 0.894 |
| 7 | CWE-193 | Off-by-one Error | Base | Allowed | 0.3960 | dense, sparse | dense: 0.530, sparse: 0.229 |
| 8 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3860 | dense, sparse | dense: 0.574, sparse: 0.229 |
| 9 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3841 | dense, sparse | dense: 0.530, sparse: 0.264 |
| 10 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.3794 | dense, sparse | dense: 0.521, sparse: 0.207 |

