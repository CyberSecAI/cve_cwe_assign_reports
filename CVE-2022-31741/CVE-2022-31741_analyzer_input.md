# Vulnerability Information: CVE-2022-31741

## Vulnerability Description
A crafted CMS message could have been processed incorrectly, leading to an **invalid memory read**, and potentially further memory corruption. This vulnerability affects Thunderbird < 91.10, Firefox < 101, and Firefox ESR < 91.10.

### Vulnerability Description Key Phrases
- **weakness:** **invalid memory read**
- **impact:** potentially further memory corruption
- **vector:** crafted CMS message
- **product:** Thunderbird and Firefox and Firefox ESR
- **version:** < 91.10 and < 101 and < 91.10

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability associated with CVE-2022-31741:

**Root Cause:**

- The vulnerability stems from an uninitialized variable (`dp`) within the `NSS_CMSDigestContext_FinishSingle` function in Mozilla's Network Security Services (NSS) library.
- The `dp` variable is intended to be initialized by a successful call to `NSS_CMSDigestContext_FinishMultiple`. However, under certain conditions (specifically when `cmsdigcx->saw_contents == 0`), `NSS_CMSDigestContext_FinishMultiple` can return success without actually initializing `dp`.

**Weaknesses/Vulnerabilities:**

- **Uninitialized Variable:** The primary weakness is the usage of an uninitialized variable. When `NSS_CMSDigestContext_FinishMultiple` doesn't initialize `dp`, subsequent code attempts to dereference `dp` leading to undefined behavior.
- **Incorrect Function Contract:** The contract of `NSS_CMSDigestContext_FinishMultiple` is flawed, as it can return `SECSuccess` without initializing its output parameter under certain conditions. This violates the expectation that the output parameter would be initialized on success.

**Impact of Exploitation:**

- **Memory Corruption:** The uninitialized `dp` variable, when dereferenced, results in either:
  - A crash due to attempting to read from an invalid memory location
  - An invalid memory read, where the program reads from a random memory location. This can lead to a potentially exploitable crash or further memory corruption if the attacker can control the uninitialized value.
- **Arbitrary Memory Read:** If the attacker can groom the stack memory, the uninitialized `dp` pointer could point to attacker controlled data, allowing the attacker to read `dp[0]->len` bytes from the `dp[0]->data` into an object.

**Attack Vectors:**

- **Crafted CMS Message:** The vulnerability is triggered by providing a specially crafted CMS message to `NSS_CMSDecoder_Update`. This function is used by applications like Thunderbird and Evolution when dealing with S/MIME encrypted emails.
- **Add-on Signature Verification:** The vulnerability can also be triggered in Firefox by parsing PKCS#7 signatures during add-on verification, as `NSS_CMSMessage_CreateFromDER` is used in that process.

**Required Attacker Capabilities/Position:**

- **Ability to send/deliver a crafted CMS message:** An attacker needs to be able to deliver a crafted CMS message to a vulnerable application such as by sending a malicious S/MIME encrypted email or by creating a malicious add-on.
- **Knowledge of Vulnerable Code Path:** The attacker needs to craft the CMS message in a way that causes the vulnerable code path to be executed, specifically where `cmsdigcx->saw_contents == 0` in `NSS_CMSDigestContext_FinishMultiple`.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.7145 | dense, sparse, graph | dense: 0.616, sparse: 0.211, graph: 0.798 |
| 2 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.6894 | dense, sparse, graph | dense: 0.527, sparse: 0.172, graph: 0.915 |
| 3 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.3585 | dense, sparse | dense: 0.551, sparse: 0.144 |
| 4 | CWE-843 | Access of Resource Using Incompatible Type ('Type Confusion') | Base | Allowed | 0.3570 | dense, sparse | dense: 0.529, sparse: 0.161 |
| 5 | CWE-416 | Use After Free | Variant | Allowed | 0.3534 | dense, sparse | dense: 0.552, sparse: 0.186 |
| 6 | CWE-457 | Use of Uninitialized Variable | Variant | Allowed | 0.3502 | sparse, graph | sparse: 0.215, graph: 0.717 |
| 7 | CWE-415 | Double Free | Variant | Allowed | 0.3262 | sparse, graph | sparse: 0.133, graph: 0.776 |
| 8 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3207 | dense, sparse | dense: 0.539, sparse: 0.136 |
| 9 | CWE-346 | Origin Validation Error | Class | Allowed-with-Review | 0.1983 | dense, sparse | dense: 0.528, sparse: 0.128 |
| 10 | CWE-116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | 0.1946 | dense, sparse | dense: 0.519, sparse: 0.125 |

