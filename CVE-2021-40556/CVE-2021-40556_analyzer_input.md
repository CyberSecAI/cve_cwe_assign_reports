# Vulnerability Information: CVE-2021-40556

## Vulnerability Description
A **stack overflow** vulnerability exists in the httpd service in ASUS RT-AX56U Router Version 3.0.0.4.386.44266. This vulnerability is caused by the **strcat function called by caupload input handle function allowing the user to enter 0xFFFF bytes into the stack**. This vulnerability allows an attacker to execute commands remotely. The vulnerability requires authentication.

### Vulnerability Description Key Phrases
- **rootcause:** **strcat function called by caupload input handle function allowing the user to enter 0xFFFF bytes into the stack**
- **weakness:** **stack overflow**
- **impact:** execute commands remotely
- **product:** ASUS RT-AX56U Router
- **version:** Version 3.0.0.4.386.44266
- **component:** httpd service

## CVE Reference Links Content Summary
The provided content discusses a stack overflow vulnerability in the ASUS RT-AX56U router's httpd service, identified as CVE-2021-40556.

**Root Cause of Vulnerability:**
The vulnerability stems from a stack buffer overflow within the `caupload.cgi` handler's input function in the httpd service. This occurs when the `strcat` function appends data from the HTTP request to a stack-allocated buffer without proper bounds checking.

**Weaknesses/Vulnerabilities:**
- Stack buffer overflow: The `strcat` function copies data of an attacker-controlled size onto a fixed-size stack buffer, leading to the overwrite of stack memory.
- Lack of input validation: The Content-Length is not properly validated against the stack buffer size.
- Missing canaries: No stack canaries are used to detect buffer overflows, which could crash the program and make exploitation harder

**Impact of Exploitation:**
- Remote Code Execution (RCE): The attacker can gain arbitrary code execution by overwriting return addresses on the stack. The article shows how to achieve RCE by redirecting execution to a gadget that calls system() and controlling the arguments.

**Attack Vectors:**
- HTTP request: The vulnerability is triggered by sending a crafted HTTP POST request to the `caupload.cgi` endpoint, specifically by manipulating the "Content-Disposition: form-data; name="file_ca"; filename=" field to send a large amount of data.

**Required Attacker Capabilities/Position:**
- Network access: The attacker needs to be able to send HTTP requests to the router's web interface. The attacker does not need to be on the same LAN, making it possible to attack it remotely if the HTTP service is exposed to the internet
- Authentication: The attacker must authenticate to the web interface before exploiting the vulnerability. The provided exploit uses the login endpoint to obtain the necessary cookie
- Understanding of HTTP protocol: The attacker needs to know the structure of HTTP requests and how to manipulate them.

**Additional Details:**
- The vulnerability is located in the `input` function of the `caupload.cgi` handler.
- The `strcat` function is used to append user-provided data to a stack buffer without proper bounds checks.
- The exploit detailed involves overwriting the return address on the stack to redirect execution to an existing code gadget within the httpd service, which calls the `doSystem` function, which is a wrapper for `system()`, allowing the attacker to execute arbitrary system commands
- The attacker crafts a special request that injects the malicious command into the cookie value, where the `doSystem` function will then execute it.
- The router's httpd service is running as a non-PIE binary, making ROP attacks more feasible
- The vulnerability affects multiple ASUS router models.
- The exploit leverages a code gadget to call the `doSystem` function with a user controlled argument taken from the cookie, and avoids dealing with \x00 bytes in the return address.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | 0.7623 | dense, sparse, graph | dense: 0.569, sparse: 0.451, graph: 0.614 |
| 2 | CWE-120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | 0.5953 | sparse, graph | sparse: 0.465, graph: 1.000 |
| 3 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.5749 | dense, sparse | dense: 0.601, sparse: 0.563 |
| 4 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.5117 | dense, sparse | dense: 0.519, sparse: 0.441 |
| 5 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.4906 | dense, sparse | dense: 0.518, sparse: 0.476 |
| 6 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.4799 | sparse, graph | sparse: 0.481, graph: 0.573 |
| 7 | CWE-457 | Use of Uninitialized Variable | Variant | Allowed | 0.4756 | sparse, graph | sparse: 0.462, graph: 0.703 |
| 8 | CWE-193 | Off-by-one Error | Base | Allowed | 0.4710 | sparse, graph | sparse: 0.429, graph: 0.631 |
| 9 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.3349 | sparse, graph | sparse: 0.270, graph: 0.583 |
| 10 | CWE-674 | Uncontrolled Recursion | Class | Allowed-with-Review | 0.3049 | dense, sparse | dense: 0.510, sparse: 0.461 |

