# Vulnerability Information: CVE-2021-38173

## Vulnerability Description
Btrbk before 0.31.2 allows command execution because of the **mishandling of remote hosts filtering SSH commands** using ssh_filter_btrbk.sh in authorized_keys.

### Vulnerability Description Key Phrases
- **rootcause:** **mishandling of remote hosts filtering SSH commands**
- **impact:** command execution
- **product:** Btrbk
- **version:** before 0.31.2
- **component:** ssh_filter_btrbk.sh in authorized_keys

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability:

**CVE ID:** CVE-2021-38173

**Root Cause of Vulnerability:**
- The vulnerability stems from a flaw in the `ssh_filter_btrbk.sh` script used by the `btrbk` backup tool. This script is intended to restrict the commands that can be executed via SSH when using `btrbk` for remote backups.
- The script's regular expression for filtering commands was flawed, allowing specially crafted commands to bypass the intended restrictions.

**Weaknesses/Vulnerabilities Present:**
- **Insufficient Input Validation:** The `ssh_filter_btrbk.sh` script failed to properly validate commands received via SSH, leading to the bypass.
- **Insecure Regular Expression:** The regular expression used to match allowed commands contained an error in its alternation logic, resulting in an exploitable flaw.

**Impact of Exploitation:**
- **Arbitrary Code Execution:** Successful exploitation of this vulnerability could allow an attacker to execute arbitrary commands on the target system where the `btrbk` is used to perform backups.

**Attack Vectors:**
- **SSH:** The attack vector involves exploiting the `ssh_filter_btrbk.sh` script when used in the `authorized_keys` file for SSH access. Specifically, the vulnerability can be triggered when a user connects via SSH and the `ssh_filter_btrbk.sh` script is used to filter commands.

**Required Attacker Capabilities/Position:**
- **Access to SSH:** The attacker needs to have the ability to connect to the target server via SSH.
- **Control over SSH Command:** The attacker needs to be able to influence the commands executed when connecting via SSH (specifically, the `SSH_ORIGINAL_COMMAND`). This is typically achieved by having control over the SSH key used for authentication if authorized_keys is used in a specific way.
- **Knowledge of the Vulnerability:** Some understanding of the `ssh_filter_btrbk.sh` script and its flaw is required to craft a successful exploit.

**Additional Details:**

- The fix involves correcting the regular expression in `ssh_filter_btrbk.sh`.
- The issue affects `btrbk` versions >= v0.23.0.
- The vulnerability was reported via responsible disclosure.

This information provides more detail than the initial CVE description, outlining the specific flaw within the script and the mechanics of the vulnerability.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | 0.5183 | dense, sparse, graph | dense: 0.484, sparse: 0.101, graph: 0.611 |
| 2 | CWE-250 | Execution with Unnecessary Privileges | Base | Allowed | 0.5056 | dense, sparse, graph | dense: 0.470, sparse: 0.091, graph: 0.610 |
| 3 | CWE-88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | 0.4682 | dense, sparse, graph | dense: 0.432, sparse: 0.099, graph: 0.546 |
| 4 | CWE-791 | Incomplete Filtering of Special Elements | Base | Allowed | 0.3755 | sparse, graph | sparse: 0.105, graph: 0.882 |
| 5 | CWE-1389 | Incorrect Parsing of Numbers with Different Radices | Base | Allowed | 0.3282 | sparse, graph | sparse: 0.101, graph: 0.757 |
| 6 | CWE-918 | Server-Side Request Forgery (SSRF) | Base | Allowed | 0.2682 | dense, sparse | dense: 0.436, sparse: 0.088 |
| 7 | CWE-185 | Incorrect Regular Expression | Class | Allowed-with-Review | 0.1873 | sparse, graph | sparse: 0.262, graph: 0.472 |
| 8 | CWE-790 | Improper Filtering of Special Elements | Class | Allowed-with-Review | 0.1648 | dense, sparse | dense: 0.442, sparse: 0.104 |
| 9 | CWE-93 | Improper Neutralization of CRLF Sequences ('CRLF Injection') | Base | Allowed | 0.0542 | sparse | sparse: 0.095 |
| 10 | CWE-1392 | Use of Default Credentials | Base | Allowed | 0.0529 | sparse | sparse: 0.093 |

