# Vulnerability Information: CVE-2022-1270

## Vulnerability Description
In GraphicsMagick, a **heap buffer overflow** was found when parsing MIFF.

### Vulnerability Description Key Phrases
- **weakness:** **heap buffer overflow**
- **product:** GraphicsMagick
- **component:** when parsing MIFF

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability:

**Root Cause:**
*   A heap buffer overflow occurs in GraphicsMagick when parsing a malformed MIFF image file. Specifically, the issue is triggered during the `fread` operation within the `ReadBlob` function, which is called by `ReadMIFFImage`, when reading image data. The overflow occurs because there are insufficient checks on the size of the input data, and a size is used that will read past the allocated buffer.

**Vulnerabilities:**
*   **Heap buffer overflow:**  The vulnerability stems from writing beyond the allocated memory buffer on the heap. The `ReadBlob` function, when handling a MIFF file, attempts to read more data into a buffer than has been allocated. This is caused when the software attempts to allocate memory for a buffer using data derived from the image header, but does not properly validate this data and may read past the end of the buffer during a subsequent `fread` operation when reading the actual image data.

**Impact:**
*   **Arbitrary Code Execution:** The primary impact is the potential for arbitrary code execution. By carefully crafting a malicious MIFF file, an attacker could overwrite memory and potentially hijack control flow, leading to the execution of arbitrary code on the victim's machine.
*   **Denial of Service:** Although not explicitly stated, a heap buffer overflow can also lead to a denial-of-service condition due to program crashes and abnormal termination.

**Attack Vectors:**
*   **Malicious MIFF file:** The attack vector involves processing a specially crafted MIFF image file. The vulnerability is triggered when the `ReadMIFFImage` function is used to process the malformed image, and the `ReadBlob` function reads more data than allocated to the buffer.

**Required Attacker Capabilities/Position:**
*   **Ability to supply a crafted MIFF file to GraphicsMagick:** An attacker would need to be able to provide a malicious MIFF file to the GraphicsMagick software for processing. This could occur through various means, such as:
    *   Embedding the malicious file in a website or email.
    *   Tricking the user into opening a file.
    *   Using it within a system that processes images automatically.

**Additional Details:**
*   The vulnerability is triggered by MIFF files, and more specifically when processing compressed data (using bzip).
*   The vulnerability is present in `GraphicsMagick 1.4 snapshot-20220322` and earlier versions.
*   The issue was fixed in Mercurial changeset 16689:94f4bcf448ad and the latest development snapshot (GraphicsMagick-1.4.020220326.tar.xz).
*   The issue was discovered using AddressSanitizer.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.6165 | dense, sparse, graph | dense: 0.474, sparse: 0.092, graph: 0.913 |
| 2 | CWE-193 | Off-by-one Error | Base | Allowed | 0.6149 | dense, sparse, graph | dense: 0.471, sparse: 0.093, graph: 0.912 |
| 3 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6101 | dense, sparse, graph | dense: 0.523, sparse: 0.107, graph: 0.803 |
| 4 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.5289 | dense, sparse, graph | dense: 0.525, sparse: 0.097, graph: 0.712 |
| 5 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3192 | dense, sparse | dense: 0.561, sparse: 0.114 |
| 6 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.2918 | dense, sparse | dense: 0.483, sparse: 0.087 |
| 7 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.2878 | dense, sparse | dense: 0.481, sparse: 0.083 |
| 8 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.2737 | dense, sparse | dense: 0.453, sparse: 0.082 |
| 9 | CWE-120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | 0.2695 | dense, sparse | dense: 0.465, sparse: 0.087 |
| 10 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.2693 | dense, sparse | dense: 0.450, sparse: 0.077 |

