# Vulnerability Information: CVE-2021-23997

## Vulnerability Description
Due to **unexpected data type conversions**, a **use-after-free** could have occurred when interacting with the font cache. We presume that with enough effort this could have been exploited to run arbitrary code. This vulnerability affects Firefox < 88.

### Vulnerability Description Key Phrases
- **rootcause:** **unexpected data type conversions**
- **weakness:** **use-after-free**
- **impact:** run arbitrary code
- **product:** Firefox
- **version:** < 88
- **component:** font cache

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability:

**Root Cause:**
The vulnerability stems from incorrect handling of font sizes after a change to use floating-point numbers for font sizes. This change, introduced by bug 1646224, caused issues when a large SVG transform matrix resulted in a NaN (Not a Number) font inflation factor. This NaN value was then used in font variation comparisons, causing fonts not to be properly removed from the font cache when they should be.

**Weaknesses/Vulnerabilities:**
- **Use-after-free (UAF):** Due to the stale entry in the font cache, a freed font object could be accessed later. Specifically, a heap-use-after-free occurs in `gfxFont.h GetUnicodeRangeMap` when the font cache attempts to compare against the stale entry.
- **Incorrect Data Type Conversions**: The move to floating point values for font sizes, combined with the way these values were used in font comparisons, led to the NaN values not being handled correctly.

**Impact of Exploitation:**
- **Memory Corruption:** The use-after-free could lead to arbitrary code execution by overwriting or reading from memory that has been freed.
- **Crash:** The immediate impact is a crash due to the memory corruption.
- **Potentially Arbitrary Code Execution:** It's presumed with enough effort the use-after-free could be exploited to run arbitrary code.

**Attack Vectors:**
- **Web Page Loading:** By loading a malicious webpage crafted with SVG elements and CSS that trigger the NaN font inflation factor.
- **User Interaction:** Additional user interaction like zooming and reloading increase the likelihood of exploitation

**Required Attacker Capabilities/Position:**
- **Ability to Serve Malicious Web Content:** The attacker needs to be able to host a crafted HTML page that can be accessed through Firefox.
- **Some User Interaction (optional):** While the initial trigger is just loading the page, additional interactions (like zooming or reloading) can make it more reliable and may be required to reach the non-UAF crashing address.

**Additional Notes**
- The vulnerability is a regression introduced by bug 1646224.
- The vulnerability is triggered in the font cache and involves the comparison of font variation values.
- The issue was fixed by normalizing font sizes and switching to bitwise equality for font variation value comparisons.
- Test cases were developed to reproduce both UAF and non-UAF crashes.
- It's noted that the freed memory can be overwritten before being reused due to the nature of how the font cache is managed.
- While the initial vulnerability was marked as `sec-moderate`, it was later raised to `sec-high` due to the possibility of overwriting the memory before reuse and potentially arbitrary code execution.
-The vulnerability is fixed in Firefox 88 and later versions.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-681 | Incorrect Conversion between Numeric Types | Base | Allowed | 0.8902 | dense, sparse, graph | dense: 0.543, sparse: 0.456, graph: 1.000 |
| 2 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.6877 | dense, sparse, graph | dense: 0.541, sparse: 0.345, graph: 0.614 |
| 3 | CWE-416 | Use After Free | Variant | Allowed | 0.6684 | dense, sparse, graph | dense: 0.577, sparse: 0.272, graph: 0.783 |
| 4 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.3784 | dense, sparse | dense: 0.502, sparse: 0.222 |
| 5 | CWE-415 | Double Free | Variant | Allowed | 0.3714 | dense, sparse | dense: 0.517, sparse: 0.251 |
| 6 | CWE-362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | 0.3692 | dense, sparse, graph | dense: 0.501, sparse: 0.269, graph: 0.627 |
| 7 | CWE-843 | Access of Resource Using Incompatible Type ('Type Confusion') | Base | Allowed | 0.3474 | dense, sparse | dense: 0.534, sparse: 0.140 |
| 8 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.3337 | dense, sparse | dense: 0.512, sparse: 0.135 |
| 9 | CWE-367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | 0.1378 | sparse | sparse: 0.241 |
| 10 | CWE-266 | Incorrect Privilege Assignment | Base | Allowed | 0.1332 | sparse | sparse: 0.233 |

