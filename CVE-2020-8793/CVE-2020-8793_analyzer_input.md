# Vulnerability Information: CVE-2020-8793

## Vulnerability Description
OpenSMTPD before 6.6.4 allows local users to read arbitrary files (e.g., on some Linux distributions) because of a combination of an untrusted search path in makemap.c and race conditions in the offline functionality in smtpd.c.

### Vulnerability Description Key Phrases
- **rootcause:** **untrusted search path in makemap.c and race conditions in offline functionality in smtpd.c**
- **impact:** read arbitrary files
- **attacker:** local users
- **product:** OpenSMTPD
- **version:** before 6.6.4

## CVE Reference Links Content Summary
```text
{
  "CVE-2020-8793": {
    "Description": "An unprivileged local attacker can read the first line of an arbitrary file (for example, root's password hash in /etc/master.passwd) or the entire contents of another user's file (if this file and /var/spool/smtpd/ are on the same filesystem).",
    "Root cause of vulnerability": "The vulnerability stems from a combination of factors: a local privilege escalation vulnerability in smtpctl, and time-of-check to time-of-use (TOCTOU) race conditions within OpenSMTPD's offline message handling. The offline directory is used to store messages that couldn't be delivered immediately. OpenSMTPD's previous mitigations against hardlink attacks were not sufficient.",
    "Weaknesses/vulnerabilities present": [
      "Local Privilege Escalation: By exploiting the way `smtpctl` handles the `-bi` command-line argument and manipulating the PATH environment variable, an attacker can execute `makemap` with the privileges of the `_smtpq` group (or root in Fedora's case).",
      "TOCTOU Race Conditions: OpenSMTPD performs checks on files in the offline directory at different points in time (offline_scan vs offline_enqueue). This allows an attacker to manipulate the files after the initial check and before they are processed.",
        "Hardlink Check Bypass: The hardlink check in `offline_enqueue` is vulnerable to a race condition, where the attacker can create a hardlink before `open()` and delete it before `fstat()`, making the check ineffective."
    ],
    "Impact of exploitation": "An unprivileged local attacker can read the first line of an arbitrary file (e.g., root's password hash) or the entire contents of another user's file. On Fedora, due to a misconfiguration, this could lead to full root privileges.",
    "Attack vectors": "Local access is required. The attacker needs to create files in the world-writable `/var/spool/smtpd/offline` directory.",
    "Required attacker capabilities/position": "The attacker must be a local, unprivileged user able to create hardlinks and files. The attacker also needs to be able to run commands and manipulate signals."
  }
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-427 | Uncontrolled Search Path Element | Base | Allowed | 0.7153 | dense, sparse, graph | dense: 0.493, sparse: 0.284, graph: 0.857 |
| 2 | CWE-426 | Untrusted Search Path | Base | Allowed | 0.6941 | dense, sparse, graph | dense: 0.511, sparse: 0.229, graph: 0.860 |
| 3 | CWE-367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | 0.6912 | dense, sparse, graph | dense: 0.486, sparse: 0.232, graph: 0.882 |
| 4 | CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | 0.6294 | dense, sparse, graph | dense: 0.518, sparse: 0.220, graph: 0.684 |
| 5 | CWE-476 | NULL Pointer Dereference | Base | Allowed | 0.4059 | sparse, graph | sparse: 0.216, graph: 0.789 |
| 6 | CWE-250 | Execution with Unnecessary Privileges | Base | Allowed | 0.4059 | dense, sparse | dense: 0.511, sparse: 0.263 |
| 7 | CWE-59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | 0.3559 | sparse, graph | sparse: 0.227, graph: 0.631 |
| 8 | CWE-362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | 0.2322 | dense, sparse | dense: 0.497, sparse: 0.257 |
| 9 | CWE-732 | Incorrect Permission Assignment for Critical Resource | Class | Allowed-with-Review | 0.2129 | dense, sparse | dense: 0.490, sparse: 0.205 |
| 10 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.1225 | sparse | sparse: 0.214 |

