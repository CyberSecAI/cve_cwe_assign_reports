# Vulnerability Information: CVE-2022-41981

## Vulnerability Description
A **stack-based buffer overflow** vulnerability exists in the TGA file format parser of OpenImageIO v2.3.19.0. A specially-crafted targa file can lead to out of bounds read and write on the process stack, which can lead to arbitrary code execution. An attacker can provide a malicious file to trigger this vulnerability.

### Vulnerability Description Key Phrases
- **rootcause:** **stack-based buffer overflow**
- **impact:** arbitrary code execution
- **vector:** specially-crafted targa file
- **attacker:** attacker
- **product:** OpenImageIO
- **version:** v2.3.19.0
- **component:** TGA file format parser

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**CVE ID:** CVE-2022-41981

**Description:** A stack-based buffer overflow vulnerability exists in the TGA file format parser of OpenImageIO v2.3.19.0.

**Root Cause:** The vulnerability stems from a lack of null termination when reading comment data from a TGA file's extension area into a stack-based buffer (`buf`). Subsequently, the code uses `strlen` on this potentially non-null-terminated buffer, which can lead to out-of-bounds reads. Further, the code uses `sprintf` at `buf[strlen(buf)]` which can cause out-of-bounds write.

**Vulnerabilities/Weaknesses:**
* **Stack-based buffer overflow:**  The primary vulnerability is a classic stack buffer overflow. By crafting a TGA file with an extension area that exceeds the bounds of the `buf` buffer, an attacker can cause a buffer overflow.
* **Missing Null Termination:** The core issue lies in the fact that the data read into the buffer `buf` is not null-terminated.
* **Uncontrolled `strlen` and `sprintf`:** Using `strlen` and `sprintf` on non-null-terminated data leads to out-of-bounds memory access.

**Impact:**
* **Arbitrary Code Execution:**  The vulnerability can lead to arbitrary code execution. While the current `master` branch only contains an out-of-bounds read, the vulnerable code allows for an out-of-bounds write with older versions. This means a malicious TGA file can be used to overwrite arbitrary data on the stack, which could be leveraged for code execution.
* **Crash:** The provided crash information shows a stack-based buffer overflow leading to a program crash due to out of bounds reads.

**Attack Vectors:**
* **Malicious TGA File:** The primary attack vector is providing a specially crafted TGA file to an application using OpenImageIO that uses TGA files.
* **File Parsing:** The vulnerability is triggered when the application attempts to parse the malicious TGA file with the vulnerable version of OpenImageIO, specifically during processing of TGA 2.0 extension data.

**Required Attacker Capabilities/Position:**
* **Ability to provide input:** An attacker needs to be able to provide a specially crafted TGA file to an application using the vulnerable library.
* **No authentication:** The vulnerability does not require any prior authentication.

**Technical Details:**

* The vulnerability occurs in `TGAInput::open()` function when reading a TGA 2.0 file.
* Specifically, after reading the extension area size, the code reads up to 324 bytes into a stack-based union `buf`.
* The code reads image comments at line 320.
* After reading the comments, it attempts to concatenate the lines into a single string which reads out of bounds if there are no null bytes in the `buf`.
* Later, the code reads in 41 new bytes and then formulates a `Software` attribute at the `sprintf` which can out of bounds write to other variables on the stack because of a non null terminated `buf`.
* The crash information confirms the stack buffer overflow at the location of `strlen`, when called on a non-null-terminated buffer.
* The vulnerability is triggered by the presence of a TGA 2.0 signature, a valid extension area size greater than or equal to 495 and non-null bytes within the comment section.
* The vulnerability is present in OpenImageIO v2.3.19.0.

**Additional Notes:**
* The report mentions that the vulnerability is an out-of-bounds read in the current `master` branch, but an out-of-bounds write in older versions because `sprintf(buf[strlen(buf)])` is not used.
* The vulnerability is fixed in a patch released by the vendor on 2022-11-01.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.7963 | dense, sparse, graph | dense: 0.520, sparse: 0.366, graph: 0.915 |
| 2 | CWE-193 | Off-by-one Error | Base | Allowed | 0.7800 | dense, sparse, graph | dense: 0.492, sparse: 0.364, graph: 0.911 |
| 3 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.7463 | dense, sparse, graph | dense: 0.563, sparse: 0.346, graph: 0.745 |
| 4 | CWE-129 | Improper Validation of Array Index | Variant | Allowed | 0.6413 | dense, sparse, graph | dense: 0.530, sparse: 0.321, graph: 0.689 |
| 5 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.6327 | dense, sparse, graph | dense: 0.528, sparse: 0.293, graph: 0.709 |
| 6 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.6275 | dense, sparse, graph | dense: 0.497, sparse: 0.309, graph: 0.564 |
| 7 | CWE-170 | Improper Null Termination | Base | Allowed | 0.4484 | sparse, graph | sparse: 0.291, graph: 0.789 |
| 8 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.4461 | dense, sparse | dense: 0.559, sparse: 0.356 |
| 9 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.4350 | dense, sparse | dense: 0.562, sparse: 0.332 |
| 10 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.4311 | dense, sparse | dense: 0.504, sparse: 0.313 |

