# Vulnerability Information: CVE-2022-20422

## Vulnerability Description
In emulation_proc_handler of armv8_deprecated.c, there is a possible way to corrupt memory due to a **race condition**. This could lead to local escalation of privilege with no additional execution privileges needed. User interaction is not needed for exploitation.Product AndroidVersions Android kernelAndroid ID A-237540956References Upstream kernel

### Vulnerability Description Key Phrases
- **rootcause:** **race condition**
- **impact:** memory corruption
- **product:** Android kernel
- **component:** emulation_proc_handler of armv8_deprecated.c

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of CVE-2022-20422:

**Root Cause of Vulnerability:**

- The vulnerability is a race condition in the instruction emulator for 64-bit Arm systems.
- Concurrent changes to the sysctls (system control variables) that control the emulator can lead to a null pointer dereference.

**Weaknesses/Vulnerabilities Present:**

- **Race Condition:** The primary weakness is the lack of proper synchronization when modifying sysctls related to the ARMv8 emulator, allowing concurrent access.
- **Null Pointer Dereference:** The race condition leads to a state where the kernel attempts to dereference a null pointer, causing a crash. Specifically, the `table->data` pointer is modified concurrently, leading to use of an invalid pointer.

**Impact of Exploitation:**

- **Denial of Service (DoS):** The immediate impact is a kernel crash due to the null pointer dereference, resulting in a denial of service.
- **Unclear Security Impact:** The Debian security advisory mentions the security impact is unclear, as it only leads to a kernel crash. However, the potential for further exploitation is present if the crash occurs in a vulnerable area.

**Attack Vectors:**

- **Local Access:** The vulnerability can be triggered by a local attacker who can make concurrent changes to the sysctls controlling the emulator.
- **Sysctl Modification:** The attacker must be able to modify the sysctl values related to the instruction emulator.

**Required Attacker Capabilities/Position:**

- **Local User Access:** An attacker needs to have local user access to the system to modify the necessary sysctl variables.
- **Concurrency:** The attacker needs the ability to execute operations that change the sysctl values concurrently to trigger the race condition.

**Additional Notes:**
- The fix involves using `container_of()` to retrieve the `insn` pointer and adding a mutex to protect against the `current_mode` update, but not for retrieving `insn_emulation` because `table->data` is no longer changing.
- The fix was backported from a kernel patch.
- The Debian advisory mentions that the vulnerability is located in the "instruction emulator for 64-bit Arm systems", which aligns with the AOSP commit message mentioning "arm64: fix oops in concurrently setting insn_emulation sysctl".

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-413 | Improper Resource Locking | Base | Allowed | 0.7560 | dense, sparse, graph | dense: 0.591, sparse: 0.416, graph: 0.622 |
| 2 | CWE-908 | Use of Uninitialized Resource | Base | Allowed | 0.6843 | dense, sparse, graph | dense: 0.543, sparse: 0.283, graph: 0.700 |
| 3 | CWE-366 | Race Condition within a Thread | Base | Allowed | 0.4559 | dense, sparse | dense: 0.575, sparse: 0.294 |
| 4 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.4157 | dense, sparse | dense: 0.536, sparse: 0.258 |
| 5 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.4081 | sparse, graph | sparse: 0.262, graph: 0.722 |
| 6 | CWE-362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | 0.2876 | dense, sparse | dense: 0.583, sparse: 0.346 |
| 7 | CWE-667 | Improper Locking | Class | Allowed-with-Review | 0.2865 | dense, sparse | dense: 0.574, sparse: 0.350 |
| 8 | CWE-909 | Missing Initialization of Resource | Class | Allowed-with-Review | 0.2619 | dense, sparse | dense: 0.591, sparse: 0.262 |
| 9 | CWE-1021 | Improper Restriction of Rendered UI Layers or Frames | Base | Allowed | 0.1700 | sparse | sparse: 0.297 |
| 10 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.1571 | sparse | sparse: 0.275 |

