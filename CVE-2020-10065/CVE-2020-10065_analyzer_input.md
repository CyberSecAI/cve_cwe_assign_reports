# Vulnerability Information: CVE-2020-10065

## Vulnerability Description
Missing Size Checks in Bluetooth HCI over SPI. Zephyr versions >= v1.14.2, >= v2.2.0 contain **Improper Handling of Length Parameter Inconsistency** (CWE-130). For more information, see https//github.com/zephyrproject-rtos/zephyr/security/advisories/GHSA-hg2w-62p6-g67c

### Vulnerability Description Key Phrases
- **rootcause:** **Improper Handling of Length Parameter Inconsistency**
- **product:** Zephyr
- **version:** versions >= v1.14.2, >= v2.2.0
- **component:** Bluetooth HCI over SPI

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability described:

**Root Cause:**

- The vulnerability lies in the `bt_spi_rx_thread` function within the Bluetooth HCI over SPI driver (`drivers/bluetooth/hci/spi.c`).
- The code directly copies a size value from the ACL header of an incoming SPI message without proper validation. This size value is then used to copy data into a fixed-size buffer, leading to an out-of-bounds write if the attacker provides a large size value in the ACL header.

**Weaknesses/Vulnerabilities:**

- **Lack of input validation:** The code fails to validate the length field (`acl_hdr.len`) read from the received data. It is treated as trusted data without any checks.
- **Out-of-bounds write:** The size read from the header is used to write data to a fixed-size buffer (defaulting to 77 bytes). If the length is greater than the buffer's capacity, a write outside of the buffer occurs, causing a buffer overflow.

**Impact of Exploitation:**

- **Denial of Service (DoS):** A large specified size could cause a crash, resulting in denial of service.
- **Remote Code Execution (RCE):** The out-of-bounds write can be potentially exploited to achieve arbitrary code execution. By carefully crafting the data to be copied, an attacker may overwrite critical parts of memory.

**Attack Vectors:**

- **Physical Access via SPI:** The attack vector is physical access to the SPI interface connected to the vulnerable device. The attacker needs to be able to send a crafted Bluetooth HCI message over SPI.

**Required Attacker Capabilities/Position:**

- **Physical access to the SPI bus.** The attacker must have the ability to send SPI messages to the vulnerable device.
- **Ability to control the data sent:** The attacker must be able to craft a HCI_ACL message and manipulate the `len` field in the `acl_hdr`.

**Additional Notes:**

- The vulnerability is present in Zephyr versions v1.14.2, and v2.2.0-v2.7.0 and is fixed in version v3.0.0.
- The vulnerability has a low CVSS severity score of 3.8, primarily due to the physical attack vector.
- The vulnerability is related to CWE-130: Improper Handling of Length Parameter Inconsistency.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.8754 | dense, sparse, graph | dense: 0.608, sparse: 0.374, graph: 1.000 |
| 2 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.5685 | dense, sparse, graph | dense: 0.518, sparse: 0.210, graph: 0.530 |
| 3 | CWE-694 | Use of Multiple Resources with Duplicate Identifier | Base | Allowed | 0.5338 | dense, sparse, graph | dense: 0.471, sparse: 0.193, graph: 0.525 |
| 4 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.3493 | dense, sparse | dense: 0.478, sparse: 0.193 |
| 5 | CWE-588 | Attempt to Access Child of a Non-structure Pointer | Variant | Allowed | 0.3253 | dense, sparse | dense: 0.473, sparse: 0.202 |
| 6 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.2930 | dense, sparse | dense: 0.486, sparse: 0.130 |
| 7 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.1878 | sparse, graph | sparse: 0.119, graph: 0.334 |
| 8 | CWE-193 | Off-by-one Error | Base | Allowed | 0.1873 | sparse, graph | sparse: 0.118, graph: 0.334 |
| 9 | CWE-476 | NULL Pointer Dereference | Base | Allowed | 0.0868 | sparse | sparse: 0.152 |
| 10 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.0853 | sparse | sparse: 0.162 |

