# Vulnerability Information: CVE-2021-20195

## Vulnerability Description
A flaw was found in keycloak in versions before 13.0.0. A Self Stored XSS attack vector escalating to a complete account takeover is possible due to **user-supplied data fields not being properly encoded** and Javascript code being used to process the data. The highest threat from this vulnerability is to data confidentiality and integrity as well as system availability.

### Vulnerability Description Key Phrases
- **rootcause:** **user-supplied data fields not being properly encoded**
- **weakness:** **cross-site scripting**
- **impact:** account takeover
- **product:** keycloak
- **version:** before 13.0.0

## CVE Reference Links Content Summary
Based on the provided content, here's the breakdown of the vulnerability:

**Root Cause:**

*   The Keycloak Account console does not properly HTML-encode user-supplied data, specifically the first and last name fields. This allows an attacker to inject malicious HTML and JavaScript code into these fields.

**Weaknesses/Vulnerabilities:**

*   **Stored Self-XSS (Cross-Site Scripting):** Malicious JavaScript code is stored within the user's profile data.
*   **Lack of Input Sanitization/Encoding:** The application fails to sanitize or encode user-supplied input before displaying it, which is a fundamental flaw in web application security.

**Impact of Exploitation:**

*   **Account Takeover:** Although the XSS is initially "self-XSS" (affecting the user who injects the code), it can be escalated to a complete account takeover. This is achieved by exploiting the impersonation functionality. When an administrator impersonates the attacker’s account, the malicious JavaScript will be executed within the administrator's browser session, allowing the attacker to compromise the administrator's access.
*   **Data Confidentiality and Integrity:** The attacker could potentially steal sensitive data or modify data within the application if admin access is gained.
*  **System Availability:** By compromising administrative access, an attacker may be able to disrupt normal system operation.

**Attack Vectors:**

*   **User Input Fields:** The attacker injects the malicious code into the first and last name fields of their user profile through the Keycloak Account console.
*   **Impersonation Feature:** An administrator impersonates the malicious user through the Keycloak admin interface. This action triggers the malicious code within the admin's session due to the stored XSS.

**Required Attacker Capabilities/Position:**

*   **Valid User Account:** The attacker needs a valid user account on the Keycloak instance to modify their profile.
*   **Knowledge of Impersonation Feature:** The attacker needs to be aware of the Keycloak admin’s ability to impersonate users.
*   **Social Engineering (Optional):** Although not strictly required, an attacker might try to entice an administrator to impersonate their account through social engineering tactics.

**Additional Details:**

*   The vulnerability was fixed in Keycloak version 13.0.0
*   Recommendations include:
    *   HTML encoding user-supplied data to prevent script execution.
    *   Implementing Content Security Policy (CSP) as a browser protection mechanism.
    *   Using subdomain separation for realms to enhance Same Origin Policy (SOP) protections.
*   The bug report was closed on 2021-02-16

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | 0.8823 | dense, sparse, graph | dense: 0.585, sparse: 0.489, graph: 0.866 |
| 2 | CWE-352 | Cross-Site Request Forgery (CSRF) | Compound | Allowed | 0.6834 | dense, sparse, graph | dense: 0.565, sparse: 0.472, graph: 0.940 |
| 3 | CWE-444 | Inconsistent Interpretation of HTTP Requests ('HTTP Request/Response Smuggling') | Base | Allowed | 0.5251 | sparse, graph | sparse: 0.445, graph: 0.757 |
| 4 | CWE-1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | 0.4273 | dense, sparse | dense: 0.559, sparse: 0.258 |
| 5 | CWE-116 | Improper Encoding or Escaping of Output | Class | Allowed-with-Review | 0.3637 | dense, sparse | dense: 0.570, sparse: 0.583 |
| 6 | CWE-863 | Incorrect Authorization | Class | Allowed-with-Review | 0.2558 | sparse, graph | sparse: 0.447, graph: 0.503 |
| 7 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.2485 | sparse | sparse: 0.434 |
| 8 | CWE-201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | 0.2411 | sparse | sparse: 0.422 |
| 9 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.2383 | sparse | sparse: 0.417 |
| 10 | CWE-94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | 0.2281 | sparse | sparse: 0.418 |

