# Vulnerability Information: CVE-2021-3861

## Vulnerability Description
The RNDIS USB device class includes a **buffer overflow** vulnerability. Zephyr versions >= v2.6.0 contain Heap-based Buffer Overflow (CWE-122). For more information, see https//github.com/zephyrproject-rtos/zephyr/security/advisories/GHSA-hvfp-w4h8-gxvj

### Vulnerability Description Key Phrases
- **weakness:** **buffer overflow**
- **impact:** Heap-based Buffer Overflow
- **product:** Zephyr
- **version:** >= v2.6.0
- **component:** RNDIS USB device class

## CVE Reference Links Content Summary
- **Root cause of vulnerability**: A buffer overflow occurs in the `queue_encapsulated_cmd` function within the RNDIS USB device class implementation. The function copies user-provided data from a control transfer request into a fixed-size RNDIS command buffer using `memcpy`. However, the size of the provided data, indicated by `len`, is not checked against the buffer's capacity, leading to a buffer overflow if the data exceeds the buffer's size. The `net_buf_simple_add` function only increments the buffer's length and does not check for overflow.

- **Weaknesses/vulnerabilities present**: The primary weakness is the lack of bounds checking in the `memcpy` operation within `queue_encapsulated_cmd`, which allows for a buffer overflow. The code uses `net_buf_add` which in turn uses `net_buf_simple_add`. `net_buf_simple_add` only increments the buffer length but does not check whether the buffer has sufficient space.

- **Impact of exploitation**: Successful exploitation could lead to corruption of critical data structures and potential execution of arbitrary code. This is because the overflow allows overwriting memory beyond the allocated RNDIS command buffer. Depending on the memory layout, this could overwrite sensitive data or alter control flow.

- **Attack vectors**: The vulnerability is triggered via a USB control transfer to the device. Specifically, a "write to device" control transfer with the command `CDC_SEND_ENC_CMD` is required to reach the vulnerable code.

- **Required attacker capabilities/position**: An attacker needs to be in an adjacent position to the vulnerable device since the attack vector is adjacent.  No privileges or user interaction is required. They need to be able to send a specifically crafted USB control transfer request with a payload that exceeds the RNDIS buffer size. The attacker does not require any prior authentication or user interaction with the device.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.7641 | dense, sparse, graph | dense: 0.556, sparse: 0.224, graph: 1.000 |
| 2 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.6530 | dense, sparse, graph | dense: 0.611, sparse: 0.237, graph: 0.591 |
| 3 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.5742 | dense, sparse, graph | dense: 0.524, sparse: 0.184, graph: 0.578 |
| 4 | CWE-476 | NULL Pointer Dereference | Base | Allowed | 0.5120 | dense, sparse, graph | dense: 0.522, sparse: 0.151, graph: 0.459 |
| 5 | CWE-193 | Off-by-one Error | Base | Allowed | 0.5079 | dense, sparse, graph | dense: 0.520, sparse: 0.147, graph: 0.458 |
| 6 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.4777 | dense, sparse, graph | dense: 0.578, sparse: 0.149, graph: 0.399 |
| 7 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3819 | dense, sparse | dense: 0.588, sparse: 0.208 |
| 8 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.3661 | dense, sparse | dense: 0.562, sparse: 0.149 |
| 9 | CWE-170 | Improper Null Termination | Base | Allowed | 0.3514 | sparse, graph | sparse: 0.121, graph: 0.789 |
| 10 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.3440 | dense, sparse | dense: 0.546, sparse: 0.123 |

