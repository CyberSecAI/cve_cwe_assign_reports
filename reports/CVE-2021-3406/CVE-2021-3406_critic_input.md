# Critic Input for CVE-2021-3406



# Original Analyzer Input
## Vulnerability Description
A flaw was found in keylime 5.8.1 and older. The issue in the Keylime agent and registrar code invalidates the cryptographic chain of trust from the Endorsement Key certificate to agent attestations.

### Vulnerability Description Key Phrases
- **rootcause:** **invalid cryptographic chain of trust**
- **product:** keylime
- **version:** 5.8.1 and older
- **component:** Keylime agent and registrar code

## CVE Reference Links Content Summary
```json
{
  "CVE-2021-3406": {
    "Description": "A flaw was found in keylime 5.8.1 and older. The issue in the Keylime agent and registrar code invalidates the cryptographic chain of trust from the Endorsement Key certificate to agent attestations.",
    "Root cause": "The Keylime agent and registrar code did not properly validate the cryptographic chain of trust.",
    "Vulnerabilities": [
      "The 'ek_tpm' used for encryption was not verified against the public key in 'ek' or 'ekcert'.",
      "No checks were performed between 'pub_aik' and 'aik_name'.",
        "No checks on the object attributes of the Attestation Key were performed."
    ],
    "Impact": "An attacker could bypass the cryptographic chain of trust by providing a generated key as 'ek_tpm', a random key as 'pub_aik', and using the 'aik_name' of a trusted TPM object.",
    "Attack vectors": [
      "Manipulating the 'ek_tpm' value.",
      "Providing a generated key as 'pub_aik'.",
      "Using the 'aik_name' of a key on a trusted TPM without proper verification."
      ],
    "Required attacker capabilities": "Ability to generate keys in system memory (unprotected),  and knowledge of how to craft messages that bypass the verification checks."
  }
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-296 | Improper Following of a Certificate's Chain of Trust | Base | Allowed | 0.7060 | dense, sparse, graph | dense: 0.563, sparse: 0.356, graph: 0.616 |
| 2 | CWE-295 | Improper Certificate Validation | Base | Allowed | 0.5813 | dense, sparse, graph | dense: 0.484, sparse: 0.211, graph: 0.611 |
| 3 | CWE-325 | Missing Cryptographic Step | Base | Allowed | 0.5682 | dense, sparse, graph | dense: 0.511, sparse: 0.173, graph: 0.598 |
| 4 | CWE-347 | Improper Verification of Cryptographic Signature | Base | Allowed | 0.5467 | dense, sparse, graph | dense: 0.481, sparse: 0.173, graph: 0.579 |
| 5 | CWE-321 | Use of Hard-coded Cryptographic Key | Variant | Allowed | 0.3074 | dense, sparse | dense: 0.463, sparse: 0.178 |
| 6 | CWE-327 | Use of a Broken or Risky Cryptographic Algorithm | Class | Allowed-with-Review | 0.1883 | dense, sparse | dense: 0.458, sparse: 0.159 |
| 7 | CWE-392 | Missing Report of Error Condition | Base | Allowed | 0.0924 | sparse | sparse: 0.162 |
| 8 | CWE-276 | Incorrect Default Permissions | Base | Allowed | 0.0917 | sparse | sparse: 0.160 |
| 9 | CWE-331 | Insufficient Entropy | Base | Allowed | 0.0916 | sparse | sparse: 0.160 |
| 10 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.0903 | sparse | sparse: 0.158 |



# Analysis to Review
# Summary
| CWE ID | CWE Name | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |
|---|---|---|---|---|---|
| CWE-296 | Improper Following of a Certificate's Chain of Trust | 0.9 | Base | Allowed | Primary CWE. |
| CWE-295 | Improper Certificate Validation | 0.7 | Base | Allowed | Secondary Candidate. |
| CWE-347 | Improper Verification of Cryptographic Signature | 0.6 | Base | Allowed | Secondary Candidate. |

## Evidence and Confidence

*   **Confidence Score:** 0.8
*   **Evidence Strength:** HIGH

- **Analysis and Justification:**  
  - *Explanation:* The vulnerability description explicitly states that the issue is an **invalid cryptographic chain of trust** in the Keylime agent and registrar code. The CVE Reference Links Content Summary further confirms this, indicating that the "Keylime agent and registrar code did not properly validate the cryptographic chain of trust." This aligns directly with CWE-296 (Improper Following of a Certificate's Chain of Trust), which describes a product's failure to properly follow the chain of trust for a certificate. Specifically, the CVE summary states that the 'ek_tpm' used for encryption was not verified against the public key in 'ek' or 'ekcert', further supporting the improper chain of trust. CWE-296 is a Base level CWE, which is preferred for mapping root causes. The MITRE mapping guidance lists the Usage as ALLOWED for CWE-296.
  
  - *Relationship Analysis:* While CWE-295 (Improper Certificate Validation) and CWE-347 (Improper Verification of Cryptographic Signature) are also potential candidates, CWE-296 is more specific to the described vulnerability because it focuses on the chain of trust aspect, which is central to the vulnerability description. There aren't direct relationships to explore with CWE-296, but its focus on the chain makes it the most relevant.

- **Confidence Score:**  
  - Confidence: 0.9 (High confidence due to explicit mention of "cryptographic chain of trust" in both the vulnerability description and the CVE reference details.)

---
- **Analysis and Justification:**  
  - *Explanation:* CWE-295 (Improper Certificate Validation) is a relevant secondary candidate because the **invalid cryptographic chain of trust** implies that certificates were not properly validated. The vulnerability description and CVE summary imply that the certificate validation process failed, making CWE-295 applicable. CWE-295 is a Base level CWE, and the MITRE mapping guidance lists the Usage as ALLOWED.
  
  - *Relationship Analysis:* There aren't any relationships provided for CWE-295.

- **Confidence Score:**  
  - Confidence: 0.7 (Moderate confidence as it is a consequence of the primary weakness.)

---
- **Analysis and Justification:**  
  - *Explanation:* CWE-347 (Improper Verification of Cryptographic Signature) is another secondary candidate. The validation of the cryptographic chain involves verifying cryptographic signatures. The CVE summary mentions a lack of checks on object attributes of the attestation key. If these signatures are not properly verified, the chain of trust can be compromised. CWE-347 is a Base level CWE, and the MITRE mapping guidance lists the Usage as ALLOWED.
  
  - *Relationship Analysis:* No direct relationships found.

- **Confidence Score:**  
  - Confidence: 0.6 (Moderate confidence as it is a possible contributing factor but not as directly stated as CWE-296.)

# CWE Examples from Database


## Known Examples for CWE-296: Improper Following of a Certificate's Chain of Trust
### Observed Examples
- **CVE-2016-2402** [https://www.cve.org/CVERecord?id=CVE-2016-2402](https://www.cve.org/CVERecord?id=CVE-2016-2402): Server allows bypass of certificate pinning by sending a chain of trust that includes a trusted CA that is not pinned.
- **CVE-2008-4989** [https://www.cve.org/CVERecord?id=CVE-2008-4989](https://www.cve.org/CVERecord?id=CVE-2008-4989): Verification function trusts certificate chains in which the last certificate is self-signed.
- **CVE-2012-5821** [https://www.cve.org/CVERecord?id=CVE-2012-5821](https://www.cve.org/CVERecord?id=CVE-2012-5821): Chain: Web browser uses a TLS-related function incorrectly, preventing it from verifying that a server's certificate is signed by a trusted certification authority (CA).
- **CVE-2009-3046** [https://www.cve.org/CVERecord?id=CVE-2009-3046](https://www.cve.org/CVERecord?id=CVE-2009-3046): Web browser does not check if any intermediate certificates are revoked.
- **CVE-2009-0265** [https://www.cve.org/CVERecord?id=CVE-2009-0265](https://www.cve.org/CVERecord?id=CVE-2009-0265): chain: DNS server does not correctly check return value from the OpenSSL EVP_VerifyFinal function allows bypass of validation of the certificate chain.
- **CVE-2009-0124** [https://www.cve.org/CVERecord?id=CVE-2009-0124](https://www.cve.org/CVERecord?id=CVE-2009-0124): chain: incorrect check of return value from the OpenSSL EVP_VerifyFinal function allows bypass of validation of the certificate chain.
- **CVE-2002-0970** [https://www.cve.org/CVERecord?id=CVE-2002-0970](https://www.cve.org/CVERecord?id=CVE-2002-0970): File-transfer software does not validate Basic Constraints of an intermediate CA-signed certificate.
- **CVE-2002-0862** [https://www.cve.org/CVERecord?id=CVE-2002-0862](https://www.cve.org/CVERecord?id=CVE-2002-0862): Cryptographic API, as used in web browsers, mail clients, and other software, does not properly validate Basic Constraints.
### Top 25 Examples
- **CVE-2021-3406**: A flaw was found in keylime 5.8.1 and older. The issue in the Keylime agent and registrar code invalidates the cryptographic chain of trust from the Endorsement Key certificate to agent attestations.
- **CVE-2021-20695**: Improper following of a certificate's chain of trust vulnerability in DAP-1880AC firmware version 1.21 and earlier allows a remote authenticated attacker to gain root privileges via unspecified vectors.


# Relevant CWE Specifications

## CWE-296: Improper Following of a Certificate's Chain of Trust
**Abstraction:** Base
**Status:** Draft

### Description
The product does not follow, or incorrectly follows, the chain of trust for a certificate back to a trusted root certificate, resulting in incorrect trust of any resource that is associated with that certificate.

### Extended Description


If a system does not follow the chain of trust of a certificate to a root server, the certificate loses all usefulness as a metric of trust. Essentially, the trust gained from a certificate is derived from a chain of trust -- with a reputable trusted entity at the end of that list. The end user must trust that reputable source, and this reputable source must vouch for the resource in question through the medium of the certificate.


In some cases, this trust traverses several entities who vouch for one another. The entity trusted by the end user is at one end of this trust chain, while the certificate-wielding resource is at the other end of the chain. If the user receives a certificate at the end of one of these trust chains and then proceeds to check only that the first link in the chain, no real trust has been derived, since the entire chain must be traversed back to a trusted source to verify the certificate.


There are several ways in which the chain of trust might be broken, including but not limited to:


  - Any certificate in the chain is self-signed, unless it the root.

  - Not every intermediate certificate is checked, starting from the original certificate all the way up to the root certificate.

  - An intermediate, CA-signed certificate does not have the expected Basic Constraints or other important extensions.

  - The root certificate has been compromised or authorized to the wrong party.



### Alternative Terms
None

### Relationships
ChildOf -> CWE-295
ChildOf -> CWE-573

### Mapping Guidance
**Usage:** Allowed
**Rationale:** This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.
**Comments:** Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.
**Reasons:**
- Acceptable-Use


### Potential Mitigations
**Mitigation 1:**
- **Phase:** Architecture and Design
- **Description:** Ensure that proper certificate checking is included in the system design.

**Mitigation 2:**
- **Phase:** Implementation
- **Description:** Understand, and properly implement all checks necessary to ensure the integrity of certificate trust integrity.

**Mitigation 3:**
- **Phase:** Implementation
- **Description:** If certificate pinning is being used, ensure that all relevant properties of the certificate are fully validated before the certificate is pinned, including the full chain of trust.




### Observed Examples
- **CVE-2016-2402:** Server allows bypass of certificate pinning by sending a chain of trust that includes a trusted CA that is not pinned.
- **CVE-2008-4989:** Verification function trusts certificate chains in which the last certificate is self-signed.
- **CVE-2012-5821:** Chain: Web browser uses a TLS-related function incorrectly, preventing it from verifying that a server's certificate is signed by a trusted certification authority (CA).



## CWE-347: Improper Verification of Cryptographic Signature
**Abstraction:** Base
**Status:** Draft

### Description
The product does not verify, or incorrectly verifies, the cryptographic signature for data.

### Extended Description
Not provided

### Alternative Terms
None

### Relationships
ChildOf -> CWE-345
ChildOf -> CWE-345

### Mapping Guidance
**Usage:** Allowed
**Rationale:** This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.
**Comments:** Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.
**Reasons:**
- Acceptable-Use




### Observed Examples
- **CVE-2002-1796:** Does not properly verify signatures for "trusted" entities.
- **CVE-2005-2181:** Insufficient verification allows spoofing.
- **CVE-2005-2182:** Insufficient verification allows spoofing.



## CWE-295: Improper Certificate Validation
**Abstraction:** Base
**Status:** Draft

### Description
The product does not validate, or incorrectly validates, a certificate.

### Extended Description
When a certificate is invalid or malicious, it might allow an attacker to spoof a trusted entity by interfering in the communication path between the host and client. The product might connect to a malicious host while believing it is a trusted host, or the product might be deceived into accepting spoofed data that appears to originate from a trusted host.

### Alternative Terms
None

### Relationships
ChildOf -> CWE-287
ChildOf -> CWE-287
PeerOf -> CWE-322
ParentOf -> CWE-296
ParentOf -> CWE-297
ParentOf -> CWE-298
ParentOf -> CWE-299
ParentOf -> CWE-599

### Mapping Guidance
**Usage:** Allowed
**Rationale:** This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.
**Comments:** Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.
**Reasons:**
- Acceptable-Use


### Potential Mitigations
**Mitigation 1:**
- **Phase:** Architecture and Design, Implementation
- **Description:** Certificates should be carefully managed and checked to assure that data are encrypted with the intended owner's public key.

**Mitigation 2:**
- **Phase:** Implementation
- **Description:** If certificate pinning is being used, ensure that all relevant properties of the certificate are fully validated before the certificate is pinned, including the hostname.




### Observed Examples
- **CVE-2019-12496:** A Go framework for robotics, drones, and IoT devices skips verification of root CA certificates by default.
- **CVE-2014-1266:** chain: incorrect "goto" in Apple SSL product bypasses certificate validation, allowing Adversary-in-the-Middle (AITM) attack (Apple "goto fail" bug). CWE-705 (Incorrect Control Flow Scoping) -> CWE-561 (Dead Code) -> CWE-295 (Improper Certificate Validation) -> CWE-393 (Return of Wrong Status Code) -> CWE-300 (Channel Accessible by Non-Endpoint).
- **CVE-2021-22909:** Chain: router's firmware update procedure uses curl with "-k" (insecure) option that disables certificate validation (CWE-295), allowing adversary-in-the-middle (AITM) compromise with a malicious firmware image (CWE-494).

