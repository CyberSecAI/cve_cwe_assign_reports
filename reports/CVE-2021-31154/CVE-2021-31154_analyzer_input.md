# Vulnerability Information: CVE-2021-31154

## Vulnerability Description
pleaseedit in please before 0.4 uses **predictable temporary filenames** in /tmp and the target directory. This allows a local attacker to gain full root privileges by staging a symlink attack.

### Vulnerability Description Key Phrases
- **rootcause:** **predictable temporary filenames**
- **impact:** gain full root privileges
- **vector:** symlink attack
- **attacker:** local attacker
- **product:** please
- **version:** before 0.4
- **component:** /tmp and the target directory

## CVE Reference Links Content Summary
The provided content is related to CVE-2021-31154.

**Root cause of vulnerability:**
The `pleaseedit` utility uses predictable temporary file names in `/tmp` and the target directory.

**Weaknesses/vulnerabilities present:**
- Predictable temporary file paths are generated using `tmp_edit_file_name()` and `source_tmp_file_name()`.
- Missing `O_NOFOLLOW` flag when calling `openat()` on the generated temporary files in `/tmp`, making it vulnerable to symlink attacks.
- Lack of unpredictable file names created in a `mkstemp()` manner.
- `chown()` is called on the temporary file in `/tmp` before a possible race condition allowing for local root exploit if not for symlink protection mechanism.
- In the target directory, `pleaseedit` follows symlinks when creating temporary copies.

**Impact of exploitation:**
- If a regular user is allowed to edit any file via `pleaseedit`, an attacker could potentially overwrite arbitrary files and change their ownership if symlink protections are not in place.
- If a target directory is controlled by a non-root user, privilege escalation could occur.
- Local root exploit is possible if a race condition is won.

**Attack vectors:**
- Exploiting predictable file names in `/tmp` via symlink attacks.
- Exploiting the lack of `O_NOFOLLOW` flag when opening temporary files in `/tmp`.
- Exploiting symlink following in target directories where temporary copies are created.

**Required attacker capabilities/position:**
- The attacker must be a local user who is allowed to use the `pleaseedit` command to edit files.
- The attacker needs to create symlinks in `/tmp` to the files they wish to overwrite.
- The attacker needs to be in control of the target directory if exploiting symlink following there.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-379 | Creation of Temporary File in Directory with Insecure Permissions | Base | Allowed | 0.5699 | dense, sparse, graph | dense: 0.512, sparse: 0.165, graph: 0.614 |
| 2 | CWE-378 | Creation of Temporary File With Insecure Permissions | Base | Allowed | 0.5448 | dense, sparse, graph | dense: 0.487, sparse: 0.143, graph: 0.613 |
| 3 | CWE-59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | 0.3285 | sparse, graph | sparse: 0.197, graph: 0.603 |
| 4 | CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | 0.3026 | sparse, graph | sparse: 0.134, graph: 0.631 |
| 5 | CWE-250 | Execution with Unnecessary Privileges | Base | Allowed | 0.2933 | dense, sparse | dense: 0.419, sparse: 0.146 |
| 6 | CWE-277 | Insecure Inherited Permissions | Variant | Allowed | 0.2755 | dense, sparse | dense: 0.431, sparse: 0.145 |
| 7 | CWE-65 | Windows Hard Link | Variant | Allowed | 0.2718 | sparse, graph | sparse: 0.180, graph: 0.536 |
| 8 | CWE-61 | UNIX Symbolic Link (Symlink) Following | Compound | Allowed | 0.2431 | dense, sparse | dense: 0.444, sparse: 0.164 |
| 9 | CWE-377 | Insecure Temporary File | Class | Allowed-with-Review | 0.2414 | dense, sparse | dense: 0.502, sparse: 0.279 |
| 10 | CWE-340 | Generation of Predictable Numbers or Identifiers | Class | Allowed-with-Review | 0.1666 | sparse, graph | sparse: 0.138, graph: 0.572 |

