# Vulnerability Information: CVE-2022-47945

## Vulnerability Description
ThinkPHP Framework before 6.0.14 allows **local file inclusion** via the lang parameter when the language pack feature is enabled (lang_switch_on=true). An unauthenticated and remote attacker can exploit this to execute arbitrary operating system commands, as demonstrated by including pearcmd.php.

### Vulnerability Description Key Phrases
- **rootcause:** **improper input validation**
- **weakness:** **local file inclusion**
- **impact:** arbitrary code execution
- **vector:** lang parameter
- **attacker:** unauthenticated remote attacker
- **product:** ThinkPHP Framework
- **version:** before 6.0.14

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**
The vulnerability stems from insufficient sanitization of user-provided input used to determine the language pack to load. Specifically, the `detect()` function in `src/think/Lang.php` and `src/think/middleware/LoadLangPack.php` retrieves the language setting from GET parameters, HTTP headers, or cookies without proper validation. This allows an attacker to inject directory traversal sequences within the language parameter.

**Weaknesses/Vulnerabilities:**
- **Directory Traversal:** The lack of sanitization allows for path traversal using sequences like `../`, enabling the attacker to access files outside the intended language directory.
- **Unrestricted File Inclusion:** The application uses the attacker-controlled, traversed path to load language files via `include` or `require` in `Lang.php` and `LoadLangPack.php`.
- **Remote Code Execution (RCE):** By combining directory traversal with file inclusion, and including the `pearcmd` file which is known to be exploitable, the attacker can execute arbitrary PHP code.

**Impact of Exploitation:**
Successful exploitation of this vulnerability allows an attacker to achieve Remote Code Execution (RCE) on the server. This can lead to:
- Full control of the webserver
- Data exfiltration
- Defacement
- Further attacks within the internal network.

**Attack Vectors:**
- HTTP GET parameter: `/?lang=../../../../../public/index`
- HTTP Header: Setting the `think-lang` header.
- HTTP Cookie: Setting the `think_lang` cookie.

**Required Attacker Capabilities/Position:**
- The attacker needs to be able to send HTTP requests to the vulnerable application.
- The target application must have the multi-language feature enabled using the `\think\middleware\LoadLangPack::class` middleware in `app/middleware.php` for ThinkPHP 6 or `lang_switch_on` set to `true` in `config/app.php` or `application/config.php` for ThinkPHP 5.
- No authentication is needed, making the vulnerability easily exploitable for any user.

**Additional Notes:**

- The provided content describes the vulnerability in ThinkPHP versions 5.x and 6.0.1 to 6.0.13.
- The vulnerability was patched in commit `c4acb8b4001b98a0078eda25840d33e295a7f099`
- The attacker uses the `pearcmd` trick to achieve RCE by including a specially crafted pear configuration file through directory traversal.
- The fix includes sanitizing user-provided language inputs, preventing directory traversal and subsequent file inclusion.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-184 | Incomplete List of Disallowed Inputs | Base | Allowed | 0.7890 | dense, sparse, graph | dense: 0.510, sparse: 0.308, graph: 1.000 |
| 2 | CWE-78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | 0.6838 | dense, sparse, graph | dense: 0.522, sparse: 0.299, graph: 0.704 |
| 3 | CWE-88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | 0.6805 | dense, sparse, graph | dense: 0.521, sparse: 0.311, graph: 0.676 |
| 4 | CWE-98 | Improper Control of Filename for Include/Require Statement in PHP Program ('PHP Remote File Inclusion') | Variant | Allowed | 0.6481 | dense, sparse, graph | dense: 0.645, sparse: 0.167, graph: 0.793 |
| 5 | CWE-434 | Unrestricted Upload of File with Dangerous Type | Base | Allowed | 0.6218 | dense, sparse, graph | dense: 0.538, sparse: 0.268, graph: 0.558 |
| 6 | CWE-24 | Path Traversal: '../filedir' | Variant | Allowed | 0.5502 | dense, sparse | dense: 0.570, sparse: 0.543 |
| 7 | CWE-94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | 0.4908 | sparse, graph | sparse: 0.292, graph: 0.971 |
| 8 | CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | 0.4881 | sparse, graph | sparse: 0.316, graph: 0.860 |
| 9 | CWE-1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | 0.4173 | dense, sparse | dense: 0.515, sparse: 0.279 |
| 10 | CWE-79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | 0.4128 | dense, sparse | dense: 0.516, sparse: 0.270 |

