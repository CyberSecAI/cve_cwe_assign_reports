# Critic Input for CVE-2021-25735



# Original Analyzer Input
## Vulnerability Description
A security issue was discovered in kube-apiserver that could allow node updates to bypass a Validating Admission Webhook. Clusters are only affected by this vulnerability if they run a Validating Admission Webhook for Nodes that denies admission based at least partially on the old state of the Node object. Validating Admission Webhook does not observe some previous fields.

### Vulnerability Description Key Phrases
- **impact:** bypass Validating Admission Webhook
- **vector:** node updates
- **product:** kube-apiserver

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2021-25735:

**Root Cause of Vulnerability:**

The vulnerability lies in how the Kubernetes `kube-apiserver` handles updates to node resources when a Validating Admission Webhook is in place. When a node update occurs, the admission controller receives information that could include old configurations of the node object. This old information is then used before the actual validation of the update, potentially allowing the overwriting of values used for validation and thus bypassing the webhook's restrictions.

**Weaknesses/Vulnerabilities Present:**

*   **Bypass of Validating Admission Webhook:** The core issue is the ability to bypass the intended restrictions imposed by a Validating Admission Webhook. The webhook should evaluate the update request to determine if it is allowed but due to the described mechanism it is not correctly validating the updated node.
*   **Use of Old State for Validation:** The vulnerability arises from the admission controller's reliance on potentially outdated information about the node, instead of using the most current state for validation, which allows an attacker to present a state that the webhook would approve, while effectively updating the node to a state that would be otherwise blocked.
*   **Improper Update Handling:** The vulnerability is specific to node updates, indicating a flaw in how the update process integrates with validating admission controllers.

**Impact of Exploitation:**

*   **Unauthorized Node Updates:** An attacker could perform unauthorized updates to node resources, potentially leading to the modification of critical node configurations.
*   **Compromise of Cluster Integrity:** By bypassing the admission controller's restrictions, the attacker can inject malicious updates, potentially compromising the overall integrity and security of the Kubernetes cluster.
*   **Possible Privilege Escalation (Indirect):** Although not directly stated, manipulating node configurations could potentially be leveraged to escalate privileges within the cluster, if the update could be used to give the attacker the ability to run arbitrary code inside the cluster or to access resources that would otherwise be restricted to them.

**Attack Vectors:**

*   **Network-based:** The vulnerability can be exploited remotely, as the attack vector is classified as "Network".
*   **Node Update Actions:** The specific action that triggers the vulnerability is an update to a node resource.

**Required Attacker Capabilities/Position:**

*   **High Privileges:** The attacker requires high privileges within the Kubernetes cluster, specifically the ability to update or patch node resources.
*   **Validating Admission Webhook:**  The vulnerability is only exploitable if the cluster has a Validating Admission Webhook for Nodes that denies admission based partially on the old state of the Node object.
*   **Network Access:** The attacker must have network access to the kube-apiserver.

**Additional Notes:**

*   The vulnerability does not affect calls from kubelets that go through the built-in NodeRestriction admission plugin.
*   The vulnerability is fixed in kube-apiserver versions 1.20.6, 1.19.10, and 1.18.18 and higher.

This information is more detailed than a standard CVE description and provides valuable insights for understanding and mitigating the vulnerability.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-295 | Improper Certificate Validation | Base | Allowed | 0.4993 | dense, sparse, graph | dense: 0.439, sparse: 0.074, graph: 0.665 |
| 2 | CWE-306 | Missing Authentication for Critical Function | Base | Allowed | 0.4918 | dense, sparse, graph | dense: 0.478, sparse: 0.065, graph: 0.603 |
| 3 | CWE-372 | Incomplete Internal State Distinction | Base | Discouraged | 0.4251 | dense, sparse, graph | dense: 0.507, sparse: 0.217, graph: 0.578 |
| 4 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.3993 | sparse, graph | sparse: 0.073, graph: 1.000 |
| 5 | CWE-532 | Insertion of Sensitive Information into Log File | Base | Allowed | 0.2643 | dense, sparse | dense: 0.453, sparse: 0.065 |
| 6 | CWE-201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | 0.2635 | dense, sparse | dense: 0.450, sparse: 0.067 |
| 7 | CWE-863 | Incorrect Authorization | Class | Allowed-with-Review | 0.1598 | dense, sparse | dense: 0.464, sparse: 0.070 |
| 8 | CWE-1390 | Weak Authentication | Class | Allowed-with-Review | 0.1304 | sparse, graph | sparse: 0.074, graph: 0.503 |
| 9 | CWE-1333 | Inefficient Regular Expression Complexity | Base | Allowed | 0.0392 | sparse | sparse: 0.069 |
| 10 | CWE-112 | Missing XML Validation | Base | Allowed | 0.0382 | sparse | sparse: 0.067 |



# Analysis to Review
# Summary
| CWE ID | CWE Name | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |
|---|---|---|---|---|---|
| CWE-863 | Incorrect Authorization | 0.75 | Class | Primary | Allowed-with-Review |
| CWE-346 | Failure to Verify Origin | 0.60 | Class | Secondary | Allowed-with-Review |
| CWE-372 | Incomplete Internal State Distinction | 0.50 | Base | Secondary | Discouraged |

## Evidence and Confidence

*   **Confidence Score:** 0.70
*   **Evidence Strength:** MEDIUM

- **Analysis and Justification:**
  - *Explanation:* The core of the vulnerability involves the `kube-apiserver` allowing node updates to bypass a Validating Admission Webhook due to the admission controller's reliance on outdated information. This directly relates to **incorrect authorization** (CWE-863) because the intended authorization mechanism (the Validating Admission Webhook) is circumvented. The system is not correctly performing the authorization check, as node updates are being processed without proper validation against the current state. The `kube-apiserver` does not correctly perform the check to see if the actor (node update) is authorized to perform the action, since the check is based on old information. Since CWE-863 is a Class-level CWE, a more specific CWE could be more appropiate. However, none of its children seem to be a good fit for the specific root cause.
  
  - *Relationship Analysis:* While CWE-863 is a class-level weakness, it encapsulates the core issue of incorrect authorization. There are no direct parent-child relationships that provide a more specific fit for this vulnerability. CWE-346 (Failure to Verify Origin) is a possible related weakness, as the system is not properly verifying the validity of the node update request against the current state. CWE-372 (Incomplete Internal State Distinction) is present because the admission controller does not properly track or distinguish between the old and new states of a node.

- **Confidence Score:**
  - Confidence: 0.75 (Moderate evidence supporting CWE-863, supplemented by relationship analysis.)

---

- **Analysis and Justification:**
  - *Explanation:* The vulnerability also involves a **failure to verify the origin** (CWE-346) of the node update in the context of the current system state. This is because the Validating Admission Webhook should ensure that the node update request is valid in relation to the cluster's current configuration, but it is failing to do so due to the use of outdated information.
  
  - *Relationship Analysis:* CWE-346 is a Class-level weakness, and a more specific Base or Variant might be more appropriate if the details were available. No direct relationships were found.

- **Confidence Score:**
  - Confidence: 0.60 (Supporting evidence for CWE-346, indicating a failure to properly verify the source of the data.)

---

- **Analysis and Justification:**
  - *Explanation:* The vulnerability touches on **incomplete internal state distinction** (CWE-372). The vulnerability description indicates that the system does not properly distinguish between the old and new states of the node, leading to validation errors.
  
  - *Relationship Analysis:* While CWE-372 is generally discouraged, in this specific context, the improper handling of the node's internal state (old vs. new) contributes to the vulnerability.

- **Confidence Score:**
  - Confidence: 0.50 (Limited evidence directly supporting CWE-372; primarily inferred from the vulnerability description.)

# CWE Examples from Database


## Known Examples for CWE-346: Origin Validation Error
### Observed Examples
- **CVE-2000-1218** [https://www.cve.org/CVERecord?id=CVE-2000-1218](https://www.cve.org/CVERecord?id=CVE-2000-1218): DNS server can accept DNS updates from hosts that it did not query, leading to cache poisoning
- **CVE-2005-0877** [https://www.cve.org/CVERecord?id=CVE-2005-0877](https://www.cve.org/CVERecord?id=CVE-2005-0877): DNS server can accept DNS updates from hosts that it did not query, leading to cache poisoning
- **CVE-2001-1452** [https://www.cve.org/CVERecord?id=CVE-2001-1452](https://www.cve.org/CVERecord?id=CVE-2001-1452): DNS server caches glue records received from non-delegated name servers
- **CVE-2005-2188** [https://www.cve.org/CVERecord?id=CVE-2005-2188](https://www.cve.org/CVERecord?id=CVE-2005-2188): user ID obtained from untrusted source (URL)
- **CVE-2003-0174** [https://www.cve.org/CVERecord?id=CVE-2003-0174](https://www.cve.org/CVERecord?id=CVE-2003-0174): LDAP service does not verify if a particular attribute was set by the LDAP server
- **CVE-1999-1549** [https://www.cve.org/CVERecord?id=CVE-1999-1549](https://www.cve.org/CVERecord?id=CVE-1999-1549): product does not sufficiently distinguish external HTML from internal, potentially dangerous HTML, allowing bypass using special strings in the page title. Overlaps special elements.
- **CVE-2003-0981** [https://www.cve.org/CVERecord?id=CVE-2003-0981](https://www.cve.org/CVERecord?id=CVE-2003-0981): product records the reverse DNS name of a visitor in the logs, allowing spoofing and resultant XSS.
### Top 25 Examples
- **CVE-2021-30630**: Inappropriate implementation in Blink in Google Chrome prior to 93.0.4577.82 allowed a remote attacker who had compromised the renderer process to leak cross-origin data via a crafted HTML page.
- **CVE-2021-37967**: Inappropriate implementation in Background Fetch API in Google Chrome prior to 94.0.4606.54 allowed a remote attacker who had compromised the renderer process to leak cross-origin data via a crafted HTML page.
- **CVE-2021-41088**: Elvish is a programming language and interactive shell, combined into one package. In versions prior to 0.14.0 Elvish's web UI backend (started by `elvish -web`) hosts an endpoint that allows executing the code sent from the web UI. The backend does not check the origin of requests correctly. As a result, if the user has the web UI backend open and visits a compromised or malicious website, the website can send arbitrary code to the endpoint in localhost. All Elvish releases from 0.14.0 onward no longer include the the web UI, although it is still possible for the user to build a version from source that includes the web UI. The issue can be patched for previous versions by removing the web UI (found in web, pkg/web or pkg/prog/web, depending on the exact version).


# Relevant CWE Specifications

## CWE-346: Origin Validation Error
**Abstraction:** Class
**Status:** Draft

### Description
The product does not properly verify that the source of data or communication is valid.

### Extended Description
Not provided

### Alternative Terms
None

### Relationships
ChildOf -> CWE-345
ChildOf -> CWE-345
ChildOf -> CWE-284
ParentOf -> CWE-1385
RequiredBy -> CWE-352
RequiredBy -> CWE-384
ParentOf -> CWE-940

### Mapping Guidance
**Usage:** Allowed-with-Review
**Rationale:** This CWE entry is a Class and might have Base-level children that would be more appropriate
**Comments:** Examine children of this entry to see if there is a better fit
**Reasons:**
- Abstraction



### Additional Notes
**[Maintenance]** This entry has some significant overlap with other CWE entries and may need some clarification. See terminology notes.

**[Terminology]** The "Origin Validation Error" term was originally used in a 1995 thesis [REF-324]. Although not formally defined, an issue is considered to be an origin validation error if either (1) "an object [accepts] input from an unauthorized subject," or (2) "the system [fails] to properly or completely authenticate a subject." A later section says that an origin validation error can occur when the system (1) "does not properly authenticate a user or process" or (2) "does not properly authenticate the shared data or libraries." The only example provided in the thesis (covered by OSVDB:57615) involves a setuid program running command-line arguments without dropping privileges. So, this definition (and its examples in the thesis) effectively cover other weaknesses such as CWE-287 (Improper Authentication), CWE-285 (Improper Authorization), and CWE-250 (Execution with Unnecessary Privileges). There appears to be little usage of this term today, except in the SecurityFocus vulnerability database, where the term is used for a variety of issues, including web-browser problems that allow violation of the Same Origin Policy and improper validation of the source of an incoming message.



### Observed Examples
- **CVE-2000-1218:** DNS server can accept DNS updates from hosts that it did not query, leading to cache poisoning
- **CVE-2005-0877:** DNS server can accept DNS updates from hosts that it did not query, leading to cache poisoning
- **CVE-2001-1452:** DNS server caches glue records received from non-delegated name servers



## CWE-372: Incomplete Internal State Distinction
**Abstraction:** Base
**Status:** Draft

### Description
The product does not properly determine which state it is in, causing it to assume it is in state X when in fact it is in state Y, causing it to perform incorrect operations in a security-relevant manner.

### Extended Description
Not provided

### Alternative Terms
None

### Relationships
ChildOf -> CWE-664

### Mapping Guidance
**Usage:** Discouraged
**Rationale:** This CWE entry could be deprecated in a future version of CWE.
**Comments:** See maintenance notes.
**Reasons:**
- Potential Deprecation
- CWE Overlap



### Additional Notes
**[Relationship]** This conceptually overlaps other categories such as insufficient verification, but this entry refers to the product's incorrect perception of its own state.

**[Relationship]** This is probably resultant from other weaknesses such as unhandled error conditions, inability to handle out-of-order steps, multiple interpretation errors, etc.

**[Maintenance]** This entry is being considered for deprecation. It was poorly-defined in PLOVER and is not easily described using the behavior/resource/property model of vulnerability theory.





## CWE-863: Incorrect Authorization
**Abstraction:** Class
**Status:** Incomplete

### Description
The product performs an authorization check when an actor attempts to access a resource or perform an action, but it does not correctly perform the check.

### Extended Description
Not provided

### Alternative Terms
AuthZ: "AuthZ" is typically used as an abbreviation of "authorization" within the web application security community. It is distinct from "AuthN" (or, sometimes, "AuthC") which is an abbreviation of "authentication." The use of "Auth" as an abbreviation is discouraged, since it could be used for either authentication or authorization.

### Relationships
ChildOf -> CWE-285
ChildOf -> CWE-284
ParentOf -> CWE-1244
ParentOf -> CWE-551
ParentOf -> CWE-639
ParentOf -> CWE-647
ParentOf -> CWE-804
ParentOf -> CWE-942

### Mapping Guidance
**Usage:** Allowed-with-Review
**Rationale:** This CWE entry is a Class and might have Base-level children that would be more appropriate
**Comments:** Examine children of this entry to see if there is a better fit
**Reasons:**
- Abstraction


### Potential Mitigations
**Mitigation 1:**
- **Phase:** Architecture and Design
- **Description:** 

Divide the product into anonymous, normal, privileged, and administrative areas. Reduce the attack surface by carefully mapping roles with data and functionality. Use role-based access control (RBAC) [REF-229] to enforce the roles at the appropriate boundaries.


Note that this approach may not protect against horizontal authorization, i.e., it will not protect a user from attacking others with the same role.


**Mitigation 2:**
- **Phase:** Architecture and Design
- **Description:** Ensure that access control checks are performed related to the business logic. These checks may be different than the access control checks that are applied to more generic resources such as files, connections, processes, memory, and database records. For example, a database may restrict access for medical records to a specific database user, but each record might only be intended to be accessible to the patient and the patient's doctor [REF-7].

**Mitigation 3:**
- **Phase:** Architecture and Design
- **Strategy:** Libraries or Frameworks
- **Description:** 

Use a vetted library or framework that does not allow this weakness to occur or provides constructs that make this weakness easier to avoid.


For example, consider using authorization frameworks such as the JAAS Authorization Framework [REF-233] and the OWASP ESAPI Access Control feature [REF-45].




### Additional Notes
**[Terminology]** 

Assuming a user with a given identity, authorization is the process of determining whether that user can access a given resource, based on the user's privileges and any permissions or other access-control specifications that apply to the resource.




### Observed Examples
- **CVE-2021-39155:** Chain: A microservice integration and management platform compares the hostname in the HTTP Host header in a case-sensitive way (CWE-178, CWE-1289), allowing bypass of the authorization policy (CWE-863) using a hostname with mixed case or other variations.
- **CVE-2019-15900:** Chain: sscanf() call is used to check if a username and group exists, but the return value of sscanf() call is not checked (CWE-252), causing an uninitialized variable to be checked (CWE-457), returning success to allow authorization bypass for executing a privileged (CWE-863).
- **CVE-2009-2213:** Gateway uses default "Allow" configuration for its authorization settings.

