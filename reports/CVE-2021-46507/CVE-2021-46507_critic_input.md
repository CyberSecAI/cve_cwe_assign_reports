# Critic Input for CVE-2021-46507



# Original Analyzer Input
## Vulnerability Description
Jsish v3.5.0 was discovered to contain a **stack overflow** via Jsi_LogMsg at src/jsiUtils.c.

### Vulnerability Description Key Phrases
- **weakness:** **stack overflow**
- **product:** Jsish
- **version:** v3.5.0
- **component:** src/jsiUtils.c

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of the vulnerability:

**Root cause of vulnerability:**
The root cause is a stack overflow within the `Jsi_LogMsg` function, specifically triggered during the conversion of a value to a string via `Jsi_ValueToString`. The issue is caused by a recursive call chain involving `Jsi_LogMsg` and `Jsi_ValueToString` when processing certain crafted input, leading to excessive stack usage.

**Weaknesses/vulnerabilities present:**
- Stack overflow due to unbounded recursion.
- Improper handling of specific input data, causing infinite recursion when converting values to strings.

**Impact of exploitation:**
- The program crashes due to a stack overflow, leading to a denial-of-service (DoS).

**Attack vectors:**
- Crafted JavaScript code provided as input. Specifically, using `WebSocket` function with specially crafted object or using `times` with `WebSocket` and an expression that evaluates to NaN or undefined.

**Required attacker capabilities/position:**
- Ability to provide the vulnerable software with malicious Javascript input.

**Technical Details:**

- The vulnerability occurs in `src/jsiUtils.c:151` within the `Jsi_LogMsg` function.
- The call stack shows recursive calls between `Jsi_LogMsg` (at `src/jsiUtils.c:229`) and `Jsi_ValueToString` (at `src/jsiValue.c:526`).
- The vulnerability is triggered by a crafted WebSocket call within a `times` function with the problematic expression `null % null`.
- AddressSanitizer output shows a stack overflow with specific addresses and the call stack leading to the overflow.

This information is more detailed than a simple CVE description would provide.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.5242 | dense, sparse, graph | dense: 0.507, sparse: 0.072, graph: 0.641 |
| 2 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.4973 | dense, sparse, graph | dense: 0.472, sparse: 0.085, graph: 0.594 |
| 3 | CWE-170 | Improper Null Termination | Base | Allowed | 0.3267 | sparse, graph | sparse: 0.078, graph: 0.789 |
| 4 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3037 | dense, sparse | dense: 0.530, sparse: 0.111 |
| 5 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.2931 | sparse, graph | sparse: 0.086, graph: 0.682 |
| 6 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.2916 | dense, sparse | dense: 0.518, sparse: 0.100 |
| 7 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.2878 | dense, sparse | dense: 0.490, sparse: 0.074 |
| 8 | CWE-193 | Off-by-one Error | Base | Allowed | 0.2869 | dense, sparse | dense: 0.484, sparse: 0.078 |
| 9 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.2753 | dense, sparse | dense: 0.518, sparse: 0.068 |
| 10 | CWE-120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | 0.2747 | dense, sparse | dense: 0.483, sparse: 0.080 |



# Analysis to Review
# Summary
| CWE ID | CWE Name | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |
|---|---|---|---|---|---|
| CWE-674 | Improper Control of Recursion | 0.9 | Class | Primary | Allowed-with-Review |

## Evidence and Confidence

*   **Confidence Score:** 0.9
*   **Evidence Strength:** HIGH

- **Analysis and Justification:**  
  - *Explanation:* The vulnerability description clearly states a **stack overflow** condition, which is triggered by excessive recursion within the `Jsi_LogMsg` function in `src/jsiUtils.c`. The CVE Reference Links Content Summary reinforces this, highlighting "Stack overflow due to unbounded recursion" and "Improper handling of specific input data, causing infinite recursion". CWE-674 (Improper Control of Recursion) directly addresses the scenario where a product "does not properly control the amount of recursion that takes place, consuming excessive resources, such as allocated memory or the program stack." The attack involves crafted Javascript, which triggers recursive calls between `Jsi_LogMsg` and `Jsi_ValueToString`. CWE-674 is a Class-level CWE, and while a more specific Base-level child might be ideal, none of the retriever results provide a better fit given the root cause is the lack of recursion control rather than a specific type of buffer overflow. The usage is "Allowed-with-Review", which acknowledges the need to check for more specific children. Given the evidence, CWE-674 is the most appropriate primary mapping.

  - *Relationship Analysis:* Although CWE-674 does not have direct relationships listed in the provided data, it is conceptually related to resource management issues. The stack overflow is a direct consequence of the uncontrolled recursion.

- **Confidence Score:**
  - Confidence: 0.9 (High confidence due to clear description of stack overflow caused by uncontrolled recursion and supporting evidence from the CVE Reference Links Content Summary)

# CWE Examples from Database


## Known Examples for CWE-674: Uncontrolled Recursion
### Observed Examples
- **CVE-2007-1285** [https://www.cve.org/CVERecord?id=CVE-2007-1285](https://www.cve.org/CVERecord?id=CVE-2007-1285): Deeply nested arrays trigger stack exhaustion.
- **CVE-2007-3409** [https://www.cve.org/CVERecord?id=CVE-2007-3409](https://www.cve.org/CVERecord?id=CVE-2007-3409): Self-referencing pointers create infinite loop and resultant stack exhaustion.
- **CVE-2016-10707** [https://www.cve.org/CVERecord?id=CVE-2016-10707](https://www.cve.org/CVERecord?id=CVE-2016-10707): Javascript application accidentally changes input in a way that prevents a recursive call from detecting an exit condition.
- **CVE-2016-3627** [https://www.cve.org/CVERecord?id=CVE-2016-3627](https://www.cve.org/CVERecord?id=CVE-2016-3627): An attempt to recover a corrupted XML file infinite recursion protection counter was not always incremented missing the exit condition.
- **CVE-2019-15118** [https://www.cve.org/CVERecord?id=CVE-2019-15118](https://www.cve.org/CVERecord?id=CVE-2019-15118): USB-audio driver's descriptor code parsing allows unlimited recursion leading to stack exhaustion.
### Top 25 Examples
- **CVE-2020-18392**: Stack overflow vulnerability in parse_array Cesanta MJS 1.20.1, allows remote attackers to cause a Denial of Service (DoS) via a crafted file.
- **CVE-2020-18898**: A stack exhaustion issue in the printIFDStructure function of Exiv2 0.27 allows remote attackers to cause a denial of service (DOS) via a crafted file.
- **CVE-2020-36366**: Stack overflow vulnerability in parse_value Cesanta MJS 1.20.1, allows remote attackers to cause a Denial of Service (DoS) via a crafted file.
- **CVE-2020-36367**: Stack overflow vulnerability in parse_block Cesanta MJS 1.20.1, allows remote attackers to cause a Denial of Service (DoS) via a crafted file.
- **CVE-2020-36368**: Stack overflow vulnerability in parse_statement Cesanta MJS 1.20.1, allows remote attackers to cause a Denial of Service (DoS) via a crafted file.


# Relevant CWE Specifications

## CWE-674: Uncontrolled Recursion
**Abstraction:** Class
**Status:** Draft

### Description
The product does not properly control the amount of recursion that takes place,  consuming excessive resources, such as allocated memory or the program stack.

### Extended Description
Not provided

### Alternative Terms
Stack Exhaustion

### Relationships
ChildOf -> CWE-834
ParentOf -> CWE-776

### Mapping Guidance
**Usage:** Allowed-with-Review
**Rationale:** This CWE entry is a Class and might have Base-level children that would be more appropriate
**Comments:** Examine children of this entry to see if there is a better fit
**Reasons:**
- Abstraction


### Potential Mitigations
**Mitigation 1:**
- **Phase:** Implementation
- **Effectiveness:** Moderate
- **Description:** Ensure an end condition will be reached under all logic conditions. The end condition may include testing against the depth of recursion and exiting with an error if the recursion goes too deep. The complexity of the end condition contributes to the effectiveness of this action.

**Mitigation 2:**
- **Phase:** Implementation
- **Effectiveness:** Limited
- **Description:** Increase the stack size.




### Observed Examples
- **CVE-2007-1285:** Deeply nested arrays trigger stack exhaustion.
- **CVE-2007-3409:** Self-referencing pointers create infinite loop and resultant stack exhaustion.
- **CVE-2016-10707:** Javascript application accidentally changes input in a way that prevents a recursive call from detecting an exit condition.

