# Vulnerability Information: CVE-2022-31031

## Vulnerability Description
PJSIP is a free and open source multimedia communication library written in C language implementing standard based protocols such as SIP, SDP, RTP, STUN, TURN, and ICE. In versions prior to and including 2.12.1 a **stack buffer overflow** vulnerability affects PJSIP users that use STUN in their applications, either by setting a STUN server in their account/media config in PJSUA/PJSUA2 level, or directly using `pjlib-util/stun_simple` API. A patch is available in commit 450baca which should be included in the next release. There are no known workarounds for this issue.

### Vulnerability Description Key Phrases
- **weakness:** **stack buffer overflow**
- **attacker:** PJSIP users
- **product:** PJSIP
- **version:** prior to and including 2.12.1
- **component:** pjlib-util/stun_simple API

## CVE Reference Links Content Summary
Based on the provided information, here's an analysis of CVE-2022-31031:

**Root Cause of Vulnerability:**

*   The vulnerability is a stack buffer overflow that occurs when parsing a STUN message. Specifically, it arises from a missing boundary check when processing STUN attributes within the `pjstun_parse_msg` function in `pjlib-util/stun_simple.c`.

**Weaknesses/Vulnerabilities Present:**

*   **Stack Buffer Overflow (CWE-121):** The code iterates through STUN attributes, potentially exceeding the allocated buffer on the stack if the message contains a large number of attributes, or an attribute that has a very long length.

**Impact of Exploitation:**

*   **Arbitrary Code Execution:**  The Gentoo advisory notes that the worst case scenario is arbitrary code execution, but the provided information only directly confirms stack buffer overflow, which may lead to denial of service or other undefined behavior.
*   **Denial of Service (DoS):**  The Debian advisories (DLA 3335-1 and DSA 5358-1) note that buffer overflows can be exploited for denial of service.

**Attack Vectors:**

*   **STUN Message Parsing:** The vulnerability is triggered when parsing a specially crafted STUN message. This could occur if the application is using a STUN server, or is directly parsing STUN messages using the API.
*  The GitHub advisory notes that PJSIP users who use STUN in their applications, either by setting a STUN server or directly using the `pjlib-util/stun_simple` API, are affected.

**Required Attacker Capabilities/Position:**

*   An attacker needs to be able to send a malicious STUN message to a vulnerable application that is using PJSIP with STUN support enabled.

**Additional Details:**

*   The fix for this vulnerability is available in commit `450baca` which adds a boundary check to prevent the buffer overflow. The fix also adds a log message to warn the user if the maximum attribute count is reached.
*   The vulnerability affects versions 2.12.1 and earlier of PJSIP.
*   The vulnerability is rated as "Critical" in the GitHub Security Advisory and "normal" with remote exploitability by Gentoo.
*   The vulnerability is present in the `pjlib-util/stun_simple.c` file.
*   The affected software includes `ring/jami`, and `asterisk`.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.6907 | dense, sparse, graph | dense: 0.447, sparse: 0.395, graph: 0.674 |
| 2 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.6886 | dense, sparse, graph | dense: 0.469, sparse: 0.371, graph: 0.677 |
| 3 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.6497 | dense, sparse, graph | dense: 0.463, sparse: 0.451, graph: 0.599 |
| 4 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.4413 | dense, sparse | dense: 0.502, sparse: 0.396 |
| 5 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.4281 | dense, sparse | dense: 0.456, sparse: 0.349 |
| 6 | CWE-193 | Off-by-one Error | Base | Allowed | 0.4186 | dense, sparse | dense: 0.430, sparse: 0.355 |
| 7 | CWE-754 | Improper Check for Unusual or Exceptional Conditions | Class | Allowed-with-Review | 0.4025 | dense, sparse, graph | dense: 0.446, sparse: 0.420, graph: 0.620 |
| 8 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3996 | dense, sparse | dense: 0.473, sparse: 0.343 |
| 9 | CWE-789 | Memory Allocation with Excessive Size Value | Variant | Allowed | 0.3963 | sparse, graph | sparse: 0.350, graph: 0.641 |
| 10 | CWE-401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | 0.3958 | dense, sparse | dense: 0.494, sparse: 0.318 |

