# Vulnerability Information: CVE-2022-30426

## Vulnerability Description
There is a **stack buffer overflow** vulnerability, which could lead to arbitrary code execution in UEFI DXE driver on some Acer products. An attack could exploit this vulnerability to escalate privilege from ring 3 to ring 0, and hijack control flow during UEFI DXE execution. This affects Altos T110 F3 firmware version <= P13 (latest) and AP130 F2 firmware version <= P04 (latest) and Aspire 1600X firmware version <= P11.A3L (latest) and Aspire 1602M firmware version <= P11.A3L (latest) and Aspire 7600U firmware version <= P11.A4 (latest) and Aspire MC605 firmware version <= P11.A4L (latest) and Aspire TC-105 firmware version <= P12.B0L (latest) and Aspire TC-120 firmware version <= P11-A4 (latest) and Aspire U5-620 firmware version <= P11.A1 (latest) and Aspire X1935 firmware version <= P11.A3L (latest) and Aspire X3475 firmware version <= P11.A3L (latest) and Aspire X3995 firmware version <= P11.A3L (latest) and Aspire XC100 firmware version <= P11.B3 (latest) and Aspire XC600 firmware version <= P11.A4 (latest) and Aspire Z3-615 firmware version <= P11.A2L (latest) and Veriton E430G firmware version <= P21.A1 (latest) and Veriton B630_49 firmware version <= AAP02SR (latest) and Veriton E430 firmware version <= P11.A4 (latest) and Veriton M2110G firmware version <= P21.A3 (latest) and Veriton M2120G fir.

### Vulnerability Description Key Phrases
- **rootcause:** **stack buffer overflow**
- **impact:** arbitrary code execution
- **product:** Acer Altos T110 F3, AP130 F2, Aspire 1600X, 1602M, 7600U, MC605, TC-105, TC-120, U5-620, X1935, X3475, X3995, XC100, XC600, Z3-615, Veriton E430G, B630_49, E430, M2110G, M2120G
- **version:** Altos T110 F3 <= P13, AP130 F2 <= P04, Aspire 1600X <= P11.A3L, 1602M <= P11.A3L, 7600U <= P11.A4, MC605 <= P11.A4L, TC-105 <= P12.B0L, TC-120 <= P11-A4, U5-620 <= P11.A1, X1935 <= P11.A3L, X3475 <= P11.A3L, X3995 <= P11.A3L, XC100 <= P11.B3, XC600 <= P11.A4, Z3-615 <= P11.A2L, Veriton E430G <= P21.A1, B630_49 <= AAP02SR, E430 <= P11.A4, M2110G <= P21.A3, M2120G <= P21.A3
- **component:** UEFI DXE driver

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

- The vulnerability stems from an incorrect usage of the `gRT->GetVariable` service within the `TcgPlatformSetupPolicy` driver. Specifically, two calls to `gRT->GetVariable` are made sequentially, and they improperly reuse a single `DataSize` variable.

**Weaknesses/Vulnerabilities:**

- **Stack Buffer Overflow:** The primary vulnerability is a stack buffer overflow. The first `gRT->GetVariable` call with a large variable ("InternalDisallowTpmFlag") updates the `DataSize` variable with the size of the variable's data. The subsequent `gRT->GetVariable` call, intended to read the "TcgInternalSyncFlag" variable, uses the updated `DataSize`, potentially causing a stack buffer overflow if the second variable's data is larger than the allocated buffer size on the stack.
- **Improper NVRAM Variable Handling:** The code does not properly validate and manage the size of data read from NVRAM variables.

**Impact of Exploitation:**

- **Arbitrary Code Execution:** By overflowing the stack, the attacker can overwrite the return address, thus achieving arbitrary code execution within the UEFI DXE driver context.
- **Privilege Escalation:** An attacker can escalate their privileges from ring 3 or ring 0 (depending on the OS) to DXE Runtime UEFI application.
- **Malicious Code Persistence:** The exploit can be used to install malicious code that survives across OS boot processes because the vulnerability resides in the UEFI firmware, which is loaded before the OS, and NVRAM variables persist between boots. The attacker can modify the NVRAM area in SPI flash storage to gain persistence.

**Attack Vectors:**

- **NVRAM Variable Manipulation:** The attack vector involves manipulating NVRAM variables, setting them to very large string values to cause the stack overflow during the driver execution.
- **UEFI Driver Loading:** The exploit occurs when the vulnerable driver `TcgPlatformSetupPolicy` is loaded during the UEFI boot process.

**Required Attacker Capabilities/Position:**

- **Ability to Set NVRAM Variables:** The attacker needs the ability to set the values of specific NVRAM variables (`InternalDisallowTpmFlag` and `TcgInternalSyncFlag`). This may require a privileged position or some access to system configuration.
- **Ability to trigger UEFI Driver Load:** The attacker needs to trigger the loading of the vulnerable UEFI driver.

**Additional Details:**

- **Affected Models:** The document lists numerous Acer Altos servers and Aspire/Veriton laptop/desktop models that are affected by this vulnerability.
- **Exploitability:** The provided proof of concept (PoC) demonstrates that the vulnerability is readily exploitable, showing the process of overwriting the return address and gaining code execution in the driver. The document even details how to create a simple shellcode to print a string.
- **Vendor Response:** Acer's security team stated the affected models were end-of-life and thus no fix was made available.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.8366 | dense, sparse | dense: 0.668, sparse: 1.000 |
| 2 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.7267 | sparse, graph | sparse: 0.645, graph: 1.000 |
| 3 | CWE-676 | Use of Potentially Dangerous Function | Base | Allowed | 0.6262 | sparse, graph | sparse: 0.575, graph: 0.832 |
| 4 | CWE-250 | Execution with Unnecessary Privileges | Base | Allowed | 0.5968 | dense, sparse | dense: 0.569, sparse: 0.546 |
| 5 | CWE-78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | 0.5913 | dense, sparse | dense: 0.579, sparse: 0.527 |
| 6 | CWE-912 | Hidden Functionality | Class | Allowed-with-Review | 0.3666 | dense, sparse | dense: 0.573, sparse: 0.589 |
| 7 | CWE-306 | Missing Authentication for Critical Function | Base | Allowed | 0.3245 | sparse | sparse: 0.567 |
| 8 | CWE-288 | Authentication Bypass Using an Alternate Path or Channel | Base | Allowed | 0.3245 | sparse | sparse: 0.567 |
| 9 | CWE-708 | Incorrect Ownership Assignment | Base | Allowed | 0.3121 | sparse | sparse: 0.546 |
| 10 | CWE-359 | Exposure of Private Personal Information to an Unauthorized Actor | Base | Allowed | 0.3036 | sparse | sparse: 0.531 |

