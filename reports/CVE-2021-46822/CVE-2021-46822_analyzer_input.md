# Vulnerability Information: CVE-2021-46822

## Vulnerability Description
The PPM reader in libjpeg-turbo through 2.0.90 mishandles use of tjLoadImage for loading a 16-bit binary PPM file into a grayscale buffer and loading a 16-bit binary PGM file into an RGB buffer. This is related to a **heap-based buffer overflow** in the get_word_rgb_row function in rdppm.c.

### Vulnerability Description Key Phrases
- **weakness:** **heap-based buffer overflow**
- **product:** libjpeg-turbo
- **version:** through 2.0.90
- **component:** PPM reader, get_word_rgb_row function in rdppm.c

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause of Vulnerability:**

The root cause lies in how the `tjLoadImage()` function within the libjpeg-turbo library handled 16-bit PPM/PGM image files. Specifically, there were issues related to:

1.  **Buffer Overrun:** Attempting to load a 16-bit PPM file into a grayscale uncompressed image buffer could cause a buffer overrun, leading to a crash (segfault).
2.  **Incorrect Pixel Generation:** Loading a 16-bit PGM file into an RGB uncompressed image buffer resulted in the generation of incorrect pixel data. Also, incorrect pixels were generated when loading a 16-bit PPM file into an extended RGB image buffer if the input colorspace was not JCS_RGB or JCS_EXT_RGB.
3.  **Lack of Input Validation:** The code lacked proper validation to ensure that the input color space and the bit depth of the image data were compatible, leading to the above issues.

**Weaknesses/Vulnerabilities Present:**

*   **Buffer Overflow:** A buffer overflow vulnerability existed when a 16-bit PPM was loaded into a grayscale buffer, which could lead to a crash.
*   **Incorrect Data Handling:** The code incorrectly processed the 16-bit image data in certain scenarios, leading to corrupted image output.
*   **Improper Input Handling:** The code did not check for the compatibility between input color spaces and bit depths of the image data.

**Impact of Exploitation:**

*   **Denial of Service:** The buffer overrun could lead to a crash of the application utilizing libjpeg-turbo, resulting in a denial-of-service.
*   **Data Corruption:** Incorrect pixel generation would lead to corrupted image data, which could lead to misinterpretations or other issues by the consuming application.

**Attack Vectors:**

The primary attack vector is through the `tjLoadImage()` function. An attacker would need to provide a specially crafted 16-bit PPM or PGM image file that would trigger the vulnerable code paths.

**Required Attacker Capabilities/Position:**

*   **Ability to control input:** An attacker would need to be able to control the image file that is loaded by an application that uses the vulnerable `tjLoadImage()` function from libjpeg-turbo.

**Additional Notes**

* The vulnerability was specific to the `tjLoadImage()` function, and other functions like cjpeg were unaffected.
* The vulnerability was triggered when loading 16-bit PPM/PGM files, particularly when the input color space and the destination buffer were not correctly matched.
* The fix included changes to `rdppm.c` to add better error handling for such scenarios, and correct pixel generation when loading 16 bit ppm/pgm files into different buffers.
* The fix also includes throwing errors for out-of-range values in the input stream.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6866 | dense, sparse, graph | dense: 0.526, sparse: 0.277, graph: 0.742 |
| 2 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.5812 | dense, sparse, graph | dense: 0.478, sparse: 0.254, graph: 0.549 |
| 3 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.5652 | dense, sparse, graph | dense: 0.465, sparse: 0.230, graph: 0.562 |
| 4 | CWE-197 | Numeric Truncation Error | Base | Allowed | 0.4865 | sparse, graph | sparse: 0.268, graph: 0.932 |
| 5 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.4135 | dense, sparse | dense: 0.539, sparse: 0.311 |
| 6 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.3995 | dense, sparse | dense: 0.539, sparse: 0.285 |
| 7 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.3872 | dense, sparse | dense: 0.480, sparse: 0.257 |
| 8 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.3665 | dense, sparse | dense: 0.470, sparse: 0.230 |
| 9 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3644 | dense, sparse | dense: 0.494, sparse: 0.258 |
| 10 | CWE-839 | Numeric Range Comparison Without Minimum Check | Base | Allowed | 0.3597 | sparse, graph | sparse: 0.253, graph: 0.602 |

