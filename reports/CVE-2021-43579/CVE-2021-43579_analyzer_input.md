# Vulnerability Information: CVE-2021-43579

## Vulnerability Description
A **stack-based buffer overflow** in image_load_bmp() in HTMLDOC <= 1.9.13 results in remote code execution if the victim converts an HTML document linking to a crafted BMP file.

### Vulnerability Description Key Phrases
- **rootcause:** **stack-based buffer overflow**
- **impact:** remote code execution
- **vector:** crafted BMP file
- **product:** HTMLDOC
- **version:** <= 1.9.13
- **component:** image_load_bmp()

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability described in CVE-2021-43579:

**Root Cause:**

*   The vulnerability lies in the `image_load_bmp()` function within the HTMLDOC software. This function is responsible for loading and processing BMP image files.
*   The `colors_used` variable, read from the BMP file header, is used to determine the size of the color map to be read into a fixed-size buffer (`colormap`).
*   The code does not adequately validate the `colors_used` value, allowing an attacker to provide a large value, causing a stack buffer overflow during the `fread()` operation.

**Weaknesses/Vulnerabilities:**

*   **Stack-based buffer overflow:** The primary vulnerability is a stack buffer overflow in the `image_load_bmp()` function.
*   **Insufficient input validation:** The software does not properly validate the `colors_used` value read from the BMP file, leading to the overflow. The code checks for `colors_used > 256` which is not sufficient since `colors_used` is a signed integer. A negative value will pass the check but still cause an overflow.

**Impact of Exploitation:**

*   **Remote code execution (RCE):** By overflowing the stack, an attacker can overwrite the return address, potentially leading to arbitrary code execution on the victim's machine.
*   **Crash (segmentation fault):** As a side effect, the overflow might cause a segmentation fault leading to a crash.

**Attack Vectors:**

*   **Malicious BMP file:** The attack vector involves a maliciously crafted BMP file containing an oversized value for `colors_used`.
*   **HTML document:** An HTML document including the crafted BMP file is used to trigger the vulnerability when converted by HTMLDOC. The user must open this crafted document using `htmldoc` to be vulnerable.

**Required Attacker Capabilities/Position:**

*   **Ability to craft a malicious BMP file.** The attacker needs to create a BMP file with the specific header values to trigger the overflow.
*   **Ability to get the victim to open a malicious HTML document referencing the crafted BMP file** The attacker needs to have the victim use `htmldoc` to convert a document that contains the crafted BMP file.

**Additional Information:**

*   The vulnerability is present in HTMLDOC versions <= 1.9.13.
*   The fix involves adding a check to prevent excessive values for `colors_used` from being used.
*   The issue was initially reported in [issue #453](https://github.com/michaelrsweet/htmldoc/issues/453) and then determined that the fix was not sufficient in [issue #456](https://github.com/michaelrsweet/htmldoc/issues/456)
*   The vulnerability was addressed in commit [27d0898](https://github.com/michaelrsweet/htmldoc/commit/27d08989a5a567155d506ac870ae7d8cc88fa58b) and [753c71b](https://github.com/michaelrsweet/htmldoc/commit/753c71bce6fd916458e31b30eb633a577731d8b8)

This information is more detailed than the original CVE description.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6254 | dense, sparse, graph | dense: 0.528, sparse: 0.171, graph: 0.736 |
| 2 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.5574 | dense, sparse, graph | dense: 0.530, sparse: 0.161, graph: 0.689 |
| 3 | CWE-120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | 0.4396 | sparse, graph | sparse: 0.180, graph: 1.000 |
| 4 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3631 | dense, sparse | dense: 0.546, sparse: 0.210 |
| 5 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.3544 | dense, sparse | dense: 0.516, sparse: 0.168 |
| 6 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3533 | dense, sparse | dense: 0.554, sparse: 0.184 |
| 7 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.3516 | dense, sparse | dense: 0.511, sparse: 0.167 |
| 8 | CWE-193 | Off-by-one Error | Base | Allowed | 0.3481 | dense, sparse | dense: 0.500, sparse: 0.171 |
| 9 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.3432 | dense, sparse | dense: 0.502, sparse: 0.161 |
| 10 | CWE-127 | Buffer Under-read | Variant | Allowed | 0.3393 | dense, sparse | dense: 0.515, sparse: 0.192 |

