# Vulnerability Information: CVE-2021-42585

## Vulnerability Description
A **heap buffer overflow** was discovered in copy_compressed_bytes in decode_r2007.c in dwgread before 0.12.4 via a crafted dwg file.

### Vulnerability Description Key Phrases
- **weakness:** **heap buffer overflow**
- **vector:** crafted dwg file
- **product:** dwgread
- **version:** before 0.12.4
- **component:** copy_compressed_bytes in decode_r2007.c

### CWE for similar CVE Descriptions
### Primary CWE Match
CWE-787

#### Top CWEs
- CWE-787 (Count: 6)

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of the vulnerability:

**Root Cause:**
- A heap-based buffer overflow occurs in the `copy_compressed_bytes` function within `decode_r2007.c`. This function is responsible for handling compressed data within DWG files. The overflow occurs due to an incorrect calculation of buffer size when decompressing data.

**Vulnerabilities/Weaknesses:**
- **Heap-buffer-overflow:** The primary vulnerability is a heap buffer overflow, where the `memcpy` function writes data past the allocated buffer. This indicates a lack of proper bounds checking.

**Impact:**
- **Crash:** The immediate impact is a program crash, as shown by the AddressSanitizer report.
- **Potential Remote Code Execution:** While not explicitly stated, heap buffer overflows can be exploited to achieve remote code execution by overwriting heap metadata or other critical data structures. This would require further exploitation beyond the crash.

**Attack Vectors:**
- **Malicious DWG file:** The vulnerability can be triggered by opening a specially crafted DWG file containing malicious or improperly compressed data.

**Required Attacker Capabilities/Position:**
- **File Manipulation:** An attacker needs the ability to create or modify a DWG file.
- **Targeted User Interaction:** The attacker must then get a user to open this malicious DWG file using the vulnerable `libredwg` library or application that uses it.

**Additional Details:**
- The issue is located in the `copy_compressed_bytes` function at line 332 of `decode_r2007.c`.
- The ASAN report shows that the overflow occurs during a `memcpy` operation.
- The affected versions include "the latest commit" (4c210bbae04957b7d4aba55aee8dca42337f8d47) and version 0.12.4
- The issue was addressed by a fix in GH [#349](https://github.com/LibreDWG/libredwg/issues/349) related to handling invalid sections.
- A Proof-of-Concept (POC) file `tests_64205.zip` is provided.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6808 | dense, sparse, graph | dense: 0.553, sparse: 0.144, graph: 0.901 |
| 2 | CWE-193 | Off-by-one Error | Base | Allowed | 0.6757 | dense, sparse, graph | dense: 0.539, sparse: 0.136, graph: 0.917 |
| 3 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.5659 | dense, sparse, graph | dense: 0.594, sparse: 0.144, graph: 0.652 |
| 4 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.5321 | dense, sparse, graph | dense: 0.534, sparse: 0.114, graph: 0.558 |
| 5 | CWE-120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | 0.4786 | dense, sparse, graph | dense: 0.536, sparse: 0.119, graph: 0.462 |
| 6 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.3674 | dense, sparse | dense: 0.603, sparse: 0.169 |
| 7 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.3482 | dense, sparse | dense: 0.551, sparse: 0.127 |
| 8 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.3441 | dense, sparse | dense: 0.553, sparse: 0.118 |
| 9 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.3364 | dense, sparse | dense: 0.534, sparse: 0.120 |
| 10 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.3335 | dense, sparse | dense: 0.521, sparse: 0.127 |

