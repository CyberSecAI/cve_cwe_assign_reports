# Vulnerability Information: CVE-2022-37035

## Vulnerability Description
An issue was discovered in bgpd in FRRouting (FRR) 8.3. In bgp_notify_send_with_data() and bgp_process_packet() in bgp_packet.c, there is a possible **use-after-free** due to a **race condition**. This could lead to Remote Code Execution or Information Disclosure by sending crafted BGP packets. User interaction is not needed for exploitation.

### Vulnerability Description Key Phrases
- **rootcause:** **race condition**
- **weakness:** **use-after-free**
- **impact:** Remote Code Execution and Information Disclosure
- **vector:** crafted BGP packets
- **product:** FRRouting (FRR)
- **version:** 8.3
- **component:** bgpd

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2022-37035:

**Root Cause of Vulnerability:**

- The vulnerability is a use-after-free (UAF) condition caused by a race condition in the `bgpd` daemon of FRRouting (FRR).
- The race occurs between two threads: an I/O thread and the main thread processing BGP packets.

**Weaknesses/Vulnerabilities Present:**

- **Use-After-Free (UAF):** The core issue is that the main thread might attempt to access or free a memory location that has already been freed by the I/O thread.
- **Race Condition:** The vulnerability arises due to the lack of proper synchronization between the I/O thread which reads data into `peer->ibuf` and then `peer->curr` and the main thread which uses the `peer->curr` pointer. The main thread reads the pointer and proceeds without holding a lock, and the I/O thread might free the underlying memory while the main thread is using the pointer, leading to UAF.

**Impact of Exploitation:**

- **Remote Code Execution (RCE):** The vulnerability could allow an attacker to execute arbitrary code on the affected system.
- **Information Disclosure:** The vulnerability could lead to the disclosure of sensitive information in memory.
- **bgpd crash:** The vulnerability can lead to a crash of the bgpd daemon.

**Attack Vectors:**

- **Network-based:** An attacker can exploit the vulnerability by sending crafted BGP packets to a vulnerable FRR router.
- **Specifically crafted BGP messages:** The vulnerability can be triggered by sending a sequence of BGP OPEN, KEEPALIVE, and NOTIFICATION messages. The provided test scripts send a BGP OPEN, followed by a KEEPALIVE and then a NOTIFICATION message.

**Required Attacker Capabilities/Position:**

- **Network Access:** The attacker needs to be able to send network packets to the targeted FRR router.
- **BGP knowledge:** The attacker needs a basic understanding of the BGP protocol to craft malicious packets.

**Additional Notes:**

- The vulnerability was found using address sanitizer during fuzzing with Boofuzz, as noted in the provided discussion.
- The issue was fixed in FRR by synchronizing the access to the shared data by extending the mutex to include usage, and freeing operations.
- The Debian LTS advisory lists CVE-2022-37035 as one of several vulnerabilities fixed in the `frr` package, further confirming the vulnerability.
- The vulnerability can be triggered with a high probability, but not 100% of the time, suggesting it is a race condition.
- The provided information indicates that the `extended-optional-parameters` configuration is not required to trigger the vulnerability.
- The discussion highlights the specific locations in the code related to the vulnerability: `bgp_packet.c:2886` and `bgp_packet.c:922`.
- A patch was merged to resolve this vulnerability

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-416 | Use After Free | Variant | Allowed | 0.7238 | dense, sparse, graph | dense: 0.534, sparse: 0.418, graph: 0.776 |
| 2 | CWE-367 | Time-of-check Time-of-use (TOCTOU) Race Condition | Base | Allowed | 0.5581 | sparse, graph | sparse: 0.424, graph: 0.882 |
| 3 | CWE-908 | Use of Uninitialized Resource | Base | Allowed | 0.4945 | dense, sparse | dense: 0.520, sparse: 0.410 |
| 4 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.4894 | dense, sparse | dense: 0.520, sparse: 0.400 |
| 5 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.4769 | dense, sparse | dense: 0.520, sparse: 0.379 |
| 6 | CWE-362 | Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition') | Class | Allowed-with-Review | 0.4695 | dense, sparse, graph | dense: 0.553, sparse: 0.520, graph: 0.630 |
| 7 | CWE-415 | Double Free | Variant | Allowed | 0.4692 | sparse, graph | sparse: 0.404, graph: 0.776 |
| 8 | CWE-401 | Missing Release of Memory after Effective Lifetime | Variant | Allowed | 0.4599 | dense, sparse | dense: 0.546, sparse: 0.393 |
| 9 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.4391 | dense, sparse | dense: 0.518, sparse: 0.378 |
| 10 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.3935 | dense, sparse | dense: 0.520, sparse: 0.232 |

