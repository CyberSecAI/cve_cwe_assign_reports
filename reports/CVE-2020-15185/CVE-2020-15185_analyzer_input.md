# Vulnerability Information: CVE-2020-15185

## Vulnerability Description
In **Helm before versions 2.16.11 and 3.3.2**, a Helm repository can contain duplicates of the same chart, with the last one always used. If a repository is compromised, this lowers the level of access that an attacker needs to inject a bad chart into a repository. To perform this attack, an attacker must have write access to the index file (which can occur during a MITM attack on a non-SSL connection). This issue has been patched in Helm 3.3.2 and 2.16.11. A possible workaround is to manually review the index file in the Helm repository cache before installing software.

### Vulnerability Description Key Phrases
- **weakness:** **Helm before versions 2.16.11 and 3.3.2**
- **vector:** inject a bad chart into a repository
- **attacker:** attacker
- **product:** Helm
- **version:** before versions 2.16.11 and 3.3.2

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2020-15185:

**1. Verification:**

The content directly relates to CVE-2020-15185, as indicated by the inclusion of the CVE ID within the security advisory:
```
### CVE ID
CVE-2020-15185
```
and the commit message:
```
Merge pull request from [GHSA-jm56-5h66-w453](https://github.com/advisories/GHSA-jm56-5h66-w453 "GHSA-jm56-5h66-w453")
```

**2. Vulnerability Details:**

*   **Root Cause:** The vulnerability stems from the Helm repository index file format which allowed duplicate entries for the same chart. When the Helm client processed the index, it would use the last entry, effectively allowing an attacker to overwrite legitimate chart entries with malicious ones.
*   **Weaknesses/Vulnerabilities:**
    *   **Duplicate Chart Entries:** The primary weakness was the lack of validation or deduplication of chart entries in the Helm repository index file, allowing for multiple entries with the same chart name.
    *   **Last Entry Wins:**  The Helm client's behavior of always using the *last* entry in the index file, when duplicates were present, created an exploitable condition.
*   **Impact of Exploitation:**
    *   **Chart Injection:** An attacker who gains write access to a Helm repository index file (either by compromising the server or by performing a man-in-the-middle attack on an insecure connection) can inject malicious chart entries.
    *   **Malicious Deployment:**  A user installing a chart from the compromised repository would unknowingly download and install the malicious chart, as Helm would only use the last entry listed in the index.
*   **Attack Vectors:**
    *   **Compromised Repository:** If an attacker gains control of the repository that hosts the index, they can directly alter the index file, adding malicious entries.
    *   **Man-in-the-Middle (MITM) Attack:** An attacker performing a MITM attack on an insecure (non-TLS) connection while the user is downloading the index file could modify the index to inject a malicious entry.
*   **Required Attacker Capabilities/Position:**
    *   **Write Access:** The attacker must be able to modify the Helm repository's index file.
    *   **MITM:**  Alternatively, an attacker must be positioned to conduct a MITM attack on the channel to inject a malicious chart entry into the index file as it is being downloaded.

**3. Additional Details:**
*   **Affected Versions:** Helm versions 2.0.0 through 2.16.10, and 3.0.0 through 3.3.1 are vulnerable.
*  **Patched Versions**: Helm versions 2.16.11 and 3.3.2 fix this vulnerability
*   **Mitigation:** The advisory also lists workarounds:
    *   Use secure communication channels (TLS).
    *   Manually review the index files before installing charts.
    *   Fetch charts using `helm pull` and verify them with `helm verify` if they're signed.
*   **Severity:**  The severity is marked as "Low"

**4. Code Changes:**
The included commit shows changes made to resolve the vulnerability:
*   **`pkg/repo/index.go`**:
    *   Adds `yaml.UnmarshalStrict` to ensure that duplicate entries are handled correctly.
    *   Adds several deprecated fields to the `ChartVersion` struct to maintain backwards compatibility.
*   **`pkg/repo/index_test.go`**:
    *   Adds a new test case `TestLoadIndex_Duplicates` to verify that an error occurs when duplicate entries are present in the index file, preventing the vulnerability.

In summary, CVE-2020-15185 is a vulnerability in Helm that allowed attackers to inject malicious charts by exploiting the lack of duplicate chart entry validation in the repository index. The vulnerability was addressed by enforcing strict YAML parsing, preventing duplicate chart entries and raising an error if they occur.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-694 | Use of Multiple Resources with Duplicate Identifier | Base | Allowed | 0.9579 | dense, sparse, graph | dense: 0.487, sparse: 0.880, graph: 0.590 |
| 2 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.6229 | sparse, graph | sparse: 0.464, graph: 1.000 |
| 3 | CWE-427 | Uncontrolled Search Path Element | Base | Allowed | 0.5783 | sparse, graph | sparse: 0.491, graph: 0.832 |
| 4 | CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | 0.4879 | dense, sparse | dense: 0.415, sparse: 0.490 |
| 5 | CWE-201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | 0.4794 | dense, sparse | dense: 0.417, sparse: 0.473 |
| 6 | CWE-306 | Missing Authentication for Critical Function | Base | Allowed | 0.4786 | dense, sparse | dense: 0.420, sparse: 0.469 |
| 7 | CWE-434 | Unrestricted Upload of File with Dangerous Type | Base | Allowed | 0.4754 | sparse, graph | sparse: 0.474, graph: 0.572 |
| 8 | CWE-923 | Improper Restriction of Communication Channel to Intended Endpoints | Class | Allowed-with-Review | 0.3310 | dense, sparse | dense: 0.432, sparse: 0.607 |
| 9 | CWE-863 | Incorrect Authorization | Class | Allowed-with-Review | 0.2884 | dense, sparse | dense: 0.436, sparse: 0.477 |
| 10 | CWE-79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | 0.2766 | sparse | sparse: 0.484 |

