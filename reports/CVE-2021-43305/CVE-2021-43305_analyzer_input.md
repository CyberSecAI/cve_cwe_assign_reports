# Vulnerability Information: CVE-2021-43305

## Vulnerability Description
**Heap buffer overflow** in Clickhouses LZ4 compression codec when parsing a malicious query. There is no verification that the copy operations in the LZ4decompressImpl loop and especially the arbitrary copy operation wildCopy(op, ip, copy_end), dont exceed the destination buffers limits. This issue is very similar to CVE-2021-43304, but the vulnerable copy operation is in a different wildCopy call.

### Vulnerability Description Key Phrases
- **rootcause:** **Heap buffer overflow**
- **product:** Clickhouse
- **component:** LZ4 compression codec

## CVE Reference Links Content Summary
```
{
  "vulnerability": {
    "cve_id": "CVE-2021-43305",
    "description": "Heap buffer overflow in Clickhouse's LZ4 compression codec when parsing a malicious query. There is no verification that the copy operations in the LZ4::decompressImpl loop and especially the arbitrary copy operation wildCopy<copy_amount>(op, ip, copy_end), don&#8217;t exceed the destination buffer&#8217;s limits. This issue is very similar to CVE-2021-43304, but the vulnerable copy operation is in a different wildCopy call.",
    "technical_details": "The vulnerability is located in the LZ4::decompressImpl function, specifically in the wildCopy operation. The function does not validate if the copy operation exceeds the destination buffer limits. The attacker can provide a crafted compressed data with a header that has a smaller decompressed size compared to the actual size of the compressed data, which can lead to a heap buffer overflow when the wildCopy function is executed.",
    "affected_components": [
      "LZ4 compression codec in ClickHouse"
    ],
    "root_cause": "Lack of bounds check in the LZ4 decompression implementation",
    "vulnerabilities": [
      "Heap buffer overflow"
    ],
    "impact": "Remote code execution (RCE), crash of the ClickHouse server, memory corruption",
    "attack_vector": "Parsing a malicious query with crafted compressed data.",
     "required_capabilities": "Authenticated user with read permissions to ClickHouse server. Ability to send malformed compressed data."
  }
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.7140 | dense, sparse, graph | dense: 0.510, sparse: 0.285, graph: 0.827 |
| 2 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6981 | dense, sparse, graph | dense: 0.550, sparse: 0.286, graph: 0.725 |
| 3 | CWE-120 | Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') | Base | Allowed-with-Review | 0.6634 | dense, sparse, graph | dense: 0.504, sparse: 0.293, graph: 0.770 |
| 4 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.6601 | dense, sparse, graph | dense: 0.547, sparse: 0.255, graph: 0.827 |
| 5 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.4375 | dense, sparse | dense: 0.558, sparse: 0.340 |
| 6 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.4319 | sparse, graph | sparse: 0.247, graph: 0.813 |
| 7 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.4113 | dense, sparse | dense: 0.517, sparse: 0.266 |
| 8 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.4084 | dense, sparse | dense: 0.508, sparse: 0.270 |
| 9 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.4026 | dense, sparse | dense: 0.500, sparse: 0.266 |
| 10 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.4023 | dense, sparse | dense: 0.508, sparse: 0.258 |

