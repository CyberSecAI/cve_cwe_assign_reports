# Critic Input for CVE-2021-26920



# Original Analyzer Input
## Vulnerability Description
In the Druid ingestion system, the InputSource is used for reading data from a certain data source. However, the HTTP InputSource allows authenticated users to read data from other sources than intended, such as the local file system, with the privileges of the Druid server process. This is not an elevation of privilege when users access Druid directly, since Druid also provides the Local InputSource, which allows the same level of access. But it is problematic when users interact with Druid indirectly through an application that allows users to specify the HTTP InputSource, but not the Local InputSource. In this case, users could bypass the application-level restriction by passing a file URL to the HTTP InputSource.

### Vulnerability Description Key Phrases
- **rootcause:** **InputSource allows access to unintended data sources**
- **impact:** access to local file system
- **attacker:** authenticated users
- **product:** Druid
- **component:** InputSource

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2021-26920:

**Root cause of vulnerability:**
The vulnerability stems from the way Apache Druid's HTTP InputSource handles data retrieval. It allows authenticated users to read data from unintended sources. Specifically, users can supply file URLs to the HTTP InputSource.

**Weaknesses/vulnerabilities present:**
- **Insecure Input Handling:** The HTTP InputSource does not properly validate the provided URL, allowing access to local files.
- **Bypass of Application-Level Restrictions:** When an application restricts users from accessing certain InputSources (like Local), users can still access local files by using the HTTP InputSource with a `file://` URL.

**Impact of exploitation:**
- **Unauthorized Data Access:** Attackers can read arbitrary files on the server, potentially exposing sensitive information.
- **Bypass access control:** By using the HTTP InputSource an attacker could potentially bypass application-level restrictions on access to the local file system.

**Attack vectors:**
- Users can supply a specially crafted URL to the HTTP InputSource, specifying local files using the `file://` URI scheme.

**Required attacker capabilities/position:**
- An attacker must be an authenticated user of Apache Druid.
- The attacker does not require any special privilege within Druid.

**Additional notes:**
- The provided text indicates that the fix for this issue in 0.21.0 was incomplete and a second CVE (CVE-2021-36749) was issued to address the same vulnerability that was not fixed in 0.21.0 or 0.21.1.
- The recommended mitigation is to upgrade to version 0.22.0 or higher. In earlier versions, applications should disallow the Local, HTTP, and HDFS InputSources if local file system access needs to be restricted.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-201 | Insertion of Sensitive Information Into Sent Data | Base | Allowed | 0.5590 | sparse, graph | sparse: 0.504, graph: 0.757 |
| 2 | CWE-863 | Incorrect Authorization | Class | Allowed-with-Review | 0.3119 | sparse, graph | sparse: 0.614, graph: 0.503 |
| 3 | CWE-59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | 0.2853 | sparse | sparse: 0.499 |
| 4 | CWE-639 | Authorization Bypass Through User-Controlled Key | Base | Allowed | 0.2809 | sparse | sparse: 0.491 |
| 5 | CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | 0.2805 | sparse | sparse: 0.490 |
| 6 | CWE-79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | 0.2789 | sparse | sparse: 0.488 |
| 7 | CWE-266 | Incorrect Privilege Assignment | Base | Allowed | 0.2787 | sparse | sparse: 0.487 |
| 8 | CWE-306 | Missing Authentication for Critical Function | Base | Allowed | 0.2778 | sparse | sparse: 0.486 |
| 9 | CWE-532 | Insertion of Sensitive Information into Log File | Base | Allowed | 0.2777 | sparse | sparse: 0.486 |
| 10 | CWE-1289 | Improper Validation of Unsafe Equivalence in Input | Base | Allowed | 0.2768 | sparse | sparse: 0.484 |



# Analysis to Review
# Summary
| CWE ID | CWE Name | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |
|---|---|---|---|---|---|
| CWE-610 | Use of an Externally-Controlled Name to Select a Resource or File | 0.75 | Class | Primary | Allows authenticated users to read data from unintended sources, such as the local file system, by specifying file URLs to the HTTP InputSource. |
| CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | 0.65 | Base | Secondary | Allows users to bypass application-level restrictions by passing a file URL to the HTTP InputSource. |

## Evidence and Confidence

*   **Confidence Score:** 0.70
*   **Evidence Strength:** MEDIUM

- **Analysis and Justification:**  
  - *Explanation:* "The vulnerability description details that the Druid ingestion system's HTTP InputSource allows authenticated users to read data from unintended sources, including the local file system, by using file URLs. This aligns with CWE-610 [Use of an Externally-Controlled Name to Select a Resource or File] because the **InputSource uses an externally controlled name (the URL) to resolve a resource that is outside the intended control sphere (the allowed data sources)**. The CVE Reference Links Content Summary confirms that the vulnerability arises from **insecure input handling of the URL**, allowing access to local files. CWE-610 is a Class-level CWE, but it aptly describes the high-level weakness of using an externally controlled name to access unintended resources. The Retriever Results also include CWE-610, but it is marked as DISCOURAGED for mapping because it is a Class and might have Base-level children that would be more appropriate. However, in this case, the broader scope of resource access makes it suitable. The secondary CWE is CWE-22 [Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')] since the **file URL could be manipulated to traverse directories**, although this is more of a consequence than the primary weakness."
  
  - *Relationship Analysis:* "CWE-610 is a Class, and while it could have more specific children, none fully capture the essence of using an externally controlled resource name. It is related to CWE-73 [External Control of File Name or Path], but CWE-610 is more specific to the use of external names. CWE-22 is a potential consequence of the vulnerability if the file URL is not properly sanitized, leading to path traversal."

- **Confidence Score:**  
  - *Example:* Confidence: 0.70 (Moderate evidence from the vulnerability description and CVE reference materials, with consideration of CWE abstraction levels)

# CWE Examples from Database


## Known Examples for CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')
### Observed Examples
- **CVE-2024-37032** [https://www.cve.org/CVERecord?id=CVE-2024-37032](https://www.cve.org/CVERecord?id=CVE-2024-37032): Large language model (LLM) management tool does not validate the format of a digest value (CWE-1287) from a private, untrusted model registry, enabling relative path traversal (CWE-23), a.k.a. Probllama
- **CVE-2024-4315** [https://www.cve.org/CVERecord?id=CVE-2024-4315](https://www.cve.org/CVERecord?id=CVE-2024-4315): Chain: API for text generation using Large Language Models (LLMs) does not include the "\" Windows folder separator in its denylist (CWE-184) when attempting to prevent Local File Inclusion via path traversal (CWE-22), allowing deletion of arbitrary files on Windows systems.
- **CVE-2022-45918** [https://www.cve.org/CVERecord?id=CVE-2022-45918](https://www.cve.org/CVERecord?id=CVE-2022-45918): Chain: a learning management tool debugger uses external input to locate previous session logs (CWE-73) and does not properly validate the given path (CWE-20), allowing for filesystem path traversal using "../" sequences (CWE-24)
- **CVE-2019-20916** [https://www.cve.org/CVERecord?id=CVE-2019-20916](https://www.cve.org/CVERecord?id=CVE-2019-20916): Python package manager does not correctly restrict the filename specified in a Content-Disposition header, allowing arbitrary file read using path traversal sequences such as "../"
- **CVE-2022-31503** [https://www.cve.org/CVERecord?id=CVE-2022-31503](https://www.cve.org/CVERecord?id=CVE-2022-31503): Python package constructs filenames using an unsafe os.path.join call on untrusted input, allowing absolute path traversal because os.path.join resets the pathname to an absolute path that is specified as part of the input.
- **CVE-2022-24877** [https://www.cve.org/CVERecord?id=CVE-2022-24877](https://www.cve.org/CVERecord?id=CVE-2022-24877): directory traversal in Go-based Kubernetes operator app allows accessing data from the controller's pod file system via ../ sequences in a yaml file
- **CVE-2021-21972** [https://www.cve.org/CVERecord?id=CVE-2021-21972](https://www.cve.org/CVERecord?id=CVE-2021-21972): Chain: Cloud computing virtualization platform does not require authentication for upload of a tar format file (CWE-306), then uses .. path traversal sequences (CWE-23) in the file to access unexpected files, as exploited in the wild per CISA KEV.
- **CVE-2020-4053** [https://www.cve.org/CVERecord?id=CVE-2020-4053](https://www.cve.org/CVERecord?id=CVE-2020-4053): a Kubernetes package manager written in Go allows malicious plugins to inject path traversal sequences into a plugin archive ("Zip slip") to copy a file outside the intended directory
- **CVE-2020-3452** [https://www.cve.org/CVERecord?id=CVE-2020-3452](https://www.cve.org/CVERecord?id=CVE-2020-3452): Chain: security product has improper input validation (CWE-20) leading to directory traversal (CWE-22), as exploited in the wild per CISA KEV.
- **CVE-2019-10743** [https://www.cve.org/CVERecord?id=CVE-2019-10743](https://www.cve.org/CVERecord?id=CVE-2019-10743): Go-based archive library allows extraction of files to locations outside of the target folder with "../" path traversal sequences in filenames in a zip file, aka "Zip Slip"


# Relevant CWE Specifications

## CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')
**Abstraction:** Base
**Status:** Stable

### Description
The product uses external input to construct a pathname that is intended to identify a file or directory that is located underneath a restricted parent directory, but the product does not properly neutralize special elements within the pathname that can cause the pathname to resolve to a location that is outside of the restricted directory.

### Extended Description


Many file operations are intended to take place within a restricted directory. By using special elements such as ".." and "/" separators, attackers can escape outside of the restricted location to access files or directories that are elsewhere on the system. One of the most common special elements is the "../" sequence, which in most modern operating systems is interpreted as the parent directory of the current location. This is referred to as relative path traversal. Path traversal also covers the use of absolute pathnames such as "/usr/local/bin" to access unexpected files. This is referred to as absolute path traversal.


### Alternative Terms
Directory traversal
Path traversal: "Path traversal" is preferred over "directory traversal," but both terms are attack-focused.

### Relationships
ChildOf -> CWE-706
ChildOf -> CWE-706
ChildOf -> CWE-668
CanFollow -> CWE-172
CanFollow -> CWE-20
ParentOf -> CWE-23
ParentOf -> CWE-36
CanFollow -> CWE-73

### Mapping Guidance
**Usage:** Allowed
**Rationale:** This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.
**Comments:** Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.
**Reasons:**
- Acceptable-Use


### Potential Mitigations
**Mitigation 1:**
- **Phase:** Implementation
- **Strategy:** Input Validation
- **Description:** 

Assume all input is malicious. Use an "accept known good" input validation strategy, i.e., use a list of acceptable inputs that strictly conform to specifications. Reject any input that does not strictly conform to specifications, or transform it into something that does.


When performing input validation, consider all potentially relevant properties, including length, type of input, the full range of acceptable values, missing or extra inputs, syntax, consistency across related fields, and conformance to business rules. As an example of business rule logic, "boat" may be syntactically valid because it only contains alphanumeric characters, but it is not valid if the input is only expected to contain colors such as "red" or "blue."


Do not rely exclusively on looking for malicious or malformed inputs. This is likely to miss at least one undesirable input, especially if the code's environment changes. This can give attackers enough room to bypass the intended validation. However, denylists can be useful for detecting potential attacks or determining which inputs are so malformed that they should be rejected outright.


When validating filenames, use stringent allowlists that limit the character set to be used. If feasible, only allow a single "." character in the filename to avoid weaknesses such as CWE-23, and exclude directory separators such as "/" to avoid CWE-36. Use a list of allowable file extensions, which will help to avoid CWE-434.


Do not rely exclusively on a filtering mechanism that removes potentially dangerous characters. This is equivalent to a denylist, which may be incomplete (CWE-184). For example, filtering "/" is insufficient protection if the filesystem also supports the use of "\" as a directory separator. Another possible error could occur when the filtering is applied in a way that still produces dangerous data (CWE-182). For example, if "../" sequences are removed from the ".../...//" string in a sequential fashion, two instances of "../" would be removed from the original string, but the remaining characters would still form the "../" string.


**Mitigation 2:**
- **Phase:** Architecture and Design
- **Description:** For any security checks that are performed on the client side, ensure that these checks are duplicated on the server side, in order to avoid CWE-602. Attackers can bypass the client-side checks by modifying values after the checks have been performed, or by changing the client to remove the client-side checks entirely. Then, these modified values would be submitted to the server.

**Mitigation 3:**
- **Phase:** Implementation
- **Strategy:** Input Validation
- **Description:** 

Inputs should be decoded and canonicalized to the application's current internal representation before being validated (CWE-180). Make sure that the application does not decode the same input twice (CWE-174). Such errors could be used to bypass allowlist validation schemes by introducing dangerous inputs after they have been checked.


Use a built-in path canonicalization function (such as realpath() in C) that produces the canonical version of the pathname, which effectively removes ".." sequences and symbolic links (CWE-23, CWE-59). This includes:


  - realpath() in C

  - getCanonicalPath() in Java

  - GetFullPath() in ASP.NET

  - realpath() or abs_path() in Perl

  - realpath() in PHP





### Additional Notes
**[Other]** In many programming languages, the injection of a null byte (the 0 or NUL) may allow an attacker to truncate a generated filename to apply to a wider range of files. For example, the product may add ".txt" to any pathname, thus limiting the attacker to text files, but a null injection may effectively remove this restriction.

**[Relationship]** Pathname equivalence can be regarded as a type of canonicalization error.

**[Relationship]** Some pathname equivalence issues are not directly related to directory traversal, rather are used to bypass security-relevant checks for whether a file/directory can be accessed by the attacker (e.g. a trailing "/" on a filename could bypass access rules that don't expect a trailing /, causing a server to provide the file when it normally would not).

**[Terminology]** 

Like other weaknesses, terminology is often based on the types of manipulations used, instead of the underlying weaknesses. Some people use "directory traversal" only to refer to the injection of ".." and equivalent sequences whose specific meaning is to traverse directories.


Other variants like "absolute pathname" and "drive letter" have the *effect* of directory traversal, but some people may not call it such, since it doesn't involve ".." or equivalent.


**[Research Gap]** Many variants of path traversal attacks are probably under-studied with respect to root cause. CWE-790 and CWE-182 begin to cover part of this gap.

**[Research Gap]** 

Incomplete diagnosis or reporting of vulnerabilities can make it difficult to know which variant is affected. For example, a researcher might say that "..\" is vulnerable, but not test "../" which may also be vulnerable.


Any combination of directory separators ("/", "\", etc.) and numbers of "." (e.g. "....") can produce unique variants; for example, the "//../" variant is not listed (CVE-2004-0325). See this entry's children and lower-level descendants.




### Observed Examples
- **CVE-2024-37032:** Large language model (LLM) management tool does not validate the format of a digest value (CWE-1287) from a private, untrusted model registry, enabling relative path traversal (CWE-23), a.k.a. Probllama
- **CVE-2024-4315:** Chain: API for text generation using Large Language Models (LLMs) does not include the "\" Windows folder separator in its denylist (CWE-184) when attempting to prevent Local File Inclusion via path traversal (CWE-22), allowing deletion of arbitrary files on Windows systems.
- **CVE-2022-45918:** Chain: a learning management tool debugger uses external input to locate previous session logs (CWE-73) and does not properly validate the given path (CWE-20), allowing for filesystem path traversal using "../" sequences (CWE-24)



## CWE-73: External Control of File Name or Path
**Abstraction:** Base
**Status:** Draft

### Description
The product allows user input to control or influence paths or file names that are used in filesystem operations.

### Extended Description


This could allow an attacker to access or modify system files or other files that are critical to the application.


Path manipulation errors occur when the following two conditions are met:

```
		1. An attacker can specify a path used in an operation on the filesystem.
		2. By specifying the resource, the attacker gains a capability that would not otherwise be permitted.
```
For example, the program may give the attacker the ability to overwrite the specified file or run with a configuration controlled by the attacker.

### Alternative Terms
None

### Relationships
ChildOf -> CWE-642
ChildOf -> CWE-610
ChildOf -> CWE-20
CanPrecede -> CWE-22
CanPrecede -> CWE-41
CanPrecede -> CWE-98
CanPrecede -> CWE-434
CanPrecede -> CWE-59
ParentOf -> CWE-114

### Mapping Guidance
**Usage:** Allowed
**Rationale:** This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.
**Comments:** Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.
**Reasons:**
- Acceptable-Use


### Potential Mitigations
**Mitigation 1:**
- **Phase:** Architecture and Design
- **Description:** When the set of filenames is limited or known, create a mapping from a set of fixed input values (such as numeric IDs) to the actual filenames, and reject all other inputs. For example, ID 1 could map to "inbox.txt" and ID 2 could map to "profile.txt". Features such as the ESAPI AccessReferenceMap provide this capability.

**Mitigation 2:**
- **Phase:** Architecture and Design, Operation
- **Description:** 

Run your code in a "jail" or similar sandbox environment that enforces strict boundaries between the process and the operating system. This may effectively restrict all access to files within a particular directory.


Examples include the Unix chroot jail and AppArmor. In general, managed code may provide some protection.


This may not be a feasible solution, and it only limits the impact to the operating system; the rest of your application may still be subject to compromise.


Be careful to avoid CWE-243 and other weaknesses related to jails.


**Mitigation 3:**
- **Phase:** Architecture and Design
- **Description:** For any security checks that are performed on the client side, ensure that these checks are duplicated on the server side, in order to avoid CWE-602. Attackers can bypass the client-side checks by modifying values after the checks have been performed, or by changing the client to remove the client-side checks entirely. Then, these modified values would be submitted to the server.



### Additional Notes
**[Maintenance]** CWE-114 is a Class, but it is listed a child of CWE-73 in view 1000. This suggests some abstraction problems that should be resolved in future versions.

**[Relationship]** 

The external control of filenames can be the primary link in chains with other file-related weaknesses, as seen in the CanPrecede relationships. This is because software systems use files for many different purposes: to execute programs, load code libraries, to store application data, to store configuration settings, record temporary data, act as signals or semaphores to other processes, etc.


However, those weaknesses do not always require external control. For example, link-following weaknesses (CWE-59) often involve pathnames that are not controllable by the attacker at all.


The external control can be resultant from other issues. For example, in PHP applications, the register_globals setting can allow an attacker to modify variables that the programmer thought were immutable, enabling file inclusion (CWE-98) and path traversal (CWE-22). Operating with excessive privileges (CWE-250) might allow an attacker to specify an input filename that is not directly readable by the attacker, but is accessible to the privileged program. A buffer overflow (CWE-119) might give an attacker control over nearby memory locations that are related to pathnames, but were not directly modifiable by the attacker.




### Observed Examples
- **CVE-2022-45918:** Chain: a learning management tool debugger uses external input to locate previous session logs (CWE-73) and does not properly validate the given path (CWE-20), allowing for filesystem path traversal using "../" sequences (CWE-24)
- **CVE-2008-5748:** Chain: external control of values for user's desired language and theme enables path traversal.
- **CVE-2008-5764:** Chain: external control of user's target language enables remote file inclusion.



## CWE-610: Externally Controlled Reference to a Resource in Another Sphere
**Abstraction:** Class
**Status:** Draft

### Description
The product uses an externally controlled name or reference that resolves to a resource that is outside of the intended control sphere.

### Extended Description
Not provided

### Alternative Terms
None

### Relationships
ChildOf -> CWE-664
ParentOf -> CWE-1021
ParentOf -> CWE-15
ParentOf -> CWE-384
ParentOf -> CWE-441
ParentOf -> CWE-470
ParentOf -> CWE-601
ParentOf -> CWE-611
ParentOf -> CWE-73
ParentOf -> CWE-918

### Mapping Guidance
**Usage:** Discouraged
**Rationale:** This CWE entry is a level-1 Class (i.e., a child of a Pillar). It might have lower-level children that would be more appropriate
**Comments:** Examine children of this entry to see if there is a better fit
**Reasons:**
- Abstraction



### Additional Notes
**[Relationship]** This is a general class of weakness, but most research is focused on more specialized cases, such as path traversal (CWE-22) and symlink following (CWE-61). A symbolic link has a name; in general, it appears like any other file in the file system. However, the link includes a reference to another file, often in another directory - perhaps in another sphere of control. Many common library functions that accept filenames will "follow" a symbolic link and use the link's target instead.

**[Maintenance]** The relationship between CWE-99 and CWE-610 needs further investigation and clarification. They might be duplicates. CWE-99 "Resource Injection," as originally defined in Seven Pernicious Kingdoms taxonomy, emphasizes the "identifier used to access a system resource" such as a file name or port number, yet it explicitly states that the "resource injection" term does not apply to "path manipulation," which effectively identifies the path at which a resource can be found and could be considered to be one aspect of a resource identifier. Also, CWE-610 effectively covers any type of resource, whether that resource is at the system layer, the application layer, or the code layer.



### Observed Examples
- **CVE-2022-3032:** An email client does not block loading of remote objects in a nested document.
- **CVE-2022-45918:** Chain: a learning management tool debugger uses external input to locate previous session logs (CWE-73) and does not properly validate the given path (CWE-20), allowing for filesystem path traversal using "../" sequences (CWE-24)
- **CVE-2018-1000613:** Cryptography API uses unsafe reflection when deserializing a private key

