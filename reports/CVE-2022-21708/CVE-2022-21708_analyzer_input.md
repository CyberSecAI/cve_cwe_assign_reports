# Vulnerability Information: CVE-2022-21708

## Vulnerability Description
graphql-go is a GraphQL server with a focus on ease of use. In versions prior to 1.3.0 there exists a DoS vulnerability that is possible due to a **bug in the library** that would allow an attacker with specifically designed queries to cause **stack overflow** panics. Any user with access to the GraphQL handler can send these queries and cause **stack overflow**s. This in turn could potentially compromise the ability of the server to serve data to its users. The issue has been patched in version `v1.3.0`. The only known workaround for this issue is to disable the `graphql.MaxDepth` option from your schema which is not recommended.

### Vulnerability Description Key Phrases
- **rootcause:** **bug in the library**
- **weakness:** **stack overflow**
- **impact:** denial of service
- **vector:** specifically designed queries
- **attacker:** attacker
- **product:** graphql-go
- **version:** prior to 1.3.0

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2022-21708:

**Root Cause of Vulnerability:**
The vulnerability stems from a bug in the `graphql-go` library's handling of the `MaxDepth` schema option, specifically when processing fragment spreads. This bug allows crafted GraphQL queries to bypass the intended maximum depth check, leading to stack overflow panics due to excessive recursion.

**Weaknesses/Vulnerabilities Present:**
- **Incorrect Depth Calculation:** The `MaxDepth` validation logic fails to properly track and prevent recursion through fragment spreads, particularly in cases involving circular dependencies between fragments.
- **Lack of Cycle Detection:** The original implementation lacked a mechanism to detect and prevent infinite loops caused by circular fragment references, leading to unbounded recursion.

**Impact of Exploitation:**
- **Denial of Service (DoS):** Attackers can send specially designed queries that exploit this vulnerability, causing stack overflow panics. This can lead to the server becoming unresponsive, disrupting its ability to serve data to legitimate users.

**Attack Vectors:**
- **GraphQL Endpoint Access:** Attackers need access to the GraphQL endpoint to send the malicious queries. This could be an internal user or an external user if the endpoint is exposed.
- **Crafted Queries:** Attackers must craft specific GraphQL queries that contain circular fragment definitions or nested fragments designed to bypass the depth check.

**Required Attacker Capabilities/Position:**
- **Ability to Send GraphQL Queries:** The attacker needs to be able to send requests containing GraphQL queries to the vulnerable server.
- **Understanding of GraphQL and Fragments:** The attacker needs some understanding of GraphQL syntax, especially how fragment definitions and spreads work, to construct malicious queries.

**Additional Details:**

- The vulnerability only exists when the `graphql.MaxDepth` option is used in the GraphQL schema.
- The fix introduces a `visited` map to track visited fragment definitions during depth validation to prevent infinite loops in fragment processing.
- The fix also introduces new tests to confirm that the MaxDepth validation works correctly with fragment spreads.
- Disabling `graphql.MaxDepth` is a workaround, but it can open other potential attack vectors.

The commit `eae31ca` addresses the vulnerability by fixing the bug in fragment spread logic within the maxDepth validation, and includes added tests to ensure that the logic works as expected.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 1.0031 | dense, sparse, graph | dense: 0.483, sparse: 0.878, graph: 0.726 |
| 2 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.9215 | dense, sparse, graph | dense: 0.435, sparse: 0.868, graph: 0.579 |
| 3 | CWE-789 | Memory Allocation with Excessive Size Value | Variant | Allowed | 0.8672 | dense, sparse, graph | dense: 0.439, sparse: 0.857, graph: 0.641 |
| 4 | CWE-79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | 0.8177 | sparse, graph | sparse: 0.910, graph: 0.832 |
| 5 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.7057 | dense, sparse | dense: 0.437, sparse: 0.851 |
| 6 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.6547 | dense, sparse | dense: 0.455, sparse: 0.842 |
| 7 | CWE-502 | Deserialization of Untrusted Data | Base | Allowed | 0.5009 | dense, sparse | dense: 0.425, sparse: 0.504 |
| 8 | CWE-674 | Uncontrolled Recursion | Class | Allowed-with-Review | 0.4884 | dense, sparse | dense: 0.518, sparse: 1.000 |
| 9 | CWE-1333 | Inefficient Regular Expression Complexity | Base | Allowed | 0.4829 | sparse | sparse: 0.844 |
| 10 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.4761 | sparse | sparse: 0.832 |

