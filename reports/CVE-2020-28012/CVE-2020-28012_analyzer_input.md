# Vulnerability Information: CVE-2020-28012

## Vulnerability Description
Exim 4 before 4.94.2 allows **Exposure of File Descriptor to Unintended Control Sphere** because rda_interpret uses a privileged pipe that lacks a close-on-exec flag.

### Vulnerability Description Key Phrases
- **rootcause:** **Exposure of File Descriptor to Unintended Control Sphere**
- **product:** Exim
- **version:** 4 before 4.94.2
- **component:** rda_interpret

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of CVE-2020-28012:

**Root Cause of Vulnerability:**
The Exim mail server, when configured to allow exim filters (allow\_filter is true), creates a pipe for communication between the privileged Exim process (running as root) and an unprivileged filter process. The write end of this communication pipe is not set to close-on-exec, meaning that the file descriptor for the pipe remains open in the spawned filter process. This allows the unprivileged filter process to write to the pipe.

**Weaknesses/Vulnerabilities Present:**
- **Missing close-on-exec flag:** The core vulnerability lies in the lack of the close-on-exec flag for the writable end of the communication pipe. This is a common vulnerability where file descriptors are inherited by child processes.
- **Abuse of rda\_interpret():** The privileged Exim process reads data from the pipe using `rda_interpret()`. It reads an integer representing the filter type, another integer for a size, and two strings based on the size specified. This design allows for a heap-based back-jump and forward-overflow primitive if a negative size is provided.

**Impact of Exploitation:**
- **Local Privilege Escalation (LPE):** An unprivileged local attacker can exploit this vulnerability to gain full root privileges. The attacker does this by writing crafted data through the pipe to the privileged Exim process. The crafted data will cause a controlled overwrite of a file path which leads to the ability to append content to `/etc/passwd`.

**Attack Vectors:**
- **Local Access:** The attacker must be able to execute code as an unprivileged user on the system where Exim is running, and allow_filter must be set to true.
- **Pipe Communication:** The attacker sends crafted data through the writable end of the pipe created for the exim filter process.

**Required Attacker Capabilities/Position:**
- The attacker needs to be a local user on the system where Exim is running with the `allow_filter` option enabled.
- The attacker needs to be able to execute code as an unprivileged local user.
- The attacker needs to be able to create an "exim filter" which runs in an unprivileged process.

**Technical Details:**
- The vulnerability occurs during the processing of an "exim filter". The unprivileged process writes data to the pipe using a file descriptor that should have been closed.
- The privileged process reads the data, which includes the length of the string.
- By manipulating the length to be a negative integer, it can cause a "back-jump" primitive, and perform a controlled overwrite in Exim's heap, specifically a file path variable `file_path`.
- The overwritten file\_path is used to open log files with `open_log()`. By writing to the path for panic logs the attacker can append arbitrary content to the file system.

This vulnerability is not directly related to the typical injection vulnerabilities seen in web applications. It exploits the combination of a missing close-on-exec flag and an integer overflow, which allows controlled memory corruption leading to local privilege escalation.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-403 | Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak') | Base | Allowed | 0.7480 | dense, sparse, graph | dense: 0.678, sparse: 0.326, graph: 0.621 |
| 2 | CWE-59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | 0.3716 | sparse, graph | sparse: 0.130, graph: 0.832 |
| 3 | CWE-829 | Inclusion of Functionality from Untrusted Control Sphere | Base | Allowed | 0.3079 | dense, sparse | dense: 0.485, sparse: 0.114 |
| 4 | CWE-775 | Missing Release of File Descriptor or Handle after Effective Lifetime | Variant | Allowed | 0.3001 | dense, sparse | dense: 0.502, sparse: 0.129 |
| 5 | CWE-822 | Untrusted Pointer Dereference | Base | Allowed | 0.2919 | sparse, graph | sparse: 0.116, graph: 0.631 |
| 6 | CWE-497 | Exposure of Sensitive System Information to an Unauthorized Control Sphere | Base | Allowed | 0.2899 | sparse, graph | sparse: 0.136, graph: 0.594 |
| 7 | CWE-668 | Exposure of Resource to Wrong Sphere | Class | Discouraged | 0.1229 | sparse, graph | sparse: 0.166, graph: 0.503 |
| 8 | CWE-250 | Execution with Unnecessary Privileges | Base | Allowed | 0.0680 | sparse | sparse: 0.119 |
| 9 | CWE-524 | Use of Cache Containing Sensitive Information | Base | Allowed | 0.0660 | sparse | sparse: 0.115 |
| 10 | CWE-708 | Incorrect Ownership Assignment | Base | Allowed | 0.0656 | sparse | sparse: 0.115 |

