# Critic Input for CVE-2020-28012



# Original Analyzer Input
## Vulnerability Description
Exim 4 before 4.94.2 allows **Exposure of File Descriptor to Unintended Control Sphere** because rda_interpret uses a privileged pipe that lacks a close-on-exec flag.

### Vulnerability Description Key Phrases
- **rootcause:** **Exposure of File Descriptor to Unintended Control Sphere**
- **product:** Exim
- **version:** 4 before 4.94.2
- **component:** rda_interpret

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of CVE-2020-28012:

**Root Cause of Vulnerability:**
The Exim mail server, when configured to allow exim filters (allow\_filter is true), creates a pipe for communication between the privileged Exim process (running as root) and an unprivileged filter process. The write end of this communication pipe is not set to close-on-exec, meaning that the file descriptor for the pipe remains open in the spawned filter process. This allows the unprivileged filter process to write to the pipe.

**Weaknesses/Vulnerabilities Present:**
- **Missing close-on-exec flag:** The core vulnerability lies in the lack of the close-on-exec flag for the writable end of the communication pipe. This is a common vulnerability where file descriptors are inherited by child processes.
- **Abuse of rda\_interpret():** The privileged Exim process reads data from the pipe using `rda_interpret()`. It reads an integer representing the filter type, another integer for a size, and two strings based on the size specified. This design allows for a heap-based back-jump and forward-overflow primitive if a negative size is provided.

**Impact of Exploitation:**
- **Local Privilege Escalation (LPE):** An unprivileged local attacker can exploit this vulnerability to gain full root privileges. The attacker does this by writing crafted data through the pipe to the privileged Exim process. The crafted data will cause a controlled overwrite of a file path which leads to the ability to append content to `/etc/passwd`.

**Attack Vectors:**
- **Local Access:** The attacker must be able to execute code as an unprivileged user on the system where Exim is running, and allow_filter must be set to true.
- **Pipe Communication:** The attacker sends crafted data through the writable end of the pipe created for the exim filter process.

**Required Attacker Capabilities/Position:**
- The attacker needs to be a local user on the system where Exim is running with the `allow_filter` option enabled.
- The attacker needs to be able to execute code as an unprivileged local user.
- The attacker needs to be able to create an "exim filter" which runs in an unprivileged process.

**Technical Details:**
- The vulnerability occurs during the processing of an "exim filter". The unprivileged process writes data to the pipe using a file descriptor that should have been closed.
- The privileged process reads the data, which includes the length of the string.
- By manipulating the length to be a negative integer, it can cause a "back-jump" primitive, and perform a controlled overwrite in Exim's heap, specifically a file path variable `file_path`.
- The overwritten file\_path is used to open log files with `open_log()`. By writing to the path for panic logs the attacker can append arbitrary content to the file system.

This vulnerability is not directly related to the typical injection vulnerabilities seen in web applications. It exploits the combination of a missing close-on-exec flag and an integer overflow, which allows controlled memory corruption leading to local privilege escalation.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-403 | Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak') | Base | Allowed | 0.7480 | dense, sparse, graph | dense: 0.678, sparse: 0.326, graph: 0.621 |
| 2 | CWE-59 | Improper Link Resolution Before File Access ('Link Following') | Base | Allowed | 0.3716 | sparse, graph | sparse: 0.130, graph: 0.832 |
| 3 | CWE-829 | Inclusion of Functionality from Untrusted Control Sphere | Base | Allowed | 0.3079 | dense, sparse | dense: 0.485, sparse: 0.114 |
| 4 | CWE-775 | Missing Release of File Descriptor or Handle after Effective Lifetime | Variant | Allowed | 0.3001 | dense, sparse | dense: 0.502, sparse: 0.129 |
| 5 | CWE-822 | Untrusted Pointer Dereference | Base | Allowed | 0.2919 | sparse, graph | sparse: 0.116, graph: 0.631 |
| 6 | CWE-497 | Exposure of Sensitive System Information to an Unauthorized Control Sphere | Base | Allowed | 0.2899 | sparse, graph | sparse: 0.136, graph: 0.594 |
| 7 | CWE-668 | Exposure of Resource to Wrong Sphere | Class | Discouraged | 0.1229 | sparse, graph | sparse: 0.166, graph: 0.503 |
| 8 | CWE-250 | Execution with Unnecessary Privileges | Base | Allowed | 0.0680 | sparse | sparse: 0.119 |
| 9 | CWE-524 | Use of Cache Containing Sensitive Information | Base | Allowed | 0.0660 | sparse | sparse: 0.115 |
| 10 | CWE-708 | Incorrect Ownership Assignment | Base | Allowed | 0.0656 | sparse | sparse: 0.115 |



# Analysis to Review
# Summary
| CWE ID | CWE Name | Confidence | CWE Abstraction Level | CWE Vulnerability Mapping Label | CWE-Vulnerability Mapping Notes |
|---|---|---|---|---|---|
| CWE-403 | Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak') | 1.0 | Base | Allowed | The primary weakness is the **exposure of file descriptor to unintended control sphere**. |
| CWE-668 | Exposure of Resource to Wrong Sphere | 0.4 | Class | Discouraged | Secondary candidate: The resource (file descriptor) is exposed to the wrong control sphere, but CWE-403 is more specific. |
| CWE-250 | Execution with Unnecessary Privileges | 0.4 | Base | Allowed | Secondary candidate: The process executes at a higher privilege level than necessary, exacerbating the impact. |

## Evidence and Confidence

*   **Confidence Score:** 1.0
*   **Evidence Strength:** HIGH

- **Analysis and Justification:**  
  - *Explanation:* The vulnerability description and CVE summary explicitly state the **exposure of a file descriptor to an unintended control sphere** due to the missing close-on-exec flag. This directly aligns with the definition of CWE-403 "Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak')". The root cause lies in the failure to properly manage file descriptors, allowing an unprivileged process to access a privileged pipe. The impact is local privilege escalation, as the attacker can write crafted data to the pipe and overwrite system files. CWE-403 is a Base level CWE, which is the preferred level of abstraction. MITRE mapping guidance for CWE-403 indicates this is ALLOWED. While CWE-668 (Exposure of Resource to Wrong Sphere) is a related Class-level CWE, CWE-403 provides a more specific description of the weakness. CWE-250 (Execution with Unnecessary Privileges) is another possible weakness because the Exim process is running with root privileges. However, the core issue is the file descriptor leak, making CWE-403 the primary weakness.

  - *Relationship Analysis:* "CWE-403 has no direct relationships defined in the provided information. However, in a broader context, it can be considered related to resource management and privilege management. The vulnerability chain involves the missing close-on-exec flag (CWE-403) leading to a controlled memory corruption and local privilege escalation."

- **Confidence Score:**  
  - *Example:* Confidence: 1.0 (High confidence due to explicit mention of the **exposure of the file descriptor** and detailed technical analysis).

# CWE Examples from Database


## Known Examples for CWE-403: Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak')
### Observed Examples
- **CVE-2003-0740** [https://www.cve.org/CVERecord?id=CVE-2003-0740](https://www.cve.org/CVERecord?id=CVE-2003-0740): Server leaks a privileged file descriptor, allowing the server to be hijacked.
- **CVE-2004-1033** [https://www.cve.org/CVERecord?id=CVE-2004-1033](https://www.cve.org/CVERecord?id=CVE-2004-1033): File descriptor leak allows read of restricted files.
- **CVE-2000-0094** [https://www.cve.org/CVERecord?id=CVE-2000-0094](https://www.cve.org/CVERecord?id=CVE-2000-0094): Access to restricted resource using modified file descriptor for stderr.
- **CVE-2002-0638** [https://www.cve.org/CVERecord?id=CVE-2002-0638](https://www.cve.org/CVERecord?id=CVE-2002-0638): Open file descriptor used as alternate channel in complex race condition.
- **CVE-2003-0489** [https://www.cve.org/CVERecord?id=CVE-2003-0489](https://www.cve.org/CVERecord?id=CVE-2003-0489): Program does not fully drop privileges after creating a file descriptor, which allows access to the descriptor via a separate vulnerability.
- **CVE-2003-0937** [https://www.cve.org/CVERecord?id=CVE-2003-0937](https://www.cve.org/CVERecord?id=CVE-2003-0937): User bypasses restrictions by obtaining a file descriptor then calling setuid program, which does not close the descriptor.
- **CVE-2004-2215** [https://www.cve.org/CVERecord?id=CVE-2004-2215](https://www.cve.org/CVERecord?id=CVE-2004-2215): Terminal manager does not properly close file descriptors, allowing attackers to access terminals of other users.
- **CVE-2006-5397** [https://www.cve.org/CVERecord?id=CVE-2006-5397](https://www.cve.org/CVERecord?id=CVE-2006-5397): Module opens a file for reading twice, allowing attackers to read files.
### Top 25 Examples
- **CVE-2020-28012**: Exim 4 before 4.94.2 allows Exposure of File Descriptor to Unintended Control Sphere because rda_interpret uses a privileged pipe that lacks a close-on-exec flag.


## Known Examples for CWE-250: Execution with Unnecessary Privileges
### Observed Examples
- **CVE-2007-4217** [https://www.cve.org/CVERecord?id=CVE-2007-4217](https://www.cve.org/CVERecord?id=CVE-2007-4217): FTP client program on a certain OS runs with setuid privileges and has a buffer overflow. Most clients do not need extra privileges, so an overflow is not a vulnerability for those clients.


# Relevant CWE Specifications

## CWE-403: Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak')
**Abstraction:** Base
**Status:** Draft

### Description
A process does not close sensitive file descriptors before invoking a child process, which allows the child to perform unauthorized I/O operations using those descriptors.

### Extended Description
When a new process is forked or executed, the child process inherits any open file descriptors. When the child process has fewer privileges than the parent process, this might introduce a vulnerability if the child process can access the file descriptor but does not have the privileges to access the associated file.

### Alternative Terms
File descriptor leak: While this issue is frequently called a file descriptor leak, the "leak" term is often used in two different ways - exposure of a resource, or consumption of a resource. Use of this term could cause confusion.

### Relationships
ChildOf -> CWE-402

### Mapping Guidance
**Usage:** Allowed
**Rationale:** This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.
**Comments:** Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.
**Reasons:**
- Acceptable-Use




### Observed Examples
- **CVE-2003-0740:** Server leaks a privileged file descriptor, allowing the server to be hijacked.
- **CVE-2004-1033:** File descriptor leak allows read of restricted files.
- **CVE-2000-0094:** Access to restricted resource using modified file descriptor for stderr.



## CWE-250: Execution with Unnecessary Privileges
**Abstraction:** Base
**Status:** Draft

### Description
The product performs an operation at a privilege level that is higher than the minimum level required, which creates new weaknesses or amplifies the consequences of other weaknesses.

### Extended Description


New weaknesses can be exposed because running with extra privileges, such as root or Administrator, can disable the normal security checks being performed by the operating system or surrounding environment. Other pre-existing weaknesses can turn into security vulnerabilities if they occur while operating at raised privileges.


Privilege management functions can behave in some less-than-obvious ways, and they have different quirks on different platforms. These inconsistencies are particularly pronounced if you are transitioning from one non-root user to another. Signal handlers and spawned processes run at the privilege of the owning process, so if a process is running as root when a signal fires or a sub-process is executed, the signal handler or sub-process will operate with root privileges.


### Alternative Terms
None

### Relationships
ChildOf -> CWE-269
ChildOf -> CWE-657

### Mapping Guidance
**Usage:** Allowed
**Rationale:** This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.
**Comments:** Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.
**Reasons:**
- Acceptable-Use


### Potential Mitigations
**Mitigation 1:**
- **Phase:** Architecture and Design, Operation
- **Strategy:** Environment Hardening
- **Description:** Run your code using the lowest privileges that are required to accomplish the necessary tasks [REF-76]. If possible, create isolated accounts with limited privileges that are only used for a single task. That way, a successful attack will not immediately give the attacker access to the rest of the software or its environment. For example, database applications rarely need to run as the database administrator, especially in day-to-day operations.

**Mitigation 2:**
- **Phase:** Architecture and Design
- **Strategy:** Separation of Privilege
- **Description:** Identify the functionality that requires additional privileges, such as access to privileged operating system resources. Wrap and centralize this functionality if possible, and isolate the privileged code as much as possible from other code [REF-76]. Raise privileges as late as possible, and drop them as soon as possible to avoid CWE-271. Avoid weaknesses such as CWE-288 and CWE-420 by protecting all possible communication channels that could interact with the privileged code, such as a secondary socket that is only intended to be accessed by administrators.

**Mitigation 3:**
- **Phase:** Architecture and Design
- **Strategy:** Attack Surface Reduction
- **Description:** Identify the functionality that requires additional privileges, such as access to privileged operating system resources. Wrap and centralize this functionality if possible, and isolate the privileged code as much as possible from other code [REF-76]. Raise privileges as late as possible, and drop them as soon as possible to avoid CWE-271. Avoid weaknesses such as CWE-288 and CWE-420 by protecting all possible communication channels that could interact with the privileged code, such as a secondary socket that is only intended to be accessed by administrators.



### Additional Notes
**[Relationship]** There is a close association with CWE-653 (Insufficient Separation of Privileges). CWE-653 is about providing separate components for each privilege; CWE-250 is about ensuring that each component has the least amount of privileges possible.

**[Maintenance]** CWE-271, CWE-272, and CWE-250 are all closely related and possibly overlapping. CWE-271 is probably better suited as a category. Both CWE-272 and CWE-250 are in active use by the community. The "least privilege" phrase has multiple interpretations.

**[Maintenance]** The Taxonomy_Mappings to ISA/IEC 62443 were added in CWE 4.10, but they are still under review and might change in future CWE versions. These draft mappings were performed by members of the "Mapping CWE to 62443" subgroup of the CWE-CAPEC ICS/OT Special Interest Group (SIG), and their work is incomplete as of CWE 4.10. The mappings are included to facilitate discussion and review by the broader ICS/OT community, and they are likely to change in future CWE versions.



### Observed Examples
- **CVE-2007-4217:** FTP client program on a certain OS runs with setuid privileges and has a buffer overflow. Most clients do not need extra privileges, so an overflow is not a vulnerability for those clients.
- **CVE-2008-1877:** Program runs with privileges and calls another program with the same privileges, which allows read of arbitrary files.
- **CVE-2007-5159:** OS incorrectly installs a program with setuid privileges, allowing users to gain privileges.



## CWE-668: Exposure of Resource to Wrong Sphere
**Abstraction:** Class
**Status:** Draft

### Description
The product exposes a resource to the wrong control sphere, providing unintended actors with inappropriate access to the resource.

### Extended Description


Resources such as files and directories may be inadvertently exposed through mechanisms such as insecure permissions, or when a program accidentally operates on the wrong object. For example, a program may intend that private files can only be provided to a specific user. This effectively defines a control sphere that is intended to prevent attackers from accessing these private files. If the file permissions are insecure, then parties other than the user will be able to access those files.


A separate control sphere might effectively require that the user can only access the private files, but not any other files on the system. If the program does not ensure that the user is only requesting private files, then the user might be able to access other files on the system.


In either case, the end result is that a resource has been exposed to the wrong party.


### Alternative Terms
None

### Relationships
ChildOf -> CWE-664
ParentOf -> CWE-1189
ParentOf -> CWE-1282
ParentOf -> CWE-1327
ParentOf -> CWE-1331
ParentOf -> CWE-134
ParentOf -> CWE-200
ParentOf -> CWE-22
ParentOf -> CWE-374
ParentOf -> CWE-375
ParentOf -> CWE-377
ParentOf -> CWE-402
ParentOf -> CWE-426
ParentOf -> CWE-427
ParentOf -> CWE-428
CanFollow -> CWE-441
ParentOf -> CWE-488
ParentOf -> CWE-491
ParentOf -> CWE-492
ParentOf -> CWE-493
ParentOf -> CWE-498
ParentOf -> CWE-499
ParentOf -> CWE-522
ParentOf -> CWE-524
ParentOf -> CWE-552
ParentOf -> CWE-582
ParentOf -> CWE-583
ParentOf -> CWE-608
ParentOf -> CWE-642
ParentOf -> CWE-732
ParentOf -> CWE-767
ParentOf -> CWE-8
ParentOf -> CWE-927
CanFollow -> CWE-942

### Mapping Guidance
**Usage:** Discouraged
**Rationale:** CWE-668 is high-level and is often misused as a catch-all when lower-level CWE IDs might be applicable. It is sometimes used for low-information vulnerability reports [REF-1287]. It is a level-1 Class (i.e., a child of a Pillar). It is not useful for trend analysis.
**Comments:** Closely analyze the specific mistake that is allowing the resource to be exposed, and perform a CWE mapping for that mistake.
**Reasons:**
- Frequent Misuse
- Abstraction



### Additional Notes
**[Theoretical]** A "control sphere" is a set of resources and behaviors that are accessible to a single actor, or a group of actors. A product's security model will typically define multiple spheres, possibly implicitly. For example, a server might define one sphere for "administrators" who can create new user accounts with subdirectories under /home/server/, and a second sphere might cover the set of users who can create or delete files within their own subdirectories. A third sphere might be "users who are authenticated to the operating system on which the product is installed." Each sphere has different sets of actors and allowable behaviors.



