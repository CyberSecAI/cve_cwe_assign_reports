# Vulnerability Information: CVE-2021-3835

## Vulnerability Description
Buffer overflow in usb device class. Zephyr versions >= v2.6.0 contain **Heap-based Buffer Overflow (CWE-122)**. For more information, see https//github.com/zephyrproject-rtos/zephyr/security/advisories/GHSA-fm6v-8625-99jf

### Vulnerability Description Key Phrases
- **weakness:** **Heap-based Buffer Overflow (CWE-122)**
- **product:** Zephyr
- **version:** versions >= v2.6.0
- **component:** usb device class

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**
- A buffer overflow vulnerability exists in the Zephyr Bluetooth USB device class implementation. The vulnerability is located within the `net_buf_simple_add_mem` function when handling USB control transfer requests. Specifically, the code does not properly check if the provided data exceeds the allocated buffer size before copying it, leading to a potential buffer overflow.

**Weaknesses/Vulnerabilities:**
- **Improper bounds checking:** The `net_buf_simple_add` function increments the buffer length (`buf->len`) without verifying if the buffer has sufficient space. This occurs because the assertion `__ASSERT_NO_MSG(net_buf_simple_tailroom(buf) >= len)` is not an actual runtime check but a compile-time assertion, meaning that it does not halt the execution if the condition is not met.
- **Unsafe memory copy:** The `memcpy` in `net_buf_simple_add_mem` copies data into the buffer regardless of whether there is enough space available. This results in out-of-bounds write that overwrites memory adjacent to the buffer.
- **Lack of input sanitization:** The size of data from control transfers is not checked against the size of available buffer.

**Impact of Exploitation:**
- **Memory corruption:** An attacker can overwrite adjacent memory regions by sending control transfer requests with more data than the allocated buffer can handle.
- **Potential arbitrary code execution:** By carefully crafting the overflow data, an attacker could overwrite important data structures or even inject and execute malicious code, leading to full control of the system.
- **Denial of Service:** Overwriting memory could corrupt data structures required by system causing a crash or instability.

**Attack Vectors:**
- **USB control transfer:** An attacker can trigger the vulnerability by sending a specially crafted USB control transfer request with a size exceeding the allocated buffer size.

**Required Attacker Capabilities/Position:**
- **Adjacent network access:** The attacker needs to be in the same physical network as the target device in order to interact with it via USB
- **Knowledge of the protocol:** The attacker needs to know how to craft a USB control transfer request to target the vulnerable code.

**Additional Notes:**
- The vulnerability affects Zephyr v2.6.0.
- Patches for this vulnerability have been released in the `main` branch and in v2.7 (PRs #42093 and #42167 respectively).
- The `CONFIG_USB_REQUEST_BUFFER_SIZE` (e.g. 2048 bytes) is significantly larger than the size of the target buffer (`CONFIG_BT_BUF_CMD_TX_SIZE` + `BT_HCI_CMD_HDR_SIZE`, e.g. 68 bytes), making exploitation relatively easy.
- The CVSS score is 8.2, indicating a high severity vulnerability.
- The vulnerability is categorized as a CWE-122 (Heap-based Buffer Overflow).

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.7716 | dense, sparse, graph | dense: 0.563, sparse: 0.232, graph: 1.000 |
| 2 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.6688 | dense, sparse, graph | dense: 0.589, sparse: 0.132, graph: 0.835 |
| 3 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.6641 | dense, sparse, graph | dense: 0.612, sparse: 0.247, graph: 0.605 |
| 4 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.5566 | dense, sparse, graph | dense: 0.593, sparse: 0.150, graph: 0.616 |
| 5 | CWE-681 | Incorrect Conversion between Numeric Types | Base | Allowed | 0.4641 | sparse, graph | sparse: 0.186, graph: 1.000 |
| 6 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.4065 | dense, sparse | dense: 0.618, sparse: 0.229 |
| 7 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.3814 | dense, sparse | dense: 0.572, sparse: 0.166 |
| 8 | CWE-839 | Numeric Range Comparison Without Minimum Check | Base | Allowed | 0.3690 | sparse, graph | sparse: 0.152, graph: 0.789 |
| 9 | CWE-170 | Improper Null Termination | Base | Allowed | 0.3619 | sparse, graph | sparse: 0.139, graph: 0.789 |
| 10 | CWE-193 | Off-by-one Error | Base | Allowed | 0.3548 | dense, sparse | dense: 0.525, sparse: 0.161 |

