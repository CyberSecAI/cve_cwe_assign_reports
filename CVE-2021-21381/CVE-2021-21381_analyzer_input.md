# Vulnerability Information: CVE-2021-21381

## Vulnerability Description
Flatpak is a system for building, distributing, and running sandboxed desktop applications on Linux. In Flatpack since version 0.9.4 and before version 1.10.2 has a vulnerability in the file forwarding feature which can be used by an attacker to gain access to files that would not ordinarily be allowed by the apps permissions. By putting the special tokens `@@` and/or `@@u` in the Exec field of a Flatpak apps .desktop file, a malicious app publisher can trick flatpak into behaving as though the user had chosen to open a target file with their Flatpak app, which automatically makes that file available to the Flatpak app. This is fixed in version 1.10.2. A minimal solution is the first commit `Disallow @@ and @@U usage in desktop files`. The follow-up commits `dir Reserve the whole @@ prefix` and `dir Refuse to export .desktop files with suspicious uses of @@ tokens` are recommended, but not strictly required. As a workaround, avoid installing Flatpak apps from untrusted sources, or check the contents of the exported `.desktop` files in `exports/share/applications/*.desktop` (typically `~/.local/share/flatpak/exports/share/applications/*.desktop` and `/var/lib/flatpak/exports/share/applications/*.desktop`) to make sure that literal filenames do not follow `@@` or `@@u`.

### Vulnerability Description Key Phrases
- **rootcause:** **vulnerability in file forwarding feature**
- **impact:** gain access to unauthorized files
- **vector:** special tokens @@ and @@u
- **attacker:** malicious app publisher
- **product:** Flatpak
- **version:** 0.9.4 to 1.10.2

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability described in CVE-2021-21381:

**Root Cause of Vulnerability:**

The vulnerability stems from the way Flatpak handles the `Exec` field in `.desktop` files, specifically how it processes special tokens related to file forwarding (`%F`, `%f`, `%U`, `%u`). Flatpak uses `@@` and `@@u` to encapsulate file arguments, which are then passed to the sandboxed application. However, it did not properly validate additional arguments, allowing an attacker to insert arbitrary file paths within these special tokens.

**Weaknesses/Vulnerabilities Present:**

-   **Insufficient Input Validation:** Flatpak failed to validate additional arguments in the `Exec` field, allowing attackers to inject arbitrary file paths encapsulated within `@@` tokens.
-   **File Forwarding Bypass:** The vulnerability abuses the intended "file forwarding" feature of Flatpak, which is meant to give sandboxed applications access to files a user has explicitly opened with it, but the vulnerability makes this access available to files not intended by the user.
-   **Sandbox Escape:** By exploiting this flaw, an attacker can cause the Flatpak application to gain access to files outside of its sandbox.

**Impact of Exploitation:**

-   **Arbitrary File Access:** An attacker can craft a malicious `.desktop` file that forces a Flatpak application to read arbitrary files from the host system (as seen in the PoC with `/etc/passwd`).
-   **Privilege Escalation**: While not a direct privilege escalation to root, an attacker can use this to obtain sensitive information, bypass file access restrictions, potentially leading to further compromise of user data or the system through other vulnerabilities.
-   **Malicious Application:** This vulnerability allows malicious app publishers to create apps that read user-accessible files outside of the sandbox.

**Attack Vectors:**

-   **Malicious `.desktop` File:** The primary attack vector is via a specially crafted `.desktop` file. This file is installed when a Flatpak application is installed.
-   **Unprivileged User:** The attacker does not need elevated privileges to exploit this vulnerability. It can be exploited by any user who can install a malicious application.

**Required Attacker Capabilities/Position:**

-   **Ability to Publish Flatpak Applications:** An attacker needs to be able to publish a malicious Flatpak application that includes a crafted `.desktop` file that contains the malicious payload.
-   **User Installation:** A user must install the malicious Flatpak application.

**Mitigation:**

-   **Input Sanitization:**  The vulnerability was addressed by disallowing `@@` and `@@u` tokens in the desktop file. Additionally, the entire `@@` prefix was reserved to avoid similar issues in the future. Finally, Flatpak will refuse to export any `.desktop` files containing these tokens, which will prevent the installation of malicious applications.
-   **Upgrade:** Updating Flatpak to version 1.10.2 or later, or a backported version containing the patch will mitigate the vulnerability.

**Additional Notes:**
- The vulnerability was assigned the CVE ID CVE-2021-21381.
- It was also assigned the Github Security Advisory GHSA-xgh4-387p-hqpp.
- Fixes were made to flatpak versions 1.10.2 and also backported to 1.8.x.
- Several downstream distributions like Debian and Fedora issued security advisories and updates for this issue.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-184 | Incomplete List of Disallowed Inputs | Base | Allowed | 1.1151 | dense, sparse, graph | dense: 0.475, sparse: 1.000, graph: 0.854 |
| 2 | CWE-94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | 0.7971 | sparse, graph | sparse: 0.835, graph: 1.000 |
| 3 | CWE-79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | 0.7405 | sparse, graph | sparse: 0.801, graph: 0.789 |
| 4 | CWE-427 | Uncontrolled Search Path Element | Base | Allowed | 0.7007 | dense, sparse | dense: 0.474, sparse: 0.811 |
| 5 | CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | 0.6931 | dense, sparse | dense: 0.454, sparse: 0.814 |
| 6 | CWE-61 | UNIX Symbolic Link (Symlink) Following | Compound | Allowed | 0.5417 | dense, sparse | dense: 0.457, sparse: 0.832 |
| 7 | CWE-306 | Missing Authentication for Critical Function | Base | Allowed | 0.4694 | sparse | sparse: 0.821 |
| 8 | CWE-502 | Deserialization of Untrusted Data | Base | Allowed | 0.4680 | sparse | sparse: 0.818 |
| 9 | CWE-88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | 0.4614 | sparse | sparse: 0.807 |
| 10 | CWE-295 | Improper Certificate Validation | Base | Allowed | 0.4570 | sparse | sparse: 0.799 |

