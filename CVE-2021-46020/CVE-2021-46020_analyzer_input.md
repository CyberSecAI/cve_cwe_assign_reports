# Vulnerability Information: CVE-2021-46020

## Vulnerability Description
An **untrusted pointer dereference** in mrb_vm_exec() of mruby v3.0.0 can lead to a segmentation fault or application crash.

### Vulnerability Description Key Phrases
- **rootcause:** **untrusted pointer dereference**
- **impact:** segmentation fault or application crash
- **product:** mruby
- **version:** v3.0.0
- **component:** mrb_vm_exec()

## CVE Reference Links Content Summary
Based on the provided content, here's an analysis of CVE-2021-46020:

**Root Cause of Vulnerability:**
- An untrusted pointer dereference in the `mrb_vm_exec()` function within mruby v3.0.0. Specifically, the vulnerability occurs when accessing object properties after calling `mrb_get_args()`, especially in functions like `mrb_ary_shift_m()` or `mrb_as_float()`.  This leads to accessing invalid memory locations.

**Weaknesses/Vulnerabilities Present:**
- Untrusted pointer dereference
- Potential reentrancy issues in mruby VM when using `mrb_get_args()`
- Use-after-free vulnerability in array/string manipulation functions (like `Array#rotate`, `Array#rotate!`, `String#byteslice`, and potentially `String#rindex`)

**Impact of Exploitation:**
- Segmentation fault
- Application crash

**Attack Vectors:**
- By providing specially crafted input to mruby that triggers the vulnerable code path within `mrb_vm_exec()`, especially when handling arguments in functions such as `mrb_ary_shift_m()`.
- The provided Proof of Concept (PoC) uses a crafted Ruby script to trigger the vulnerability.

**Required Attacker Capabilities/Position:**
- Ability to execute mruby code with the vulnerable version (v3.0.0)
- Understanding of mruby internals or ability to craft inputs based on reverse engineering or fuzzing.

**Additional Details:**
- The vulnerability is related to argument handling within the mruby virtual machine.
- The issue stems from incorrect management of stack variables after calling `mrb_get_args()` which could lead to use-after-free or access of invalid memory locations.
- The fix involves adjusting the stack and recalculating the `ci` (callinfo) variable after calling `mrb_get_args()` and refactoring how `mrb_as_float` handles generic objects.
- Patches were made in PRs #5619 and #5620.
- The issue was addressed by making changes in the functions like `mrb_ary_shift_m`, ensuring object properties are accessed correctly and also making changes to stack and call information after `mrb_get_args()` is invoked and ensuring `mrb_as_float` only calls `to_f` on Rational or Complex numbers.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-822 | Untrusted Pointer Dereference | Base | Allowed | 0.7163 | dense, sparse, graph | dense: 0.524, sparse: 0.232, graph: 0.899 |
| 2 | CWE-476 | NULL Pointer Dereference | Base | Allowed | 0.6109 | dense, sparse, graph | dense: 0.442, sparse: 0.167, graph: 0.822 |
| 3 | CWE-823 | Use of Out-of-range Pointer Offset | Base | Allowed | 0.6105 | dense, sparse, graph | dense: 0.491, sparse: 0.144, graph: 0.789 |
| 4 | CWE-787 | Out-of-bounds Write | Base | Allowed | 0.4227 | sparse, graph | sparse: 0.114, graph: 1.000 |
| 5 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.4163 | sparse, graph | sparse: 0.103, graph: 1.000 |
| 6 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.3659 | sparse, graph | sparse: 0.099, graph: 0.865 |
| 7 | CWE-825 | Expired Pointer Dereference | Base | Allowed | 0.2903 | dense, sparse | dense: 0.456, sparse: 0.108 |
| 8 | CWE-909 | Missing Initialization of Resource | Class | Allowed-with-Review | 0.1628 | dense, sparse | dense: 0.437, sparse: 0.102 |
| 9 | CWE-119 | Improper Restriction of Operations within the Bounds of a Memory Buffer | Class | Discouraged | 0.1434 | sparse, graph | sparse: 0.132, graph: 0.686 |
| 10 | CWE-252 | Unchecked Return Value | Base | Allowed | 0.0692 | sparse | sparse: 0.121 |

