# Vulnerability Information: CVE-2021-40346

## Vulnerability Description
An **integer overflow** exists in HAProxy 2.0 through 2.5 in htx_add_header that can be exploited to perform an HTTP request smuggling attack, allowing an attacker to bypass all configured http-request HAProxy ACLs and possibly other ACLs.

### Vulnerability Description Key Phrases
- **rootcause:** **integer overflow**
- **impact:** ['bypass all configured http-request HAProxy ACLs', 'possibly other ACLs']
- **attacker:** attacker
- **product:** HAProxy
- **version:** 2.0 through 2.5
- **component:** htx_add_header

## CVE Reference Links Content Summary
```
{
  "CVE-2021-40346": {
    "Description": "An integer overflow exists in HAProxy 2.0 through 2.5 in the htx_add_header() can be exploited to perform an HTTP request smuggling attack, allowing an attacker to bypass all configured http-request HAProxy ACLs and possibly other ACLs.",
    "Root cause of vulnerability": "The vulnerability is caused by a missing length check on the header name in the `htx_add_header()` and `htx_add_trailer()` functions. The header name length is stored in 8 bits, and when a header name exceeds 255 characters, an integer overflow occurs. This overflow allows bits of the header name length to slip into the header value length.",
    "Weaknesses/vulnerabilities present": [
      "Integer Overflow: The lack of input validation on the header name length allows for an integer overflow in the `htx_add_header` function when calculating memory offsets.",
      "HTTP Request Smuggling: By exploiting the integer overflow, an attacker can inject a crafted `Content-Length` header, which leads to a mismatch in how HAProxy and backend servers interpret request boundaries.",
      "ACL Bypass: Due to the ability to inject a `Content-Length` header, the attacker can bypass HTTP request ACLs defined in HAProxy."
    ],
    "Impact of exploitation": "Successful exploitation of this vulnerability leads to HTTP request smuggling. This allows an attacker to:",
    "Attack vectors": [
      "Sending a crafted HTTP request with a long header name (exceeding 255 bytes) and a duplicate content-length header to the HAProxy instance"
    ],
    "Required attacker capabilities/position": [
        "The attacker must be able to send HTTP requests to the HAProxy instance."
    ],
   "Additional Details": [
        "The vulnerability exists because the header name length is not checked in `htx_add_header()` and `htx_add_trailer()`",
        "The injected headers are visible to the HTTP internals and to the config rules, so HAProxy will generally stay synchronized with the server, with the exception of Content-Length header which is deduplicated before indexing.",
        "The integer overflow occurs because the header name length is stored in 8 bits, so the max length is 255. When the length is larger, it will wrap.",
       "A crafted header like `Content-Length0aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa:` with a long name, followed by a legitimate `Content-Length` header allows for smuggling an HTTP request."
      ]
  }
}
```

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6777 | dense, sparse, graph | dense: 0.499, sparse: 0.223, graph: 0.841 |
| 2 | CWE-195 | Signed to Unsigned Conversion Error | Variant | Allowed | 0.4167 | sparse, graph | sparse: 0.174, graph: 0.984 |
| 3 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.3980 | sparse, graph | sparse: 0.176, graph: 0.832 |
| 4 | CWE-444 | Inconsistent Interpretation of HTTP Requests ('HTTP Request/Response Smuggling') | Base | Allowed | 0.3828 | dense, sparse | dense: 0.560, sparse: 0.180 |
| 5 | CWE-295 | Improper Certificate Validation | Base | Allowed | 0.3769 | sparse, graph | sparse: 0.186, graph: 0.757 |
| 6 | CWE-681 | Incorrect Conversion between Numeric Types | Base | Allowed | 0.3558 | sparse, graph | sparse: 0.166, graph: 0.730 |
| 7 | CWE-770 | Allocation of Resources Without Limits or Throttling | Base | Allowed | 0.3338 | dense, sparse | dense: 0.472, sparse: 0.170 |
| 8 | CWE-130 | Improper Handling of Length Parameter Inconsistency | Base | Allowed | 0.3304 | dense, sparse | dense: 0.471, sparse: 0.165 |
| 9 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3241 | dense, sparse | dense: 0.503, sparse: 0.174 |
| 10 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.3237 | dense, sparse | dense: 0.459, sparse: 0.165 |

