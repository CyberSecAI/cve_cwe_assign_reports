# Vulnerability Information: CVE-2020-28024

## Vulnerability Description
Exim 4 before 4.94.2 allows Buffer Underwrite that may result in unauthenticated remote attackers executing arbitrary commands, because smtp_ungetc was only intended to push back characters, but can actually push back non-character error codes such as EOF.

### Vulnerability Description Key Phrases
- **weakness:** **buffer underwrite**
- **impact:** execute arbitrary commands
- **attacker:** unauthenticated remote attackers
- **product:** Exim
- **version:** 4 before 4.94.2
- **component:** smtp_ungetc

## CVE Reference Links Content Summary
The provided content is related to CVE-2020-28024.

**Root Cause:**
The vulnerability stems from an incorrect implementation of the `smtp_ungetc()` function in Exim. This function is used to push characters back into the `smtp_inbuffer` after they have been read by `smtp_getc()`. Specifically, `smtp_ungetc()` doesn't properly handle cases where it's asked to push back characters that weren't originally read from the buffer, such as EOF or special control characters for BDAT.

**Weaknesses/Vulnerabilities:**
- **Heap Buffer Underflow:** The core vulnerability is a heap buffer underflow within the `smtp_ungetc()` function. The code decrements the `smtp_inptr` without checking if it goes below the beginning of `smtp_inbuffer`, causing an out-of-bounds write when pushing a character back to the buffer.

**Impact of Exploitation:**
- **Potential Remote Code Execution:** While the provided text doesn't explicitly confirm successful RCE, the heap underflow could potentially be used as a building block for a more complex exploit that leads to arbitrary code execution, especially given other vulnerabilities within the same code base.
- **Crash/Denial of Service:** At a minimum, exploitation of this underflow will cause a crash of the Exim process.

**Attack Vectors:**
- **Remote Attack:** The attack can be performed remotely over a network, targeting the Exim server.
- **TLS Connection Required:**  The vulnerability is triggered when a TLS-encrypted connection is used and terminated in a specific sequence. This can be achieved through TLS-on-connect or STARTTLS with X_PIPE_CONNECT enabled.
- **Specific Character Sequence:** The vulnerability is triggered by sending a bare `\r` character, followed by a TLS connection termination.

**Required Attacker Capabilities/Position:**
- **Network Access:** The attacker needs to be able to connect to the Exim server over the network.
- **TLS Support:** The attacker must be able to establish a TLS encrypted connection.
- **Specific Sequence:** The attacker must send a bare '\r' character and then terminate the TLS connection.
- **Exim Configuration:** The vulnerability requires either TLS-on-connect or STARTTLS with X_PIPE_CONNECT enabled (default since Exim 4.94).

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.7239 | dense, sparse, graph | dense: 0.592, sparse: 0.319, graph: 0.687 |
| 2 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.6317 | dense, sparse, graph | dense: 0.496, sparse: 0.112, graph: 0.892 |
| 3 | CWE-193 | Off-by-one Error | Base | Allowed | 0.3615 | sparse, graph | sparse: 0.106, graph: 0.842 |
| 4 | CWE-1007 | Insufficient Visual Distinction of Homoglyphs Presented to User | Base | Allowed | 0.3318 | sparse, graph | sparse: 0.107, graph: 0.757 |
| 5 | CWE-88 | Improper Neutralization of Argument Delimiters in a Command ('Argument Injection') | Base | Allowed | 0.3310 | sparse, graph | sparse: 0.106, graph: 0.757 |
| 6 | CWE-144 | Improper Neutralization of Line Delimiters | Variant | Allowed | 0.2820 | dense, sparse | dense: 0.495, sparse: 0.101 |
| 7 | CWE-119 | Improper Restriction of Operations within the Bounds of a Memory Buffer | Class | Discouraged | 0.1164 | sparse, graph | sparse: 0.102, graph: 0.564 |
| 8 | CWE-250 | Execution with Unnecessary Privileges | Base | Allowed | 0.0603 | sparse | sparse: 0.105 |
| 9 | CWE-502 | Deserialization of Untrusted Data | Base | Allowed | 0.0598 | sparse | sparse: 0.105 |
| 10 | CWE-204 | Observable Response Discrepancy | Base | Allowed | 0.0589 | sparse | sparse: 0.103 |

