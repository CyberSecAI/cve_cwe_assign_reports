# Vulnerability Information: CVE-2021-3127

## Vulnerability Description
NATS Server 2.x before 2.2.0 and JWT library before 2.0.1 have Incorrect Access Control because Import Token bindings are mishandled.

### Vulnerability Description Key Phrases
- **rootcause:** **mishandled Import Token bindings**
- **weakness:** **incorrect access control**
- **product:** NATS Server and JWT library
- **version:** 2.x before 2.2.0 and before 2.0.1

## CVE Reference Links Content Summary
- **Root cause of vulnerability:** The NATS JWT library incorrectly handled import token validation. Instead of rejecting tokens with mismatched bindings, it only warned about the mismatches. This allowed an attacker to reuse an import token from another account for their own account and access any subject from the exporting account, not just the subject specified in the token.
- **Weaknesses/vulnerabilities present:**
    - Incorrect import token validation: The JWT library failed to enforce correct binding of import tokens to the importing account.
    - Lack of rejection of invalid tokens: Instead of rejecting mismatched tokens, the library only issued a warning.
    - Account JWTs as semi-public information: The NATS account server system treated account JWTs as semi-public, enabling attackers to enumerate and retrieve import tokens.
- **Impact of exploitation:**
    - Unauthorized access to subjects: A malicious actor could access any subject from an exporting account by reusing an import token, which should only have provided limited access.
    - Cross-account access: Attackers can gain access to subjects across different accounts, violating intended access restrictions.
- **Attack vectors:**
    - Tampered Account JWTs: Attackers upload their own manipulated account JWT to the account server.
    - Reusing Import tokens: Attackers reuse import tokens from other accounts to access subjects in exporting accounts.
- **Required attacker capabilities/position:**
    - Ability to update the account server with malicious JWTs: Attackers must be able to upload tampered Account JWTs to the NATS account server.
    - Knowledge of valid account JWTs and Import tokens: Attackers must be able to enumerate and retrieve import tokens from other accounts.

The provided content provides more detail than the official CVE description. It includes specifics on the JWT validation issue, the impact on cross-account subject access, and the steps required for exploitation. It also includes a python script for auditing JWTs for the vulnerability.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-639 | Authorization Bypass Through User-Controlled Key | Base | Allowed | 0.5430 | dense, sparse, graph | dense: 0.472, sparse: 0.157, graph: 0.608 |
| 2 | CWE-392 | Missing Report of Error Condition | Base | Allowed | 0.4484 | sparse, graph | sparse: 0.311, graph: 0.757 |
| 3 | CWE-347 | Improper Verification of Cryptographic Signature | Base | Allowed | 0.2916 | sparse, graph | sparse: 0.151, graph: 0.574 |
| 4 | CWE-863 | Incorrect Authorization | Class | Allowed-with-Review | 0.2736 | dense, sparse, graph | dense: 0.485, sparse: 0.153, graph: 0.379 |
| 5 | CWE-287 | Improper Authentication | Class | Discouraged | 0.2116 | dense, sparse, graph | dense: 0.494, sparse: 0.156, graph: 0.381 |
| 6 | CWE-266 | Incorrect Privilege Assignment | Base | Allowed | 0.1950 | sparse, graph | sparse: 0.078, graph: 0.421 |
| 7 | CWE-352 | Cross-Site Request Forgery (CSRF) | Compound | Allowed | 0.1614 | sparse, graph | sparse: 0.079, graph: 0.460 |
| 8 | CWE-285 | Improper Authorization | Class | Discouraged | 0.1426 | dense, sparse | dense: 0.482, sparse: 0.135 |
| 9 | CWE-284 | Improper Access Control | Pillar | Discouraged | 0.1103 | dense, sparse | dense: 0.496, sparse: 0.141 |
| 10 | CWE-807 | Reliance on Untrusted Inputs in a Security Decision | Base | Allowed | 0.0792 | sparse | sparse: 0.138 |

