# Vulnerability Information: CVE-2021-45909

## Vulnerability Description
An issue was discovered in gif2apng 1.9. There is a **heap-based buffer overflow** vulnerability in the DecodeLZW function. It allows an attacker to write a large amount of arbitrary data outside the boundaries of a buffer.

### Vulnerability Description Key Phrases
- **weakness:** **heap-based buffer overflow**
- **attacker:** attacker
- **product:** gif2apng
- **version:** 1.9
- **component:** DecodeLZW function

## CVE Reference Links Content Summary
Based on the provided information, here's a breakdown of the vulnerability:

**CVE ID:** CVE-2021-45909

**Root Cause:** Heap-based buffer overflow in the `DecodeLZW` function within the `gif2apng` tool.

**Weaknesses/Vulnerabilities:**
*   The `DecodeLZW` function writes data to a buffer allocated with `malloc`, but it doesn't validate the size of the data written against the allocated buffer's size.
*  The size of the allocated buffer is initially calculated based on an image size value (`imagesize * 2`), however, this `imagesize` variable is later overwritten, so the `DecodeLZW` function doesn't have access to the actual allocated buffer size.

**Impact of Exploitation:**
*   An attacker can cause a heap-based buffer overflow, leading to memory corruption.
*   The overflow allows writing an arbitrary number of arbitrary bytes to the heap, potentially leading to arbitrary code execution.
*   The provided PoC demonstrates this by corrupting the heap, resulting in the program aborting with `malloc(): corrupted top size`.

**Attack Vectors:**
*   The attack vector is a maliciously crafted GIF image file.
*   By providing a GIF with specific data, an attacker can trigger the overflow in the `DecodeLZW` function.
*   The `gif2apng` tool processes the crafted GIF file which triggers the vulnerability.

**Required Attacker Capabilities/Position:**
*   The attacker needs to be able to provide the crafted GIF file to be processed by the `gif2apng` tool.
*   No special privileges are needed to exploit this vulnerability.

**Technical Details:**
*   The vulnerability is in the `gif2apng.cpp` file, specifically in the `DecodeLZW` function.
*   The provided proof-of-concept (PoC) Python script demonstrates how to create a malicious GIF file to trigger the overflow, writing 10000 "A"s into a buffer of size 512, leading to memory corruption.
*   The fix involves passing the allocated buffer size to the `DecodeLZW` function and adding checks to ensure the writes don't overflow the buffer.
*   The initial size is calculated with `buffer_size = imagesize * 2;`, and `imagesize` is overwritten at some point leading to the bug.

**Additional Notes:**
* The severity of this vulnerability was initially labeled as "important" and later upgraded to "grave."
*  The issue has been fixed in versions 1.9+srconly-2+deb10u1 and 1.9+srconly-3+deb11u1.
* Multiple CVEs (CVE-2021-45909, CVE-2021-45910 and CVE-2021-45911) were addressed in the same fix.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-1284 | Improper Validation of Specified Quantity in Input | Base | Allowed | 0.7567 | dense, sparse, graph | dense: 0.537, sparse: 0.228, graph: 1.000 |
| 2 | CWE-190 | Integer Overflow or Wraparound | Base | Allowed | 0.7502 | dense, sparse, graph | dense: 0.577, sparse: 0.243, graph: 0.902 |
| 3 | CWE-193 | Off-by-one Error | Base | Allowed | 0.7378 | dense, sparse, graph | dense: 0.544, sparse: 0.241, graph: 0.917 |
| 4 | CWE-131 | Incorrect Calculation of Buffer Size | Base | Allowed | 0.6707 | dense, sparse, graph | dense: 0.545, sparse: 0.230, graph: 0.745 |
| 5 | CWE-126 | Buffer Over-read | Variant | Allowed | 0.5735 | dense, sparse, graph | dense: 0.584, sparse: 0.222, graph: 0.565 |
| 6 | CWE-122 | Heap-based Buffer Overflow | Variant | Allowed | 0.4227 | dense, sparse | dense: 0.619, sparse: 0.259 |
| 7 | CWE-125 | Out-of-bounds Read | Base | Allowed | 0.4097 | dense, sparse | dense: 0.564, sparse: 0.223 |
| 8 | CWE-191 | Integer Underflow (Wrap or Wraparound) | Base | Allowed | 0.3838 | dense, sparse | dense: 0.527, sparse: 0.210 |
| 9 | CWE-121 | Stack-based Buffer Overflow | Variant | Allowed | 0.3799 | dense, sparse | dense: 0.569, sparse: 0.221 |
| 10 | CWE-124 | Buffer Underwrite ('Buffer Underflow') | Base | Allowed | 0.3754 | dense, sparse | dense: 0.517, sparse: 0.203 |

