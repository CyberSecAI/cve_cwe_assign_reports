# Vulnerability Information: CVE-2021-27230

## Vulnerability Description
ExpressionEngine before 5.4.2 and 6.x before 6.0.3 allows PHP Code Injection by certain authenticated users who can leverage Translatesave() to write to an _lang.php file under the system/user/language directory.

### Vulnerability Description Key Phrases
- **weakness:** **PHP code injection**
- **attacker:** certain authenticated users
- **product:** ExpressionEngine
- **version:** before 5.4.2 and 6.x before 6.0.3

## CVE Reference Links Content Summary
Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

The vulnerability lies in the `ExpressionEngine\Controller\Utilities\Translate::save()` method. User-supplied input from POST parameters is used as keys when constructing a string that will be written to a PHP file. The input is not properly sanitized, allowing an attacker to inject arbitrary PHP code.

**Weaknesses/Vulnerabilities:**

*   **PHP Code Injection:** The core issue is the lack of proper sanitization of user input before it's used to build a string intended for file writing. Specifically, the keys of the `$_POST` array are not being sanitized before being incorporated into the `$str` variable on line 380. This allows for arbitrary PHP code to be injected.
*   **Insufficient Input Sanitization:** While the code attempts to remove `<script>` and `<iframe>` tags, and escapes backslashes and single quotes in the values, this sanitization is insufficient to prevent PHP code injection through the POST keys.

**Impact of Exploitation:**

*   **Arbitrary Code Execution:** Successful exploitation allows an attacker to inject and execute arbitrary PHP code on the server.
*   **Full System Compromise:** The ability to execute arbitrary PHP code could lead to full system compromise, including data theft, malware installation, and denial of service.

**Attack Vectors:**

*   **HTTP POST Request:** The attack vector involves sending a crafted HTTP POST request to the `Translate::save()` method, with malicious PHP code embedded in the keys of the POST parameters.
*   **File Write:** The vulnerable code uses the `write_file()` function to write the constructed string, including the attacker's injected PHP code, into a `.php` file within the web server's file system.

**Required Attacker Capabilities/Position:**

*   **Authenticated User:** The attacker needs an account with permissions to access the ExpressionEngine Control Panel translation system utilities.
*   **Web Access:** The attacker requires the ability to make HTTP requests to the web application.
*   **Knowledge of the Vulnerability:**  The attacker needs knowledge of the vulnerable endpoint and how to craft the malicious POST request.

**Additional Notes:**

*   The vulnerability is present in ExpressionEngine versions 6.0.2 and earlier, and 5.4.1 and earlier.
*   The fix involves upgrading to versions 6.0.3 or 5.4.2 or later, where proper sanitization has been implemented.
* The specific file that gets created and written to is within the `/system/user/language/[lang]/[file]_lang.php` path.
* The attacker is able to specify the `[lang]` directory and the `[file]` name using other input parameters.

## Retriever Results

### Top Combined Results

| Rank | CWE ID | Name | Abstraction | Usage | Combined Score | Retrievers | Individual Scores |
|------|--------|------|-------------|-------|---------------|------------|-------------------|
| 1 | CWE-96 | Improper Neutralization of Directives in Statically Saved Code ('Static Code Injection') | Base | Allowed | 0.6212 | dense, sparse, graph | dense: 0.570, sparse: 0.203, graph: 0.616 |
| 2 | CWE-434 | Unrestricted Upload of File with Dangerous Type | Base | Allowed | 0.5686 | dense, sparse, graph | dense: 0.476, sparse: 0.158, graph: 0.671 |
| 3 | CWE-1336 | Improper Neutralization of Special Elements Used in a Template Engine | Base | Allowed | 0.5471 | dense, sparse, graph | dense: 0.497, sparse: 0.143, graph: 0.605 |
| 4 | CWE-79 | Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') | Base | Allowed | 0.5394 | dense, sparse, graph | dense: 0.486, sparse: 0.141, graph: 0.603 |
| 5 | CWE-94 | Improper Control of Generation of Code ('Code Injection') | Base | Allowed-with-Review | 0.4248 | sparse, graph | sparse: 0.153, graph: 1.000 |
| 6 | CWE-23 | Relative Path Traversal | Base | Allowed | 0.3840 | sparse, graph | sparse: 0.151, graph: 0.832 |
| 7 | CWE-22 | Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') | Base | Allowed | 0.3752 | sparse, graph | sparse: 0.148, graph: 0.813 |
| 8 | CWE-184 | Incomplete List of Disallowed Inputs | Base | Allowed | 0.3582 | sparse, graph | sparse: 0.133, graph: 0.789 |
| 9 | CWE-95 | Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection') | Variant | Allowed | 0.3135 | dense, sparse | dense: 0.511, sparse: 0.147 |
| 10 | CWE-78 | Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection') | Base | Allowed | 0.3082 | sparse, graph | sparse: 0.144, graph: 0.631 |

